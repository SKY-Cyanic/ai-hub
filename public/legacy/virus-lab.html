
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¦  ë°”ì´ëŸ¬ìŠ¤ ë© - Virus Lab: AI & Science</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700;900&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        * { box-sizing: border-box; }
        body {
            margin: 0;
            overflow: hidden;
            background: #0a0a0a;
            font-family: 'Noto Sans KR', 'Orbitron', sans-serif;
        }
        #gameCanvas { display: block; }
        .game-font { font-family: 'Orbitron', 'Noto Sans KR', sans-serif; }
        .korean-font { font-family: 'Noto Sans KR', sans-serif; }
        .ui-panel {
            background: linear-gradient(135deg, rgba(10, 10, 30, 0.95), rgba(30, 10, 50, 0.9));
            backdrop-filter: blur(15px);
            border: 2px solid rgba(138, 43, 226, 0.4);
            box-shadow: 0 0 40px rgba(138, 43, 226, 0.3), inset 0 0 20px rgba(138, 43, 226, 0.1);
        }
        .science-panel {
            background: linear-gradient(135deg, rgba(0, 50, 80, 0.95), rgba(0, 30, 60, 0.9));
            border: 2px solid rgba(0, 200, 255, 0.4);
            box-shadow: 0 0 40px rgba(0, 200, 255, 0.3);
        }
        .challenge-panel {
            background: linear-gradient(135deg, rgba(80, 0, 0, 0.95), rgba(50, 0, 0, 0.9));
            border: 2px solid rgba(255, 50, 50, 0.6);
            box-shadow: 0 0 40px rgba(255, 0, 0, 0.5);
        }
        .glow-text { text-shadow: 0 0 10px rgba(138, 43, 226, 0.8), 0 0 20px rgba(138, 43, 226, 0.5); }
        .glow-red { text-shadow: 0 0 10px rgba(255, 0, 0, 0.8), 0 0 20px rgba(255, 0, 0, 0.5); }
        .xp-bar {
            background: linear-gradient(90deg, #8b5cf6, #d946ef, #8b5cf6);
            background-size: 200% 100%;
            animation: shimmer 2s infinite linear;
        }
        .hp-bar {
            background: linear-gradient(90deg, #ef4444, #f97316, #ef4444);
            background-size: 200% 100%;
            animation: shimmer 2s infinite linear;
        }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        @keyframes danger-pulse { 0%, 100% { opacity: 0.3; } 50% { opacity: 0.8; } }
        .pulse-anim { animation: pulse 1.5s infinite; }
        .float-anim { animation: float 2s infinite ease-in-out; }
        .danger-flash { animation: danger-pulse 0.5s infinite; }
        .skill-btn {
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }
        .skill-btn:hover:not(:disabled) {
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(138, 43, 226, 0.6);
        }
        .skill-cooldown {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background: rgba(0, 0, 0, 0.7);
        }
        .quiz-option {
            transition: all 0.3s;
            cursor: pointer;
        }
        .quiz-option:hover {
            transform: translateX(10px);
            background: rgba(0, 200, 255, 0.3);
        }
        .warning-border {
            border: 3px solid red;
            animation: danger-pulse 0.3s infinite;
        }
        .mission-panel {
            background: linear-gradient(135deg, rgba(255, 165, 0, 0.9), rgba(200, 100, 0, 0.8));
            border: 2px solid rgba(255, 215, 0, 0.6);
            box-shadow: 0 0 20px rgba(255, 165, 0, 0.4);
        }
        .strain-active {
            border: 2px solid #ffffff;
            transform: scale(1.1);
            box-shadow: 0 0 15px currentColor;
        }
    </style>
</head>
<body class="bg-black">
    <canvas id="gameCanvas"></canvas>
    
    <!-- ë„ì „ ëª¨ë“œ ê²½ê³  ì˜¤ë²„ë ˆì´ -->
    <div id="challengeOverlay" class="fixed inset-0 pointer-events-none z-10 hidden">
        <div class="absolute inset-0 bg-red-900/20 danger-flash"></div>
    </div>
    
    <!-- ê³¼í•™ íŒ íŒì—… -->
    <div id="scienceTip" class="fixed bottom-24 left-1/2 -translate-x-1/2 pointer-events-none opacity-0 transition-opacity duration-500 z-30">
        <div class="science-panel rounded-xl px-6 py-4 max-w-lg">
            <div class="flex items-center gap-3">
                <div class="text-3xl" id="tipIcon">ğŸ”¬</div>
                <div>
                    <div class="text-cyan-400 font-bold text-sm korean-font">ê³¼í•™ ìƒì‹</div>
                    <div class="text-white korean-font" id="tipText">íŒ ë‚´ìš©</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- AI ë¶„ì„ íŒ¨ë„ -->
    <div id="aiAnalysis" class="fixed top-20 right-4 pointer-events-none opacity-0 transition-opacity z-30">
        <div class="science-panel rounded-xl px-4 py-3 w-64">
            <div class="flex items-center gap-2 mb-2">
                <div class="text-xl">ğŸ¤–</div>
                <div class="text-pink-400 font-bold text-sm korean-font">AI ë¶„ì„</div>
            </div>
            <div class="text-white text-sm korean-font" id="aiText">ë¶„ì„ ì¤‘...</div>
        </div>
    </div>

    <!-- ëŒë°œ ë¯¸ì…˜ íŒ¨ë„ -->
    <div id="missionDisplay" class="fixed top-44 right-4 z-20 transition-all duration-500 transform translate-x-full">
        <div class="mission-panel rounded-xl px-5 py-4 w-64">
            <div class="flex items-center justify-between mb-2">
                <div class="flex items-center gap-2">
                    <span class="text-xl animate-bounce">ğŸ¯</span>
                    <span class="text-white font-bold text-sm korean-font">ê¸´ê¸‰ ë¯¸ì…˜</span>
                </div>
                <span id="missionTimer" class="text-red-900 font-bold bg-white/30 px-2 rounded text-xs">30s</span>
            </div>
            <div id="missionText" class="text-white text-sm font-bold mb-2 korean-font shadow-black drop-shadow-md">ì„¸í¬ 10ë§ˆë¦¬ ê°ì—¼</div>
            <div class="w-full bg-black/30 rounded-full h-2">
                <div id="missionProgress" class="bg-white h-full rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>
        </div>
    </div>

    <!-- ì—°êµ¬ í¬ì¸íŠ¸ -->
    <div id="researchDisplay" class="fixed top-4 left-1/2 -translate-x-1/2 z-20">
        <div class="science-panel rounded-full px-6 py-2 flex items-center gap-4">
            <div class="flex items-center gap-2">
                <span class="text-2xl">ğŸ”¬</span>
                <span class="text-cyan-400 font-bold game-font" id="researchPoints">0</span>
                <span class="text-gray-400 text-sm korean-font">ì—°êµ¬</span>
            </div>
            <div class="w-px h-6 bg-cyan-800"></div>
            <div class="flex items-center gap-2">
                <span class="text-2xl">ğŸ§¬</span>
                <span class="text-green-400 font-bold game-font" id="dnaCollected">0</span>
                <span class="text-gray-400 text-sm korean-font">DNA</span>
            </div>
            <div class="w-px h-6 bg-cyan-800"></div>
            <div id="difficultyBadge" class="px-3 py-1 rounded-full text-xs font-bold korean-font bg-green-600">í•™ìŠµ</div>
        </div>
    </div>

    <!-- ë³´ìŠ¤ HP ë°” -->
    <div id="bossHpContainer" class="fixed top-24 left-1/2 -translate-x-1/2 w-1/2 max-w-2xl hidden z-20">
        <div class="flex justify-between text-red-400 font-black mb-1 game-font text-lg shadow-black drop-shadow-md">
            <span id="bossName">BOSS</span>
            <span id="bossHpText">100%</span>
        </div>
        <div class="w-full h-6 bg-black/70 border-2 border-red-600 rounded-full overflow-hidden">
            <div id="bossHpBar" class="h-full bg-gradient-to-r from-red-600 via-orange-500 to-red-600 transition-all duration-200" style="width: 100%"></div>
        </div>
    </div>

    <!-- ìŠ¤í…Œì´ì§€ ì•Œë¦¼ -->
    <div id="stageDisplay" class="fixed top-4 left-4 z-20">
        <div class="science-panel rounded-xl px-4 py-2">
            <div class="text-xs text-cyan-400 korean-font">í˜„ì¬ ìœ„ì¹˜</div>
            <div class="text-xl font-bold text-white korean-font" id="stageName">í˜ˆê´€</div>
            <div class="text-xs text-gray-400 korean-font" id="stageDesc">ê°•í•œ í˜ˆë¥˜</div>
        </div>
    </div>

    <!-- UI ì˜¤ë²„ë ˆì´ -->
    <div id="ui" class="fixed top-12 left-0 w-full p-4 pointer-events-none">
        <div class="flex justify-between items-start max-w-7xl mx-auto">
            <!-- ì™¼ìª½ ìƒíƒœ íŒ¨ë„ -->
            <div class="ui-panel rounded-2xl p-5 pointer-events-auto" id="leftPanel">
                <button id="soundBtn" class="absolute -top-12 left-0 bg-gray-800/80 p-2 rounded-lg text-xl border border-gray-600 hover:bg-gray-700 transition">ğŸ”Š</button>
                <div class="flex items-center gap-4 mb-4">
                    <div class="text-5xl pulse-anim float-anim" id="playerIcon">ğŸ¦ </div>
                    <div>
                        <h2 class="text-white font-black text-xl glow-text game-font">LV.<span id="level" class="text-purple-400">1</span></h2>
                        <p class="text-gray-400 text-sm korean-font">í¬ê¸°: <span id="size" class="text-green-400 font-bold">10</span>nm</p>
                        <p class="text-gray-400 text-sm korean-font">ì›¨ì´ë¸Œ: <span id="currentWave" class="text-red-400 font-bold">1</span></p>
                        <p class="text-gray-400 text-sm korean-font" id="sizeDebuff"></p>
                    </div>
                </div>

                <!-- í˜•ì§ˆ ë³€ì´ ì‹œìŠ¤í…œ -->
                <div class="mb-3 bg-black/30 p-2 rounded-lg">
                    <div class="text-xs text-gray-400 mb-1 flex justify-between">
                        <span>í˜„ì¬ í˜•ì§ˆ (í‚¤: 1, 2, 3)</span>
                        <span id="currentStrainName" class="text-cyan-400 font-bold">ê¸°ë³¸í˜•</span>
                    </div>
                    <div class="flex gap-2">
                        <div id="strain1" class="flex-1 bg-blue-900/50 p-1 rounded text-center cursor-pointer hover:bg-blue-800 transition text-blue-300 text-xs" title="ì‹ ì†í˜•: ì†ë„++ ë°©ì–´--">
                            <div class="text-lg">âš¡</div>
                            <div>ì‹ ì†</div>
                        </div>
                        <div id="strain2" class="flex-1 bg-green-900/50 p-1 rounded text-center cursor-pointer hover:bg-green-800 transition text-green-300 text-xs" title="ê°‘ì˜·í˜•: ë°©ì–´++ ì†ë„--">
                            <div class="text-lg">ğŸ›¡ï¸</div>
                            <div>ê°‘ì˜·</div>
                        </div>
                        <div id="strain3" class="flex-1 bg-red-900/50 p-1 rounded text-center cursor-pointer hover:bg-red-800 transition text-red-300 text-xs" title="ê°ì—¼í˜•: ê°ì—¼++ í”¼í•´++">
                            <div class="text-lg">â˜ ï¸</div>
                            <div>ê°ì—¼</div>
                        </div>
                    </div>
                </div>
                
                <!-- HP ë°” -->
                <div class="mb-2">
                    <div class="flex justify-between text-xs text-gray-400 mb-1 korean-font">
                        <span>ì²´ë ¥</span>
                        <span><span id="hp">100</span>/<span id="hpMax">100</span></span>
                    </div>
                    <div class="w-56 h-3 bg-gray-900 rounded-full overflow-hidden border border-red-900">
                        <div id="hpBar" class="hp-bar h-full rounded-full transition-all duration-300" style="width: 100%"></div>
                    </div>
                </div>
                
                <!-- XP ë°” -->
                <div class="mb-3">
                    <div class="flex justify-between text-xs text-gray-400 mb-1 korean-font">
                        <span>ì§„í™” ê²Œì´ì§€</span>
                        <span><span id="xp">0</span>/<span id="xpMax">100</span></span>
                    </div>
                    <div class="w-56 h-4 bg-gray-900 rounded-full overflow-hidden border border-purple-900">
                        <div id="xpBar" class="xp-bar h-full rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>
                
                <!-- ìŠ¤íƒ¯ -->
                <div class="grid grid-cols-3 gap-2 text-xs mb-3">
                    <div class="bg-black/40 rounded-lg p-2">
                        <span class="text-gray-500 korean-font">ì†ë„</span>
                        <div class="text-cyan-400 font-bold" id="statSpeed">100%</div>
                    </div>
                    <div class="bg-black/40 rounded-lg p-2">
                        <span class="text-gray-500 korean-font">ê°ì—¼ë ¥</span>
                        <div class="text-pink-400 font-bold" id="statAbsorb">100%</div>
                    </div>
                    <div class="bg-black/40 rounded-lg p-2">
                        <span class="text-gray-500 korean-font">ë°©ì–´</span>
                        <div class="text-yellow-400 font-bold" id="statDefense">0%</div>
                    </div>
                </div>
                
                <!-- ê°ì—¼ ìˆ˜ -->
                <div class="text-center pt-3 border-t border-purple-900/50">
                    <span class="text-gray-400 text-sm korean-font">ê°ì—¼ ì„¸í¬</span>
                    <p class="text-3xl font-black text-red-400 glow-text game-font" id="infected">0</p>
                </div>
            </div>
            
            <!-- ì¤‘ì•™ ìŠ¤í‚¬ íŒ¨ë„ -->
            <div class="ui-panel rounded-2xl p-4 pointer-events-auto mt-4">
                <div class="text-center text-gray-400 text-xs mb-2 korean-font">ë°”ì´ëŸ¬ìŠ¤ ëŠ¥ë ¥</div>
                <div class="flex gap-3">
                    <div class="skill-btn w-14 h-14 bg-gradient-to-br from-green-600 to-green-900 rounded-xl flex items-center justify-center text-2xl cursor-pointer border-2 border-green-400" id="skillQ" title="ë…ì†Œ ë¶„ë¹„ (Q)">
                        â˜ ï¸
                        <div class="skill-cooldown" id="cooldownQ" style="height: 0%"></div>
                    </div>
                    <div class="skill-btn w-14 h-14 bg-gradient-to-br from-blue-600 to-blue-900 rounded-xl flex items-center justify-center text-2xl cursor-pointer border-2 border-blue-400" id="skillE" title="ìˆ˜ìš©ì²´ ê²°í•© (E) - ë„ˆí”„ë¨">
                        ğŸ§²
                        <div class="skill-cooldown" id="cooldownE" style="height: 0%"></div>
                    </div>
                    <div class="skill-btn w-14 h-14 bg-gradient-to-br from-red-600 to-red-900 rounded-xl flex items-center justify-center text-2xl cursor-pointer border-2 border-red-400" id="skillR" title="ë³µì œ ë°©ì¶œ (R) - ìˆ™ì£¼ íŒŒì—´">
                        ğŸ’¥
                        <div class="skill-cooldown" id="cooldownR" style="height: 0%"></div>
                    </div>
                    <div class="skill-btn w-14 h-14 bg-gradient-to-br from-purple-600 to-purple-900 rounded-xl flex items-center justify-center text-2xl cursor-pointer border-2 border-purple-400" id="skillF" title="ìº¡ì‹œë“œ ê°•í™” (F)">
                        ğŸ›¡ï¸
                        <div class="skill-cooldown" id="cooldownF" style="height: 0%"></div>
                    </div>
                </div>
                <div class="flex gap-3 mt-1 text-center">
                    <div class="w-14 text-xs text-gray-500">Q</div>
                    <div class="w-14 text-xs text-gray-500">E</div>
                    <div class="w-14 text-xs text-gray-500">R</div>
                    <div class="w-14 text-xs text-gray-500">F</div>
                </div>
            </div>
            
            <!-- ì˜¤ë¥¸ìª½ ì •ë³´ íŒ¨ë„ -->
            <div class="ui-panel rounded-2xl p-5 text-right pointer-events-auto">
                <div class="text-gray-400 text-sm mb-1 korean-font">ìƒì¡´ ì‹œê°„</div>
                <div class="text-3xl font-black text-white glow-text game-font" id="time">00:00</div>
                
                <div class="mt-4 pt-3 border-t border-purple-900/50">
                    <div class="text-gray-400 text-sm mb-1 korean-font">ìµœëŒ€ ì½¤ë³´</div>
                    <div class="text-2xl font-bold text-yellow-400 game-font" id="maxCombo">0</div>
                </div>
                
                <div class="mt-3 pt-3 border-t border-purple-900/50">
                    <div class="text-gray-400 text-sm mb-1 korean-font">ì  ì²˜ì¹˜</div>
                    <div class="text-xl font-bold text-red-400 game-font" id="enemiesKilled">0</div>
                </div>
                
                <div class="mt-3 pt-3 border-t border-purple-900/50">
                    <div class="text-gray-400 text-sm mb-2 korean-font">í™œì„± íš¨ê³¼</div>
                    <div id="activeEffects" class="flex gap-1 justify-end flex-wrap"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- í•˜ë‹¨ ì¡°ì‘ ì•ˆë‚´ -->
    <div class="fixed bottom-4 left-1/2 -translate-x-1/2 ui-panel rounded-xl px-6 py-3 z-20">
        <div class="flex gap-6 text-sm korean-font">
            <div class="text-gray-300"><span class="text-purple-400 font-bold">WASD</span> ì´ë™</div>
            <div class="text-gray-300"><span class="text-purple-400 font-bold">SPACE</span> ëŒ€ì‹œ</div>
            <div class="text-gray-300"><span class="text-purple-400 font-bold">1/2/3</span> í˜•ì§ˆë³€ê²½</div>
            <div class="text-gray-300"><span class="text-yellow-400 font-bold">H</span> AIì‹œê°í™”</div>
            <div class="text-gray-300"><span class="text-pink-400 font-bold">V</span> ì ë³µ(íšŒë³µ)</div>
            <div class="text-gray-300"><span class="text-cyan-400 font-bold">TAB</span> ë„ê°</div>
            <div class="text-gray-300"><span class="text-green-400 font-bold">B</span> ì—°êµ¬ì†Œ</div>
            <div class="text-gray-300"><span class="text-emerald-300 font-bold">G</span> í¬íƒˆ ì§„ì…</div>
        </div>
    </div>
    
    <!-- ì‹œì‘ í™”ë©´ -->
    <div id="startScreen" class="fixed inset-0 flex items-center justify-center bg-black/90 backdrop-blur-md z-50">
        <div class="ui-panel rounded-3xl p-12 text-center max-w-3xl">
            <div class="text-8xl mb-6 pulse-anim float-anim">ğŸ¦ </div>
            <h1 class="text-5xl font-black text-white mb-3 glow-text game-font">ë°”ì´ëŸ¬ìŠ¤ ë©</h1>
            <p class="text-cyan-300 mb-4 text-xl game-font">VIRUS LAB: AI & SCIENCE</p>
            <p class="text-gray-400 mb-6 korean-font">ë°”ì´ëŸ¬ìŠ¤í•™ê³¼ AIë¥¼ ë°°ìš°ë©° ì„±ì¥í•˜ëŠ” êµìœ¡ìš© ê²Œì„</p>
            
            <div class="text-left bg-black/40 rounded-xl p-4 mb-6 text-sm korean-font">
                <div class="text-cyan-400 font-bold mb-2">ğŸ”¬ ê³¼í•™ í•™ìŠµ ìš”ì†Œ</div>
                <div class="grid grid-cols-2 gap-2 text-gray-300 mb-4">
                    <div>ğŸ¦  ë°”ì´ëŸ¬ìŠ¤ êµ¬ì¡°ì™€ ë³µì œ</div>
                    <div>ğŸ§¬ DNA/RNA ìœ ì „ì •ë³´</div>
                    <div>ğŸ›¡ï¸ ë©´ì—­ ì‹œìŠ¤í…œ ì›ë¦¬</div>
                    <div>ğŸ”„ ë³€ì´ì™€ ì§„í™”</div>
                </div>
                <div class="text-pink-400 font-bold mb-2">ğŸ¤– AI í•™ìŠµ ìš”ì†Œ</div>
                <div class="grid grid-cols-2 gap-2 text-gray-300">
                    <div>ğŸ¯ ê²½ë¡œ íƒìƒ‰ ì•Œê³ ë¦¬ì¦˜</div>
                    <div>ğŸ§  ì‹ ê²½ë§ ê¸°ì´ˆ</div>
                    <div>ğŸ“Š íŒ¨í„´ ì¸ì‹</div>
                    <div>ğŸ”® ì˜ˆì¸¡ ëª¨ë¸</div>
                </div>
            </div>
            
            <div class="flex gap-4 justify-center mb-6">
                <button class="mode-btn bg-gradient-to-r from-green-600 to-green-800 px-6 py-3 rounded-lg text-white font-bold border-2 border-green-400 korean-font hover:scale-105 transition" data-mode="learn">
                    ğŸ“š í•™ìŠµ ëª¨ë“œ
                    <div class="text-xs text-green-200 mt-1">ì‰¬ì›€ â€¢ í€´ì¦ˆ ì¤‘ì‹¬</div>
                </button>
                <button class="mode-btn bg-gradient-to-r from-blue-600 to-blue-800 px-6 py-3 rounded-lg text-white font-bold border-2 border-blue-400 korean-font hover:scale-105 transition" data-mode="normal">
                    ğŸ® ì¼ë°˜ ëª¨ë“œ
                    <div class="text-xs text-blue-200 mt-1">ë³´í†µ â€¢ ë°¸ëŸ°ìŠ¤</div>
                </button>
                <button class="mode-btn bg-gradient-to-r from-red-600 to-red-900 px-6 py-3 rounded-lg text-white font-bold border-2 border-red-400 korean-font hover:scale-105 transition animate-pulse" data-mode="challenge">
                    ğŸ’€ ë„ì „ ëª¨ë“œ
                    <div class="text-xs text-red-200 mt-1">ê·¹í•œ â€¢ ìƒì¡´ë¶ˆê°€</div>
                </button>
            </div>
            
            <div id="challengeWarning" class="hidden bg-red-900/50 border-2 border-red-500 rounded-xl p-4 mb-6 text-left">
                <div class="text-red-400 font-bold mb-2 korean-font">âš ï¸ ë„ì „ ëª¨ë“œ ê²½ê³ </div>
                <div class="text-red-200 text-sm korean-font grid grid-cols-2 gap-2">
                    <div>ğŸ’€ í¬ê¸° ì¦ê°€ = ì†ë„ ê°ì†Œ</div>
                    <div>ğŸ‘¾ ì ì´ 3ë°° ë” ë§ì´ ìƒì„±</div>
                    <div>âš¡ ì›¨ì´ë¸Œ 2ë°° ë¹ ë¦„</div>
                    <div>ğŸš€ ì  ì†ë„ 50% ì¦ê°€</div>
                    <div>ğŸ’¥ í”¼í•´ëŸ‰ 2ë°°</div>
                    <div>ğŸ§² ìì„ ìŠ¤í‚¬ ëŒ€í­ ë„ˆí”„</div>
                    <div>âŒ í€´ì¦ˆ ì˜¤ë‹µ ì‹œ í”¼í•´</div>
                    <div>ğŸ¯ ìœ ë„ ë¯¸ì‚¬ì¼ ë“±ì¥</div>
                    <div>â˜ ï¸ ë…ì„± ì§€ì—­ ë” ë§ìŒ</div>
                    <div>ğŸ”„ ì²´ë ¥ íšŒë³µ 50% ê°ì†Œ</div>
                </div>
            </div>
            
            <button id="startBtn" class="bg-gradient-to-r from-purple-600 via-pink-600 to-purple-600 hover:from-purple-500 hover:via-pink-500 hover:to-purple-500 text-white font-black py-5 px-16 rounded-full text-xl transition-all transform hover:scale-110 shadow-2xl shadow-purple-500/50 korean-font">
                ğŸ”¬ ì—°êµ¬ ì‹œì‘
            </button>
        </div>
    </div>
    
    <!-- í€´ì¦ˆ í™”ë©´ -->
    <div id="quizScreen" class="fixed inset-0 flex items-center justify-center bg-black/80 backdrop-blur-md z-50 hidden">
        <div class="science-panel rounded-3xl p-8 text-center max-w-xl" id="quizPanel">
            <div class="flex items-center justify-center gap-3 mb-6">
                <div class="text-4xl" id="quizIcon">ğŸ”¬</div>
                <div class="text-2xl font-black text-cyan-400 korean-font" id="quizCategory">ê³¼í•™ í€´ì¦ˆ</div>
            </div>
            <div id="quizTimer" class="text-red-400 font-bold mb-4 hidden korean-font">ë‚¨ì€ ì‹œê°„: <span id="quizTimeLeft">10</span>ì´ˆ</div>
            <div class="text-xl text-white mb-8 korean-font leading-relaxed" id="quizQuestion">ì§ˆë¬¸ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</div>
            <div class="space-y-3" id="quizOptions"></div>
            <div class="mt-6 text-gray-400 text-sm korean-font" id="quizReward">ì •ë‹µ ì‹œ ì—°êµ¬ í¬ì¸íŠ¸ +50, ì˜¤ë‹µ ì‹œ +10</div>
        </div>
    </div>

    <!-- ë¯¸ì…˜ ì™„ë£Œ ë° ë³´ìŠ¤ ì²˜ì¹˜ ì•Œë¦¼ ë“± -->
    <div id="notificationArea" class="fixed top-1/4 left-1/2 -translate-x-1/2 pointer-events-none z-40"></div>
    
    <!-- ë„ê° í™”ë©´ -->
    <div id="encyclopediaScreen" class="fixed inset-0 flex items-center justify-center bg-black/80 backdrop-blur-md z-50 hidden">
        <div class="science-panel rounded-3xl p-8 max-w-3xl max-h-[80vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-6">
                <div class="text-3xl font-black text-cyan-400 korean-font">ğŸ“– ê³¼í•™ ë„ê°</div>
                <button id="closeEncyclopedia" class="bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded-full korean-font">ë‹«ê¸°</button>
            </div>
            <div id="encyclopediaContent" class="space-y-4"></div>
        </div>
    </div>
    
    <!-- ì—°êµ¬ì†Œ í™”ë©´ (ì—…ê·¸ë ˆì´ë“œ) -->
    <div id="labScreen" class="fixed inset-0 flex items-center justify-center bg-black/80 backdrop-blur-md z-50 hidden">
        <div class="science-panel rounded-3xl p-8 max-w-3xl w-[90vw] max-h-[85vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <div class="text-3xl font-black text-cyan-400 korean-font">ğŸ›ï¸ ì—°êµ¬ì†Œ</div>
                    <div class="text-gray-300 text-sm korean-font">ì—°êµ¬ í¬ì¸íŠ¸ë¡œ ì˜êµ¬ ì—…ê·¸ë ˆì´ë“œë¥¼ êµ¬ë§¤í•˜ì„¸ìš” (ê²Œì„ ë‚´ì—ì„œë„ ì¦‰ì‹œ ì ìš©)</div>
                </div>
                <button id="closeLab" class="bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded-full korean-font">ë‹«ê¸° (B)</button>
            </div>

            <div class="flex flex-wrap gap-3 mb-6">
                <div class="bg-black/40 rounded-xl px-4 py-3 flex items-center gap-2">
                    <span class="text-2xl">ğŸ”¬</span>
                    <div>
                        <div class="text-xs text-gray-400 korean-font">ë³´ìœ  ì—°êµ¬</div>
                        <div class="text-xl font-black text-cyan-300 game-font" id="labRp">0</div>
                    </div>
                </div>
                <div class="bg-black/40 rounded-xl px-4 py-3 flex items-center gap-2">
                    <span class="text-2xl">ğŸ§¬</span>
                    <div>
                        <div class="text-xs text-gray-400 korean-font">ë³´ìœ  DNA</div>
                        <div class="text-xl font-black text-green-300 game-font" id="labDna">0</div>
                    </div>
                </div>
                <div class="bg-black/40 rounded-xl px-4 py-3 flex items-center gap-2">
                    <span class="text-2xl">ğŸš¨</span>
                    <div>
                        <div class="text-xs text-gray-400 korean-font">ë©´ì—­ ê²½ë³´</div>
                        <div class="text-xl font-black text-yellow-300 game-font" id="labAlert">0%</div>
                    </div>
                </div>
            </div>

            <div class="grid md:grid-cols-2 gap-4" id="labUpgrades"></div>

            <div class="mt-6 bg-black/30 rounded-xl p-4">
                <div class="text-cyan-300 font-bold korean-font mb-2">â„¹ï¸ ì•ˆë‚´</div>
                <div class="text-gray-300 text-sm korean-font leading-relaxed">
                    â€¢ <span class="text-white font-bold">ë³´ìŠ¤(5ì›¨ì´ë¸Œë§ˆë‹¤)</span>ë¥¼ ì²˜ì¹˜í•˜ë©´ <span class="text-white font-bold">í¬íƒˆ</span>ì´ ì—´ë¦½ë‹ˆë‹¤. í¬íƒˆ ê·¼ì²˜ì—ì„œ <span class="text-white font-bold">G</span>ë¥¼ ëˆŒëŸ¬ ë‹¤ìŒ ìŠ¤í…Œì´ì§€ë¡œ ì „ì´í•˜ì„¸ìš”.<br>
                    â€¢ ì—…ê·¸ë ˆì´ë“œëŠ” <span class="text-white font-bold">ë¸Œë¼ìš°ì €ì— ì €ì¥</span>ë˜ì–´ ë‹¤ìŒ í”Œë ˆì´ì—ë„ ìœ ì§€ë©ë‹ˆë‹¤.
                </div>
            </div>
        </div>
    </div>

    <!-- ì§„í™” ì„ íƒ í™”ë©´ -->
    <div id="evolutionScreen" class="fixed inset-0 flex items-center justify-center bg-black/80 backdrop-blur-md z-50 hidden">
        <div class="text-center">
            <div class="text-5xl font-black text-purple-400 mb-4 glow-text korean-font">ğŸ§¬ ëŒì—°ë³€ì´ ë°œìƒ!</div>
            <div class="text-gray-300 mb-2 korean-font">ì§„í™” ë°©í–¥ì„ ì„ íƒí•˜ì„¸ìš”</div>
            <div class="text-yellow-400 text-sm mb-8 korean-font" id="evolutionWarning"></div>
            <div class="flex gap-6" id="evolutionChoices"></div>
        </div>
    </div>
    
    <!-- ê²Œì„ ì˜¤ë²„ í™”ë©´ -->
    <div id="gameOverScreen" class="fixed inset-0 flex items-center justify-center bg-black/90 backdrop-blur-md z-50 hidden">
        <div class="ui-panel rounded-3xl p-12 text-center max-w-lg">
            <div class="text-8xl mb-6">ğŸ§«</div>
            <h1 class="text-4xl font-black text-red-500 mb-2 game-font">ë©´ì—­ ì‹œìŠ¤í…œ ìŠ¹ë¦¬</h1>
            <p class="text-gray-400 mb-6 korean-font">ë°”ì´ëŸ¬ìŠ¤ê°€ ë©´ì—­ ì„¸í¬ì— ì˜í•´ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤</p>
            
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="bg-black/50 rounded-xl p-4">
                    <div class="text-gray-400 text-sm korean-font">ìµœì¢… ë ˆë²¨</div>
                    <div class="text-3xl font-black text-purple-400 game-font" id="finalLevel">1</div>
                </div>
                <div class="bg-black/50 rounded-xl p-4">
                    <div class="text-gray-400 text-sm korean-font">ê°ì—¼ ì„¸í¬</div>
                    <div class="text-3xl font-black text-red-400 game-font" id="finalInfected">0</div>
                </div>
                <div class="bg-black/50 rounded-xl p-4">
                    <div class="text-gray-400 text-sm korean-font">ìƒì¡´ ì‹œê°„</div>
                    <div class="text-3xl font-black text-cyan-400 game-font" id="finalTime">00:00</div>
                </div>
                <div class="bg-black/50 rounded-xl p-4">
                    <div class="text-gray-400 text-sm korean-font">ì  ì²˜ì¹˜</div>
                    <div class="text-3xl font-black text-green-400 game-font" id="finalKills">0</div>
                </div>
            </div>
            
            <div class="bg-cyan-900/30 rounded-xl p-4 mb-6 text-left">
                <div class="text-cyan-400 font-bold mb-2 korean-font">ğŸ’¡ ì˜¤ëŠ˜ ë°°ìš´ ê²ƒ</div>
                <div class="text-gray-300 text-sm korean-font" id="learnedToday"></div>
            </div>
            
            <button id="restartBtn" class="bg-gradient-to-r from-purple-600 via-pink-600 to-purple-600 text-white font-black py-4 px-12 rounded-full text-xl transition-all transform hover:scale-110 korean-font">
                ğŸ”„ ë‹¤ì‹œ ì—°êµ¬
            </button>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);
        
        // ê²Œì„ ëª¨ë“œ
        let gameMode = 'learn';
        
        // ë‚œì´ë„ ì„¤ì •
        const difficultySettings = {
            learn: {
                enemySpawnMult: 0.5,
                enemySpeedMult: 0.8,
                damageMult: 0.5,
                waveSpeed: 2400,
                magnetRange: 4,
                magnetForce: 2,
                magnetDuration: 120,
                magnetCooldown: 360,
                healMult: 1.5,
                sizeSpeedPenalty: 0,
                quizPenalty: false,
                missiles: false,
                toxicZones: 0,
                xpMult: 1.5
            },
            normal: {
                enemySpawnMult: 1,
                enemySpeedMult: 1,
                damageMult: 1,
                waveSpeed: 1800,
                magnetRange: 3,
                magnetForce: 1.5,
                magnetDuration: 90,
                magnetCooldown: 480,
                healMult: 1,
                sizeSpeedPenalty: 0.002,
                quizPenalty: false,
                missiles: false,
                toxicZones: 2,
                xpMult: 1
            },
            challenge: {
                enemySpawnMult: 3,
                enemySpeedMult: 1.5,
                damageMult: 2,
                waveSpeed: 900,
                magnetRange: 1.5,
                magnetForce: 0.5,
                magnetDuration: 45,
                magnetCooldown: 900,
                healMult: 0.5,
                sizeSpeedPenalty: 0.01,
                quizPenalty: true,
                missiles: true,
                toxicZones: 8,
                xpMult: 0.7
            }
        };
        
        let difficulty = difficultySettings.learn;

        // ì‚¬ìš´ë“œ ë§¤ë‹ˆì € (Web Audio API)
        const SoundManager = {
            ctx: null,
            muted: false,
            init: function() {
                if (!this.ctx) {
                    this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                }
                if (this.ctx.state === 'suspended') {
                    this.ctx.resume();
                }
            },
            toggle: function() {
                this.muted = !this.muted;
                const btn = document.getElementById('soundBtn');
                btn.textContent = this.muted ? 'ğŸ”‡' : 'ğŸ”Š';
                return this.muted;
            },
            play: function(type) {
                if (this.muted || !this.ctx) return;
                
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.connect(gain);
                gain.connect(this.ctx.destination);

                const now = this.ctx.currentTime;
                
                if (type === 'shoot') {
                    osc.type = 'square';
                    osc.frequency.setValueAtTime(800, now);
                    osc.frequency.exponentialRampToValueAtTime(100, now + 0.1);
                    gain.gain.setValueAtTime(0.1, now);
                    gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                    osc.start(now);
                    osc.stop(now + 0.1);
                } else if (type === 'hit') {
                    osc.type = 'sawtooth';
                    osc.frequency.setValueAtTime(150, now);
                    osc.frequency.exponentialRampToValueAtTime(50, now + 0.1);
                    gain.gain.setValueAtTime(0.2, now);
                    gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                    osc.start(now);
                    osc.stop(now + 0.1);
                } else if (type === 'collect') {
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(600, now);
                    osc.frequency.exponentialRampToValueAtTime(1200, now + 0.1);
                    gain.gain.setValueAtTime(0.1, now);
                    gain.gain.linearRampToValueAtTime(0, now + 0.1);
                    osc.start(now);
                    osc.stop(now + 0.1);
                } else if (type === 'levelUp') {
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(400, now);
                    osc.frequency.setValueAtTime(600, now + 0.1);
                    osc.frequency.setValueAtTime(1000, now + 0.2);
                    gain.gain.setValueAtTime(0.2, now);
                    gain.gain.linearRampToValueAtTime(0, now + 0.6);
                    osc.start(now);
                    osc.stop(now + 0.6);
                } else if (type === 'dash') {
                    osc.type = 'triangle';
                    osc.frequency.setValueAtTime(300, now);
                    osc.frequency.linearRampToValueAtTime(100, now + 0.2);
                    gain.gain.setValueAtTime(0.2, now);
                    gain.gain.linearRampToValueAtTime(0, now + 0.2);
                    osc.start(now);
                    osc.stop(now + 0.2);
                }
            }
        };

        // ê³¼í•™ ë°ì´í„°
        const scienceData = {
            viruses: [
                { id: 'basic', name: 'ê¸°ë³¸ ë°”ì´ëŸ¬ìŠ¤', icon: 'ğŸ¦ ', desc: 'ë‹¨ìˆœí•œ êµ¬ì¡°ì˜ RNA ë°”ì´ëŸ¬ìŠ¤', fact: 'ë°”ì´ëŸ¬ìŠ¤ëŠ” ì‚´ì•„ìˆëŠ” ì„¸í¬ ì—†ì´ëŠ” ë³µì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', unlocked: true },
                { id: 'corona', name: 'ì½”ë¡œë‚˜ë°”ì´ëŸ¬ìŠ¤', icon: 'ğŸ‘‘', desc: 'ì™•ê´€ ëª¨ì–‘ì˜ ìŠ¤íŒŒì´í¬ ë‹¨ë°±ì§ˆ ë³´ìœ ', fact: 'ì½”ë¡œë‚˜ë°”ì´ëŸ¬ìŠ¤ì˜ ìŠ¤íŒŒì´í¬ ë‹¨ë°±ì§ˆì€ ìˆ™ì£¼ ì„¸í¬ì˜ ACE2 ìˆ˜ìš©ì²´ì— ê²°í•©í•©ë‹ˆë‹¤.', unlocked: false },
                { id: 'bacterio', name: 'ë°•í…Œë¦¬ì˜¤íŒŒì§€', icon: 'ğŸ”·', desc: 'ë°•í…Œë¦¬ì•„ë§Œ ê°ì—¼ì‹œí‚¤ëŠ” ë°”ì´ëŸ¬ìŠ¤', fact: 'ë°•í…Œë¦¬ì˜¤íŒŒì§€ëŠ” í•­ìƒì œ ë‚´ì„± ë°•í…Œë¦¬ì•„ ì¹˜ë£Œì— ì—°êµ¬ë˜ê³  ìˆìŠµë‹ˆë‹¤.', unlocked: false },
                { id: 'retro', name: 'ë ˆíŠ¸ë¡œë°”ì´ëŸ¬ìŠ¤', icon: 'ğŸ”„', desc: 'RNAë¥¼ DNAë¡œ ì—­ì „ì‚¬í•˜ëŠ” ë°”ì´ëŸ¬ìŠ¤', fact: 'HIVëŠ” ì—­ì „ì‚¬íš¨ì†Œë¥¼ ì´ìš©í•´ ìì‹ ì˜ ìœ ì „ì •ë³´ë¥¼ ìˆ™ì£¼ DNAì— ì‚½ì…í•©ë‹ˆë‹¤.', unlocked: false }
            ],
            immuneCells: [
                { id: 'whiteblood', name: 'ë°±í˜ˆêµ¬', icon: 'âšª', desc: 'ì¼ë°˜ì ì¸ ë©´ì—­ ì„¸í¬', fact: 'ë°±í˜ˆêµ¬ëŠ” í˜ˆì•¡ 1Î¼Lë‹¹ 4,000~11,000ê°œê°€ ìˆìŠµë‹ˆë‹¤.', unlocked: true },
                { id: 'macrophage', name: 'ëŒ€ì‹ì„¸í¬', icon: 'ğŸ”´', desc: 'ë³‘ì›ì²´ë¥¼ ì‚¼ì¼œì„œ ì œê±°', fact: 'ëŒ€ì‹ì„¸í¬ëŠ” ê·¸ë¦¬ìŠ¤ì–´ë¡œ "í° ë¨¹ëŠ” ì"ë¼ëŠ” ëœ»ì…ë‹ˆë‹¤.', unlocked: false },
                { id: 'tcell', name: 'Tì„¸í¬', icon: 'ğŸŸ£', desc: 'ê°ì—¼ëœ ì„¸í¬ë¥¼ ì§ì ‘ ê³µê²©', fact: 'Tì„¸í¬ëŠ” í‰ì„ (Thymus)ì—ì„œ ì„±ìˆ™í•˜ì—¬ ì´ë¦„ì´ ë¶™ì—ˆìŠµë‹ˆë‹¤.', unlocked: false },
                { id: 'antibody', name: 'í•­ì²´', icon: 'ğŸŸ¡', desc: 'ë°”ì´ëŸ¬ìŠ¤ë¥¼ í‘œì‹œí•˜ê³  ì¤‘í™”', fact: 'í•­ì²´ëŠ” Yì ëª¨ì–‘ì´ë©° íŠ¹ì • í•­ì›ì—ë§Œ ê²°í•©í•©ë‹ˆë‹¤.', unlocked: false },
                { id: 'nkcell', name: 'NKì„¸í¬', icon: 'ğŸ’œ', desc: 'ìì—°ì‚´í•´ì„¸í¬, ì•”ì„¸í¬ë„ ê³µê²©', fact: 'NKì„¸í¬ëŠ” ë°”ì´ëŸ¬ìŠ¤ ê°ì—¼ ì„¸í¬ë¥¼ MHC ì—†ì´ë„ ì¸ì‹í•©ë‹ˆë‹¤.', unlocked: false }
            ],
            aiConcepts: [
                { id: 'pathfinding', name: 'ê²½ë¡œ íƒìƒ‰', icon: 'ğŸ¯', desc: 'A* ì•Œê³ ë¦¬ì¦˜ìœ¼ë¡œ ìµœë‹¨ ê²½ë¡œ ì°¾ê¸°', fact: 'ê²Œì„ ì† ì ë“¤ì€ A* ì•Œê³ ë¦¬ì¦˜ìœ¼ë¡œ í”Œë ˆì´ì–´ë¥¼ ì¶”ì í•©ë‹ˆë‹¤.', unlocked: true, learned: 100 },
                { id: 'neural', name: 'ì‹ ê²½ë§', icon: 'ğŸ§ ', desc: 'ë‰´ëŸ°ì²˜ëŸ¼ ì—°ê²°ëœ ì¸ê³µ ì‹ ê²½ë§', fact: 'ì¸ê³µ ì‹ ê²½ë§ì€ ì¸ê°„ ë‡Œì˜ ë‰´ëŸ° ì—°ê²°ì„ ëª¨ë°©í•©ë‹ˆë‹¤.', unlocked: false, learned: 0 },
                { id: 'pattern', name: 'íŒ¨í„´ ì¸ì‹', icon: 'ğŸ“Š', desc: 'ë°ì´í„°ì—ì„œ íŒ¨í„´ì„ ì°¾ëŠ” AI', fact: 'AIëŠ” ë°”ì´ëŸ¬ìŠ¤ ë³€ì´ íŒ¨í„´ì„ ë¶„ì„í•´ ë°±ì‹  ê°œë°œì— ë„ì›€ì„ ì¤ë‹ˆë‹¤.', unlocked: false, learned: 0 },
                { id: 'prediction', name: 'ì˜ˆì¸¡ ëª¨ë¸', icon: 'ğŸ”®', desc: 'ë¯¸ë˜ë¥¼ ì˜ˆì¸¡í•˜ëŠ” AI ëª¨ë¸', fact: 'AIëŠ” ì „ì—¼ë³‘ í™•ì‚°ì„ ì˜ˆì¸¡í•˜ëŠ”ë° ì‚¬ìš©ë©ë‹ˆë‹¤.', unlocked: false, learned: 0 },
                { id: 'genetic', name: 'ìœ ì „ ì•Œê³ ë¦¬ì¦˜', icon: 'ğŸ§¬', desc: 'ì§„í™”ë¥¼ ëª¨ë°©í•œ ìµœì í™” ì•Œê³ ë¦¬ì¦˜', fact: 'ìœ ì „ ì•Œê³ ë¦¬ì¦˜ì€ ìì—°ì„ íƒì„ ëª¨ë°©í•˜ì—¬ ìµœì ì˜ í•´ë¥¼ ì°¾ìŠµë‹ˆë‹¤.', unlocked: false, learned: 0 }
            ]
        };
        
        // í€´ì¦ˆ ë°ì´í„°
        const quizzes = {
            science: [
                { q: 'ë°”ì´ëŸ¬ìŠ¤ì˜ ìœ ì „ ë¬¼ì§ˆì€ ë¬´ì—‡ìœ¼ë¡œ êµ¬ì„±ë˜ì–´ ìˆë‚˜ìš”?', options: ['DNA ë˜ëŠ” RNA', 'ë‹¨ë°±ì§ˆë§Œ', 'íƒ„ìˆ˜í™”ë¬¼', 'ì§€ë°©'], answer: 0, category: 'ë°”ì´ëŸ¬ìŠ¤í•™' },
                { q: 'ë°”ì´ëŸ¬ìŠ¤ê°€ ì„¸í¬ì— ì¹¨ì…í•  ë•Œ ì‚¬ìš©í•˜ëŠ” ë‹¨ë°±ì§ˆì€?', options: ['ìŠ¤íŒŒì´í¬ ë‹¨ë°±ì§ˆ', 'í—¤ëª¨ê¸€ë¡œë¹ˆ', 'ì¸ìŠë¦°', 'ì½œë¼ê²'], answer: 0, category: 'ë°”ì´ëŸ¬ìŠ¤í•™' },
                { q: 'ë°±í˜ˆêµ¬ì˜ ì£¼ìš” ê¸°ëŠ¥ì€ ë¬´ì—‡ì¸ê°€ìš”?', options: ['ì‚°ì†Œ ìš´ë°˜', 'ë©´ì—­ ë°©ì–´', 'í˜¸ë¥´ëª¬ ìƒì‚°', 'ì†Œí™”'], answer: 1, category: 'ë©´ì—­í•™' },
                { q: 'í•­ì²´ì˜ ëª¨ì–‘ì€ ì–´ë–¤ ì•ŒíŒŒë²³ê³¼ ë¹„ìŠ·í•œê°€ìš”?', options: ['X', 'Y', 'T', 'O'], answer: 1, category: 'ë©´ì—­í•™' },
                { q: 'Tì„¸í¬ëŠ” ì–´ëŠ ê¸°ê´€ì—ì„œ ì„±ìˆ™í•˜ë‚˜ìš”?', options: ['ê°„', 'í‰ì„ ', 'ë¹„ì¥', 'ê³¨ìˆ˜'], answer: 1, category: 'ë©´ì—­í•™' },
                { q: 'ë°”ì´ëŸ¬ìŠ¤ì˜ ì™¸ë¶€ ê»ì§ˆì„ ë¬´ì—‡ì´ë¼ê³  í•˜ë‚˜ìš”?', options: ['ìº¡ì‹œë“œ', 'ì„¸í¬ë§‰', 'ì„¸í¬ë²½', 'ì—½ë¡ì²´'], answer: 0, category: 'ë°”ì´ëŸ¬ìŠ¤í•™' },
                { q: 'DNAì˜ ì´ì¤‘ë‚˜ì„  êµ¬ì¡°ë¥¼ ë°œê²¬í•œ ê³¼í•™ìëŠ”?', options: ['ì•„ì¸ìŠˆíƒ€ì¸', 'ì™“ìŠ¨ê³¼ í¬ë¦­', 'ë‹¤ìœˆ', 'ë©˜ë¸'], answer: 1, category: 'ë¶„ììƒë¬¼í•™' },
                { q: 'ë ˆíŠ¸ë¡œë°”ì´ëŸ¬ìŠ¤ì˜ íŠ¹ì§•ì€?', options: ['ê´‘í•©ì„±', 'RNAë¥¼ DNAë¡œ ë³€í™˜', 'í¬ì í˜•ì„±', 'ë¶„ì—´ ë²ˆì‹'], answer: 1, category: 'ë°”ì´ëŸ¬ìŠ¤í•™' }
            ],
            ai: [
                { q: 'A* ì•Œê³ ë¦¬ì¦˜ì€ ì£¼ë¡œ ì–´ë–¤ ìš©ë„ë¡œ ì‚¬ìš©ë˜ë‚˜ìš”?', options: ['ì´ë¯¸ì§€ ì²˜ë¦¬', 'ê²½ë¡œ íƒìƒ‰', 'ìŒì„± ì¸ì‹', 'ë²ˆì—­'], answer: 1, category: 'AI ì•Œê³ ë¦¬ì¦˜' },
                { q: 'ì¸ê³µ ì‹ ê²½ë§ì€ ë¬´ì—‡ì„ ëª¨ë°©í•œ ê²ƒì¸ê°€ìš”?', options: ['ì»´í“¨í„° íšŒë¡œ', 'ì¸ê°„ì˜ ë‡Œ', 'íƒœì–‘ê³„', 'ì‹ë¬¼ êµ¬ì¡°'], answer: 1, category: 'ë”¥ëŸ¬ë‹' },
                { q: 'ë¨¸ì‹ ëŸ¬ë‹ì—ì„œ "í›ˆë ¨ ë°ì´í„°"ì˜ ì—­í• ì€?', options: ['AIë¥¼ ë„ê¸°', 'AIê°€ íŒ¨í„´ì„ í•™ìŠµ', 'í”„ë¡œê·¸ë¨ ì‚­ì œ', 'í•˜ë“œì›¨ì–´ ì ê²€'], answer: 1, category: 'ë¨¸ì‹ ëŸ¬ë‹' },
                { q: 'ìœ ì „ ì•Œê³ ë¦¬ì¦˜ì€ ì–´ë–¤ ìì—° í˜„ìƒì„ ëª¨ë°©í•˜ë‚˜ìš”?', options: ['ì§€ì§„', 'ì§„í™”ì™€ ìì—°ì„ íƒ', 'ê´‘í•©ì„±', 'ì¡°ë ¥'], answer: 1, category: 'AI ì•Œê³ ë¦¬ì¦˜' },
                { q: 'AIê°€ ë°”ì´ëŸ¬ìŠ¤ ì—°êµ¬ì— ê¸°ì—¬í•˜ëŠ” ë°©ë²•ì€?', options: ['ë°”ì´ëŸ¬ìŠ¤ ìƒì„±', 'ë³€ì´ íŒ¨í„´ ë¶„ì„', 'ë©´ì—­ë ¥ ì•½í™”', 'ì—†ìŒ'], answer: 1, category: 'AI ì‘ìš©' },
                { q: 'ê°•í™”í•™ìŠµì—ì„œ AIê°€ í•™ìŠµí•˜ëŠ” ë°©ì‹ì€?', options: ['êµê³¼ì„œ ì½ê¸°', 'ì‹œí–‰ì°©ì˜¤ì™€ ë³´ìƒ', 'ìˆ˜ë©´', 'ëª…ìƒ'], answer: 1, category: 'ê°•í™”í•™ìŠµ' }
            ]
        };
        
        // ê³¼í•™ íŒ
        const scienceTips = [
            { icon: 'ğŸ¦ ', text: 'ë°”ì´ëŸ¬ìŠ¤ëŠ” ìˆ™ì£¼ ì„¸í¬ì˜ ë³µì œ ê¸°ê´€ì„ "ë‚©ì¹˜"í•˜ì—¬ ìì‹ ì„ ë³µì œí•©ë‹ˆë‹¤.' },
            { icon: 'ğŸ§¬', text: 'RNA ë°”ì´ëŸ¬ìŠ¤ëŠ” DNA ë°”ì´ëŸ¬ìŠ¤ë³´ë‹¤ ë³€ì´ê°€ ë¹ ë¥´ê²Œ ì¼ì–´ë‚©ë‹ˆë‹¤.' },
            { icon: 'ğŸ›¡ï¸', text: 'ë°±ì‹ ì€ ë©´ì—­ ì‹œìŠ¤í…œì´ ë³‘ì›ì²´ë¥¼ "ê¸°ì–µ"í•˜ë„ë¡ í›ˆë ¨ì‹œí‚µë‹ˆë‹¤.' },
            { icon: 'ğŸ”¬', text: 'ë°”ì´ëŸ¬ìŠ¤ì˜ í¬ê¸°ëŠ” ì•½ 20~300 ë‚˜ë…¸ë¯¸í„°ë¡œ, ì„¸ê· ë³´ë‹¤ í›¨ì”¬ ì‘ìŠµë‹ˆë‹¤.' },
            { icon: 'ğŸ§ ', text: 'ì‹ ê²½ë§ AIëŠ” ì´ë¯¸ì§€ì—ì„œ ë°”ì´ëŸ¬ìŠ¤ë¥¼ ìë™ìœ¼ë¡œ íƒì§€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.' },
            { icon: 'ğŸ“Š', text: 'AIëŠ” ìˆ˜ë°±ë§Œ ê°œì˜ ë¶„ì ì¡°í•©ì—ì„œ ë°±ì‹  í›„ë³´ë¥¼ ì°¾ëŠ”ë° ì‚¬ìš©ë©ë‹ˆë‹¤.' },
            { icon: 'ğŸ¯', text: 'ê²½ë¡œ íƒìƒ‰ ì•Œê³ ë¦¬ì¦˜ì€ ê²Œì„ AIë¶€í„° GPSê¹Œì§€ ë„ë¦¬ ì‚¬ìš©ë©ë‹ˆë‹¤.' },
            { icon: 'ğŸ’‰', text: 'mRNA ë°±ì‹ ì€ ë°”ì´ëŸ¬ìŠ¤ ìœ ì „ì •ë³´ ì¼ë¶€ë¥¼ ì‚¬ìš©í•´ ë©´ì—­ì„ ìœ ë„í•©ë‹ˆë‹¤.' }
        ];
        
        // ê²Œì„ ìƒíƒœ
        const game = {
            running: false,
            paused: false,
            worldSize: 4000,
            startTime: 0,
            infected: 0,
            enemiesKilled: 0,
            zoom: 1,
            targetZoom: 1,
            wave: 1,
            waveTimer: 0,
            combo: 0,
            maxCombo: 0,
            comboTimer: 0,
            cameraShake: 0,
            researchPoints: 0,
            dnaCollected: 0,
            quizCorrect: 0,
            quizTotal: 0,
            tipTimer: 0,
            learnedFacts: [],
            quizTimerInterval: null,
            mission: null, 
            missionTimer: 0,
            aiDebugMode: false,
            stormActive: false,
            stormTimer: 0,
            highScore: localStorage.getItem('virusLabHighScore') || 0,
            // ìŠ¤í…Œì´ì§€ ì‹œìŠ¤í…œ ì¶”ê°€
            stage: 1,
            bossActive: false,
            boss: null,
            artifacts: [], // ë³´ìŠ¤ ì²˜ì¹˜ ë³´ìƒ
            // ë©´ì—­ ê²½ë³´(Heat) ì‹œìŠ¤í…œ: ê°ì—¼/ì „íˆ¬ê°€ ë§ì„ìˆ˜ë¡ ë©´ì—­ ë°˜ì‘ì´ ê°•í™”ë¨
            immuneAlert: 0, // 0~100
            immuneAlertDecay: 0.01,
            // ë³´ìŠ¤ ì²˜ì¹˜ í›„ í¬íƒˆ ìƒì„± (Gë¡œ ì§„ì…)
            portal: null,
            // ì €ì¥ë˜ëŠ” ì˜êµ¬ ì—…ê·¸ë ˆì´ë“œ (ì—°êµ¬ì†Œ)
            persistent: {
                version: 1,
                upgrades: {
                    receptorDampener: 0, // ìì„ íš¨ê³¼ ì–µì œ(ì¶”ê°€ ë„ˆí”„)
                    capsidPlating: 0, // ë°©ì–´
                    replicationBoost: 0, // XP íšë“
                    metabolism: 0, // íšŒë³µ
                    stealthCoat: 0 // ë©´ì—­ ê²½ë³´ ì¶•ì  ê°ì†Œ
                }
            },
            stageData: [
                { id: 1, name: 'í˜ˆê´€ (Bloodstream)', desc: 'ê°•í•œ í˜ˆë¥˜ê°€ íë¥´ëŠ” ê³³', colorStart: '#2a0808', colorEnd: '#0a0202', flow: {x: 0.5, y: 0}, friction: 0.99 },
                { id: 2, name: 'í (Lungs)', desc: 'ê³µê¸° íë¦„ê³¼ ê¸°ì¹¨ ì£¼ì˜', colorStart: '#081a2a', colorEnd: '#02050a', flow: {x: 0, y: 0}, friction: 0.98 },
                { id: 3, name: 'ì‹ ê²½ê³„ (Nervous Sys)', desc: 'ì „ê¸° ì‹ í˜¸ì™€ ë³µì¡í•œ êµ¬ì¡°', colorStart: '#1a082a', colorEnd: '#05020a', flow: {x: 0, y: 0}, friction: 0.99 }
            ]
        };
        
        // í”Œë ˆì´ì–´
        const player = {
            x: 2000,
            y: 2000,
            size: 25,
            baseSpeed: 5,
            speed: 5,
            level: 1,
            xp: 0,
            xpToLevel: 100,
            hp: 100,
            maxHp: 100,
            dashCooldown: 0,
            dashActive: false,
            tentacles: [],
            color: { h: 280, s: 80, l: 55 },
            speedMult: 1,
            absorbMult: 1,
            defenseMult: 0,
            regen: 0,
            strain: 'basic', // basic, speed, tank, infect
            strainStats: {
                basic: { speed: 1, def: 0, absorb: 1, color: { h: 280, s: 80, l: 55 }, name: 'ê¸°ë³¸í˜•' },
                speed: { speed: 1.5, def: -0.3, absorb: 0.8, color: { h: 200, s: 90, l: 60 }, name: 'ì‹ ì†í˜•' },
                tank: { speed: 0.7, def: 0.5, absorb: 0.8, color: { h: 120, s: 70, l: 40 }, name: 'ê°‘ì˜·í˜•' },
                infect: { speed: 0.9, def: -0.2, absorb: 1.5, color: { h: 0, s: 90, l: 50 }, name: 'ê°ì—¼í˜•' }
            },
            skills: {
                toxin: { cooldown: 0, maxCooldown: 300, active: false, duration: 0 },
                magnet: { cooldown: 0, maxCooldown: 480, active: false, duration: 0 },
                split: { cooldown: 0, maxCooldown: 480, active: false },
                shield: { cooldown: 0, maxCooldown: 600, active: false, duration: 0 }
            },
            powerups: { invincible: 0, magnet: 0 },
            splitlings: []
        };
        
        let cells = [];
        let particles = [];
        let enemies = [];
        let powerups = [];
        let floatingTexts = [];
        let backgroundElements = [];
        let dnaPickups = [];
        let missiles = [];
        let toxicZones = [];
        let stormProjectiles = [];
        
        // ì§„í™” ì˜µì…˜
        const evolutionOptions = [
            { id: 'speed', name: 'âš¡ ë³µì œ ê°€ì†', desc: 'ì´ë™ ì†ë„ +15%', icon: 'âš¡', color: 'from-cyan-500 to-blue-600', fact: 'ë°”ì´ëŸ¬ìŠ¤ ë³µì œ ì†ë„ëŠ” ìˆ™ì£¼ ì„¸í¬ì˜ ìƒíƒœì— ë”°ë¼ ë‹¬ë¼ì§‘ë‹ˆë‹¤.', apply: () => { player.speedMult += 0.15; } },
            { id: 'absorb', name: 'ğŸ§² ìˆ˜ìš©ì²´ ì¹œí™”', desc: 'ê°ì—¼ë ¥ +20%', icon: 'ğŸ§²', color: 'from-pink-500 to-rose-600', fact: 'ë°”ì´ëŸ¬ìŠ¤ëŠ” íŠ¹ì • ì„¸í¬ ìˆ˜ìš©ì²´ì— ê²°í•©í•˜ì—¬ ì¹¨ì…í•©ë‹ˆë‹¤.', apply: () => { player.absorbMult += 0.2; } },
            { id: 'defense', name: 'ğŸ›¡ï¸ ì™¸í”¼ ê°•í™”', desc: 'ë°›ëŠ” í”¼í•´ -15%', icon: 'ğŸ›¡ï¸', color: 'from-yellow-500 to-orange-600', fact: 'ì¼ë¶€ ë°”ì´ëŸ¬ìŠ¤ëŠ” ì„¸í¬ë§‰ì—ì„œ ì™¸í”¼ë¥¼ íšë“í•©ë‹ˆë‹¤.', apply: () => { player.defenseMult += 0.15; } },
            { id: 'hp', name: 'â¤ï¸ êµ¬ì¡° ì•ˆì •í™”', desc: 'ìµœëŒ€ ì²´ë ¥ +25', icon: 'â¤ï¸', color: 'from-red-500 to-pink-600', fact: 'ë°”ì´ëŸ¬ìŠ¤ êµ¬ì¡°ì˜ ì•ˆì •ì„±ì€ ìƒì¡´ì— ì¤‘ìš”í•©ë‹ˆë‹¤.', apply: () => { player.maxHp += 25; player.hp += 25; } },
            { id: 'regen', name: 'ğŸ”„ ìê°€ ìˆ˜ë³µ', desc: 'ì²´ë ¥ ìë™ íšŒë³µ', icon: 'ğŸ”„', color: 'from-lime-500 to-green-600', fact: 'ì¼ë¶€ ë°”ì´ëŸ¬ìŠ¤ëŠ” ì†ìƒëœ êµ¬ì¡°ë¥¼ ë³µêµ¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', apply: () => { player.regen = (player.regen || 0) + 0.05; } },
            { id: 'dash', name: 'ğŸ’¨ ê³ ì† ì´ë™', desc: 'ëŒ€ì‹œ ì¿¨ë‹¤ìš´ -30%', icon: 'ğŸ’¨', color: 'from-indigo-500 to-purple-600', fact: 'ë¹ ë¥¸ ì´ë™ì€ ë©´ì—­ ì„¸í¬ íšŒí”¼ì— ë„ì›€ë©ë‹ˆë‹¤.', apply: () => { player.dashCooldownMult = (player.dashCooldownMult || 1) * 0.7; } }
        ];
        
        // í‚¤ ì…ë ¥
        const keys = {};
        window.addEventListener('keydown', e => {
            keys[e.code] = true;
            
            if (e.code === 'Space' && player.dashCooldown <= 0 && game.running && !game.paused) {
                player.dashActive = true;
                player.dashCooldown = 90 * (player.dashCooldownMult || 1);
                setTimeout(() => player.dashActive = false, 180);
                game.cameraShake = 5;
            }
            
            if (e.code === 'KeyQ' && player.skills.toxin.cooldown <= 0 && game.running && !game.paused) {
                activateToxin();
            }
            if (e.code === 'KeyE' && player.skills.magnet.cooldown <= 0 && game.running && !game.paused) {
                activateMagnet();
            }
            if (e.code === 'KeyR' && player.skills.split.cooldown <= 0 && game.running && !game.paused) {
                activateBurst();
            }
            if (e.code === 'KeyF' && player.skills.shield.cooldown <= 0 && game.running && !game.paused) {
                activateShield();
            }
            if (e.code === 'KeyV' && game.running && !game.paused) {
                toggleHide();
            }
            if (e.code === 'Tab' && game.running) {
                e.preventDefault();
                toggleEncyclopedia();
            }
            if (e.code === 'Digit1') changeStrain('speed');
            if (e.code === 'Digit2') changeStrain('tank');
            if (e.code === 'Digit3') changeStrain('infect');
            if (e.code === 'KeyH') {
                game.aiDebugMode = !game.aiDebugMode;
                createFloatingText(player.x, player.y - 50, game.aiDebugMode ? "AI ì‹œê°í™” ì¼œì§" : "AI ì‹œê°í™” êº¼ì§", "#ffffff");
            }

            // ì—°êµ¬ì†Œ í† ê¸€
            if (e.code === 'KeyB' && game.running) {
                toggleLab();
            }

            // í¬íƒˆ ì§„ì…
            if (e.code === 'KeyG' && game.running && !game.paused) {
                tryEnterPortal();
            }

            // ESC: ì˜¤ë²„ë ˆì´ ë‹«ê¸°
            if (e.code === 'Escape' && game.running) {
                if (!document.getElementById('labScreen').classList.contains('hidden')) toggleLab(false);
                if (!document.getElementById('encyclopediaScreen').classList.contains('hidden')) {
                    game.paused = false;
                    document.getElementById('encyclopediaScreen').classList.add('hidden');
                }
            }
        });
        window.addEventListener('keyup', e => keys[e.code] = false);
        
        function changeStrain(strain) {
            if (player.strain === strain) {
                player.strain = 'basic';
            } else {
                player.strain = strain;
            }
            
            const stats = player.strainStats[player.strain];
            player.color = stats.color;
            createParticles(player.x, player.y, `hsl(${stats.color.h}, 100%, 70%)`, 20);
            createFloatingText(player.x, player.y - 60, `${stats.name} ì „í™˜!`, `hsl(${stats.color.h}, 100%, 70%)`);
            game.cameraShake = 5;
            updateUI();
        }

        // ìŠ¤í‚¬ ë²„íŠ¼
        document.getElementById('skillQ').addEventListener('click', () => {
            if (player.skills.toxin.cooldown <= 0 && game.running && !game.paused) activateToxin();
        });
        document.getElementById('skillE').addEventListener('click', () => {
            if (player.skills.magnet.cooldown <= 0 && game.running && !game.paused) activateMagnet();
        });
        document.getElementById('skillR').addEventListener('click', () => {
            if (player.skills.split.cooldown <= 0 && game.running && !game.paused) activateBurst();
        });
        document.getElementById('skillF').addEventListener('click', () => {
            if (player.skills.shield.cooldown <= 0 && game.running && !game.paused) activateShield();
        });
        
        // ìŠ¤í‚¬ í•¨ìˆ˜ë“¤
        function activateToxin() {
            player.skills.toxin.cooldown = player.skills.toxin.maxCooldown;
            player.skills.toxin.active = true;
            player.skills.toxin.duration = 60;
            game.cameraShake = 8;
            
            showAIAnalysis('ë…ì†Œ ë¶„ë¹„ í™œì„±í™”');
            
            const range = player.size * 2.5;
            cells.forEach(cell => {
                const dist = Math.hypot(player.x - cell.x, player.y - cell.y);
                if (dist < range && cell.size < player.size * 1.2) {
                    cell.poisoned = true;
                    cell.poisonTimer = 120;
                    createParticles(cell.x, cell.y, 'rgba(0, 255, 0, 0.8)', 5);
                }
            });
        }
        
        function activateMagnet() {
            player.skills.magnet.cooldown = difficulty.magnetCooldown;
            player.skills.magnet.active = true;
            player.skills.magnet.duration = difficulty.magnetDuration;
            game.cameraShake = 3;
            showAIAnalysis('ìˆ˜ìš©ì²´ ê²°í•© ê°•í™” (ì œí•œì  íš¨ê³¼)');
        }
        
        function activateBurst() {
            player.skills.split.cooldown = player.skills.split.maxCooldown;
            game.cameraShake = 10;
            showAIAnalysis('ìˆ™ì£¼ íŒŒì—´: ë°”ì´ëŸ¬ìŠ¤ ì…ì ë°©ì¶œ');
            
            createFloatingText(player.x, player.y - 50, "Viral Burst!", "#ff00ff");
            
            // ë°”ì´ëŸ¬ìŠ¤ëŠ” ë¶„ì—´í•˜ì§€ ì•Šê³  ë³µì œ í›„ ë°©ì¶œë¨ì„ í‘œí˜„
            for (let i = 0; i < 6; i++) {
                const angle = (Math.PI * 2 / 6) * i;
                player.splitlings.push({
                    x: player.x,
                    y: player.y,
                    vx: Math.cos(angle) * 18,
                    vy: Math.sin(angle) * 18,
                    size: player.size * 0.25,
                    life: 90
                });
            }
        }

        function toggleHide() {
            if (player.isHidden) {
                // ë‚˜ì˜¤ê¸°
                player.isHidden = false;
                if (player.hostCell) {
                    createParticles(player.hostCell.x, player.hostCell.y, '#ff0000', 20);
                    // ìˆ™ì£¼ íŒŒê´´ ë³´ìƒ
                    player.xp += player.hostCell.size * 2;
                    // ìˆ™ì£¼ ì„¸í¬ ì œê±° or ì¶•ì†Œ (ì—¬ê¸°ì„  ì œê±°í•˜ê³  ìƒˆ ì„¸í¬ ìƒì„±)
                    const idx = cells.indexOf(player.hostCell);
                    if (idx !== -1) {
                        cells.splice(idx, 1);
                        cells.push(createCell());
                    }
                    player.hostCell = null;
                    game.cameraShake = 10;
                    createFloatingText(player.x, player.y - 50, "ìš©í•´ ì£¼ê¸° (Lysis)!", "#ff0000");
                }
            } else {
                // ë“¤ì–´ê°€ê¸°
                // ê°€ì¥ ê°€ê¹Œìš´ ì¶©ë¶„íˆ í° ì„¸í¬ ì°¾ê¸°
                let target = null;
                let minDist = 1000;
                
                cells.forEach(cell => {
                    const dist = Math.hypot(player.x - cell.x, player.y - cell.y);
                    if (dist < player.size + cell.size + 20 && cell.size > player.size * 0.8) {
                        if (dist < minDist) {
                            minDist = dist;
                            target = cell;
                        }
                    }
                });
                
                if (target) {
                    player.isHidden = true;
                    player.hostCell = target;
                    player.x = target.x;
                    player.y = target.y;
                    createFloatingText(player.x, player.y - 50, "ì ë³µ (Lysogenic)", "#00ff00");
                    showAIAnalysis('ë°”ì´ëŸ¬ìŠ¤ ì ë³µ: ë©´ì—­ íšŒí”¼ ë° ìê°€ ì¹˜ìœ ');
                } else {
                    createFloatingText(player.x, player.y - 50, "ìˆ¨ì„ ìˆ™ì£¼ê°€ ì—†ìŒ!", "#ffaaaa");
                }
            }
        }
        
        function activateShield() {
            player.skills.shield.cooldown = player.skills.shield.maxCooldown;
            player.skills.shield.active = true;
            player.skills.shield.duration = 120;
            game.cameraShake = 5;
            showAIAnalysis('ìº¡ì‹œë“œ ê°•í™”: 3ì´ˆê°„ ë¬´ì ');
        }
        
        // ê³¼í•™ íŒ í‘œì‹œ
        function showScienceTip() {
            const tip = scienceTips[Math.floor(Math.random() * scienceTips.length)];
            document.getElementById('tipIcon').textContent = tip.icon;
            document.getElementById('tipText').textContent = tip.text;
            document.getElementById('scienceTip').classList.remove('opacity-0');
            
            if (!game.learnedFacts.includes(tip.text)) {
                game.learnedFacts.push(tip.text);
            }
            
            setTimeout(() => {
                document.getElementById('scienceTip').classList.add('opacity-0');
            }, 5000);
        }
        
        // AI ë¶„ì„ í‘œì‹œ
        function showAIAnalysis(text) {
            document.getElementById('aiText').textContent = text;
            document.getElementById('aiAnalysis').classList.remove('opacity-0');
            
            setTimeout(() => {
                document.getElementById('aiAnalysis').classList.add('opacity-0');
            }, 3000);
        }
        
        // í€´ì¦ˆ í‘œì‹œ
        function showQuiz() {
            game.paused = true;
            const category = Math.random() < 0.5 ? 'science' : 'ai';
            const quiz = quizzes[category][Math.floor(Math.random() * quizzes[category].length)];
            
            document.getElementById('quizCategory').textContent = quiz.category;
            document.getElementById('quizIcon').textContent = category === 'science' ? 'ğŸ”¬' : 'ğŸ¤–';
            document.getElementById('quizQuestion').textContent = quiz.q;
            
            // ë„ì „ ëª¨ë“œì—ì„œ í€´ì¦ˆ íƒ€ì´ë¨¸
            if (gameMode === 'challenge') {
                document.getElementById('quizTimer').classList.remove('hidden');
                document.getElementById('quizPanel').classList.add('challenge-panel');
                document.getElementById('quizPanel').classList.remove('science-panel');
                document.getElementById('quizReward').textContent = 'âš ï¸ ì˜¤ë‹µ ì‹œ í”¼í•´ 30! ì‹œê°„ ì´ˆê³¼ë„ í”¼í•´!';
                let timeLeft = 8;
                document.getElementById('quizTimeLeft').textContent = timeLeft;
                
                game.quizTimerInterval = setInterval(() => {
                    timeLeft--;
                    document.getElementById('quizTimeLeft').textContent = timeLeft;
                    if (timeLeft <= 0) {
                        clearInterval(game.quizTimerInterval);
                        player.hp -= 30;
                        game.cameraShake = 15;
                        createFloatingText(player.x, player.y - 50, 'ì‹œê°„ ì´ˆê³¼! -30 HP', '#ff0000');
                        document.getElementById('quizScreen').classList.add('hidden');
                        game.paused = false;
                    }
                }, 1000);
            } else {
                document.getElementById('quizTimer').classList.add('hidden');
                document.getElementById('quizPanel').classList.remove('challenge-panel');
                document.getElementById('quizPanel').classList.add('science-panel');
                document.getElementById('quizReward').textContent = 'ì •ë‹µ ì‹œ ì—°êµ¬ í¬ì¸íŠ¸ +50, ì˜¤ë‹µ ì‹œ +10';
            }
            
            const optionsContainer = document.getElementById('quizOptions');
            optionsContainer.innerHTML = '';
            
            quiz.options.forEach((opt, i) => {
                const btn = document.createElement('div');
                btn.className = 'quiz-option bg-black/40 rounded-xl p-4 text-left text-white korean-font border border-cyan-800';
                btn.innerHTML = `<span class="text-cyan-400 font-bold mr-3">${['A', 'B', 'C', 'D'][i]}.</span>${opt}`;
                btn.addEventListener('click', () => {
                    if (game.quizTimerInterval) clearInterval(game.quizTimerInterval);
                    game.quizTotal++;
                    
                    if (i === quiz.answer) {
                        game.quizCorrect++;
                        game.researchPoints += 50;
                        player.xp += 30;
                        createFloatingText(player.x, player.y - 50, 'ì •ë‹µ! +50 ì—°êµ¬í¬ì¸íŠ¸', '#00ffaa');
                        btn.classList.add('border-green-500', 'bg-green-900/40');
                    } else {
                        game.researchPoints += 10;
                        if (difficulty.quizPenalty) {
                            player.hp -= 30;
                            createFloatingText(player.x, player.y - 50, 'ì˜¤ë‹µ! -30 HP', '#ff0000');
                            game.cameraShake = 15;
                        } else {
                            createFloatingText(player.x, player.y - 50, 'ì˜¤ë‹µ... +10 ì—°êµ¬í¬ì¸íŠ¸', '#ff6666');
                        }
                        btn.classList.add('border-red-500', 'bg-red-900/40');
                        optionsContainer.children[quiz.answer].classList.add('border-green-500', 'bg-green-900/40');
                    }
                    
                    setTimeout(() => {
                        document.getElementById('quizScreen').classList.add('hidden');
                        game.paused = false;
                    }, 1000);
                });
                optionsContainer.appendChild(btn);
            });
            
            document.getElementById('quizScreen').classList.remove('hidden');
        }
        
        // ë„ê° í† ê¸€
        function toggleEncyclopedia() {
            const screen = document.getElementById('encyclopediaScreen');
            if (screen.classList.contains('hidden')) {
                game.paused = true;
                screen.classList.remove('hidden');
                renderEncyclopedia();
            } else {
                game.paused = false;
                screen.classList.add('hidden');
            }
        }
        
        document.getElementById('closeEncyclopedia').addEventListener('click', () => {
            game.paused = false;
            document.getElementById('encyclopediaScreen').classList.add('hidden');
        });
        
        function renderEncyclopedia() {
            const content = document.getElementById('encyclopediaContent');
            content.innerHTML = '';
            
            content.innerHTML += '<div class="text-xl font-bold text-cyan-400 mb-3 korean-font">ğŸ¦  ë°”ì´ëŸ¬ìŠ¤</div>';
            scienceData.viruses.forEach(v => {
                const div = document.createElement('div');
                div.className = `bg-black/40 rounded-xl p-4 ${v.unlocked ? '' : 'opacity-50'}`;
                div.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="text-3xl">${v.icon}</div>
                        <div>
                            <div class="text-white font-bold korean-font">${v.name} ${v.unlocked ? '' : 'ğŸ”’'}</div>
                            <div class="text-gray-400 text-sm korean-font">${v.desc}</div>
                            ${v.unlocked ? `<div class="text-cyan-400 text-sm mt-1 korean-font">ğŸ’¡ ${v.fact}</div>` : ''}
                        </div>
                    </div>
                `;
                content.appendChild(div);
            });
            
            content.innerHTML += '<div class="text-xl font-bold text-red-400 mt-6 mb-3 korean-font">ğŸ›¡ï¸ ë©´ì—­ ì„¸í¬</div>';
            scienceData.immuneCells.forEach(c => {
                const div = document.createElement('div');
                div.className = `bg-black/40 rounded-xl p-4 ${c.unlocked ? '' : 'opacity-50'}`;
                div.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="text-3xl">${c.icon}</div>
                        <div>
                            <div class="text-white font-bold korean-font">${c.name} ${c.unlocked ? '' : 'ğŸ”’'}</div>
                            <div class="text-gray-400 text-sm korean-font">${c.desc}</div>
                            ${c.unlocked ? `<div class="text-red-400 text-sm mt-1 korean-font">ğŸ’¡ ${c.fact}</div>` : ''}
                        </div>
                    </div>
                `;
                content.appendChild(div);
            });
            
            content.innerHTML += '<div class="text-xl font-bold text-pink-400 mt-6 mb-3 korean-font">ğŸ¤– AI ê°œë…</div>';
            scienceData.aiConcepts.forEach(a => {
                const div = document.createElement('div');
                div.className = `bg-black/40 rounded-xl p-4 ${a.unlocked ? '' : 'opacity-50'}`;
                div.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="text-3xl">${a.icon}</div>
                        <div class="flex-1">
                            <div class="text-white font-bold korean-font">${a.name} ${a.unlocked ? '' : 'ğŸ”’'}</div>
                            <div class="text-gray-400 text-sm korean-font">${a.desc}</div>
                            ${a.unlocked ? `<div class="text-pink-400 text-sm mt-1 korean-font">ğŸ’¡ ${a.fact}</div>` : ''}
                        </div>
                    </div>
                `;
                content.appendChild(div);
            });
        }

        // ====== í° ì—…ë°ì´íŠ¸ 1) ì—°êµ¬ì†Œ(ì˜êµ¬ ì—…ê·¸ë ˆì´ë“œ + ì €ì¥) ======
        const PERSIST_KEY = 'virusLabPersistent_v1';

        function loadPersistent() {
            try {
                const raw = localStorage.getItem(PERSIST_KEY);
                if (!raw) return;
                const data = JSON.parse(raw);
                if (!data || typeof data !== 'object') return;
                // ê°„ë‹¨ ë§ˆì´ê·¸ë ˆì´ì…˜
                game.persistent = game.persistent || { version: 1, upgrades: {} };
                game.persistent.version = 1;
                game.persistent.upgrades = { ...game.persistent.upgrades, ...(data.upgrades || {}) };
            } catch (e) {
                // ignore
            }
        }

        function savePersistent() {
            try {
                localStorage.setItem(PERSIST_KEY, JSON.stringify(game.persistent));
            } catch (e) {
                // ignore
            }
        }

        const labUpgradeDefs = {
            capsidPlating: {
                name: 'ğŸ›¡ï¸ ìº¡ì‹œë“œ ë„ê¸ˆ',
                desc: 'ë°©ì–´ë ¥ ì¦ê°€ (ë°›ëŠ” í”¼í•´ ê°ì†Œ)',
                max: 6,
                baseCost: 250,
                costMult: 1.55,
                apply: (lv) => {
                    // ë°©ì–´ëŠ” 0~0.6 ì •ë„ë¡œ ì œí•œ
                    player.defenseMult += Math.min(0.45, lv * 0.06);
                }
            },
            replicationBoost: {
                name: 'âš¡ ë³µì œ ìµœì í™”',
                desc: 'íšë“ XP ì¦ê°€ (ì„±ì¥ ê°€ì†)',
                max: 8,
                baseCost: 200,
                costMult: 1.45,
                apply: (lv) => {
                    game.xpBonusMult = 1 + lv * 0.08;
                }
            },
            metabolism: {
                name: 'ğŸ”„ ëŒ€ì‚¬ ê°œì„ ',
                desc: 'íšŒë³µ íš¨ìœ¨ ì¦ê°€ (í/ì¬ìƒ ê°•í™”)',
                max: 6,
                baseCost: 220,
                costMult: 1.5,
                apply: (lv) => {
                    game.healBonusMult = 1 + lv * 0.12;
                }
            },
            stealthCoat: {
                name: 'ğŸ«¥ ì€í ì½”íŒ…',
                desc: 'ë©´ì—­ ê²½ë³´(Heat) ì¶•ì  ê°ì†Œ',
                max: 6,
                baseCost: 260,
                costMult: 1.5,
                apply: (lv) => {
                    game.alertGainMult = Math.max(0.35, 1 - lv * 0.12);
                }
            },
            receptorDampener: {
                name: 'ğŸ§ª í•­ì²´ êµë€',
                desc: 'í•­ì²´ í­í’ í™•ë¥  ê°ì†Œ + í­í’ ì¿¨ë‹¤ìš´ ì¦ê°€',
                max: 5,
                baseCost: 300,
                costMult: 1.65,
                apply: (lv) => {
                    game.stormSuppress = Math.min(0.65, lv * 0.14); // í™•ë¥  ê°ì†Œìœ¨
                }
            },
            companion: {
                name: 'ğŸ›¸ ë‚˜ë…¸ ê³µìƒì²´',
                desc: 'ì£¼ë³€ DNA ìˆ˜ì§‘ ë° ì  ê³µê²© ì§€ì›',
                max: 3,
                baseCost: 500,
                costMult: 2.0,
                apply: (lv) => {
                    player.companionCount = lv;
                }
            }
        };

        function getUpgradeLevel(id) {
            return (game.persistent?.upgrades?.[id] || 0);
        }

        function getUpgradeCost(id) {
            const def = labUpgradeDefs[id];
            const lv = getUpgradeLevel(id);
            return Math.floor(def.baseCost * Math.pow(def.costMult, lv));
        }

        function applyPersistentUpgrades() {
            // ê¸°ë³¸ê°’
            game.xpBonusMult = 1;
            game.healBonusMult = 1;
            game.alertGainMult = 1;
            game.stormSuppress = 0;

            const ups = game.persistent?.upgrades || {};
            Object.keys(labUpgradeDefs).forEach(id => {
                const lv = Math.min(labUpgradeDefs[id].max, ups[id] || 0);
                labUpgradeDefs[id].apply(lv);
            });
        }

        function renderLab() {
            document.getElementById('labRp').textContent = game.researchPoints;
            document.getElementById('labDna').textContent = game.dnaCollected;
            document.getElementById('labAlert').textContent = Math.floor(game.immuneAlert) + '%';

            const container = document.getElementById('labUpgrades');
            container.innerHTML = '';

            Object.entries(labUpgradeDefs).forEach(([id, def]) => {
                const lv = getUpgradeLevel(id);
                const cost = getUpgradeCost(id);
                const canBuy = game.researchPoints >= cost && lv < def.max;

                const card = document.createElement('div');
                card.className = 'bg-black/40 rounded-2xl p-5 border border-cyan-900';
                card.innerHTML = `
                    <div class="flex items-start justify-between gap-3">
                        <div>
                            <div class="text-white font-black korean-font text-lg">${def.name}</div>
                            <div class="text-gray-300 text-sm korean-font mt-1">${def.desc}</div>
                        </div>
                        <div class="text-right">
                            <div class="text-xs text-gray-400 korean-font">ë ˆë²¨</div>
                            <div class="text-xl font-black text-cyan-300 game-font">${lv}/${def.max}</div>
                        </div>
                    </div>
                    <div class="mt-4 flex items-center justify-between">
                        <div class="text-gray-300 text-sm korean-font">ë¹„ìš©: <span class="text-cyan-300 font-bold">${cost}</span> ğŸ”¬</div>
                        <button class="px-4 py-2 rounded-lg korean-font font-bold ${canBuy ? 'bg-cyan-600 hover:bg-cyan-500 text-black' : 'bg-gray-700 text-gray-400 cursor-not-allowed'}" ${canBuy ? '' : 'disabled'}>
                            ${lv >= def.max ? 'MAX' : 'êµ¬ë§¤'}
                        </button>
                    </div>
                `;

                const btn = card.querySelector('button');
                btn.addEventListener('click', () => {
                    buyUpgrade(id);
                });

                container.appendChild(card);
            });
        }

        function toggleLab(forceOpen = null) {
            const screen = document.getElementById('labScreen');
            const isHidden = screen.classList.contains('hidden');
            const open = (forceOpen === null) ? isHidden : forceOpen;

            if (open) {
                game.paused = true;
                screen.classList.remove('hidden');
                renderLab();
            } else {
                screen.classList.add('hidden');
                game.paused = false;
            }
        }

        function buyUpgrade(id) {
            const def = labUpgradeDefs[id];
            const lv = getUpgradeLevel(id);
            if (lv >= def.max) return;
            const cost = getUpgradeCost(id);
            if (game.researchPoints < cost) return;

            game.researchPoints -= cost;
            game.persistent.upgrades[id] = lv + 1;
            savePersistent();

            // ì ìš©ì€ ì¦‰ì‹œ
            applyPersistentUpgrades();

            createFloatingText(player.x, player.y - 80, `${def.name} ì—…ê·¸ë ˆì´ë“œ!`, '#00ffff');
            showAIAnalysis(`ì—°êµ¬ ì„±ê³µ: ${def.name} (LV.${lv + 1})`);
            renderLab();
            updateUI();
        }

        document.getElementById('closeLab').addEventListener('click', () => toggleLab(false));

        // ====== í° ì—…ë°ì´íŠ¸ 2) í¬íƒˆ ê¸°ë°˜ ìŠ¤í…Œì´ì§€ ì „ì´(ìˆ˜ë™) ======
        function createPortalAt(x, y) {
            game.portal = {
                x, y,
                radius: 90,
                phase: Math.random() * Math.PI * 2,
                hintShown: false
            };
            createFloatingText(x, y - 120, 'ğŸŒ€ í¬íƒˆ ìƒì„±! (Gë¡œ ì§„ì…)', '#00ffcc');
            showAIAnalysis('ì „ì´ í¬íƒˆ í™œì„±í™”: Gë¡œ ë‹¤ìŒ ìŠ¤í…Œì´ì§€ë¡œ ì´ë™');
        }

        function tryEnterPortal() {
            if (!game.portal) return;
            const d = Math.hypot(player.x - game.portal.x, player.y - game.portal.y);
            if (d < player.size + game.portal.radius) {
                game.portal = null;
                nextStage();
            } else {
                createFloatingText(player.x, player.y - 60, 'í¬íƒˆì— ë” ê°€ê¹Œì´!', '#ffffff');
            }
        }

        // ====== í° ì—…ë°ì´íŠ¸ 3) ë©´ì—­ ê²½ë³´(Heat) ê¸°ë°˜ ë™ì  ë‚œì´ë„ ======
        function updateImmuneAlert() {
            if (game.lastInfected === undefined) {
                game.lastInfected = game.infected;
                game.lastKills = game.enemiesKilled;
            }

            const di = Math.max(0, game.infected - game.lastInfected);
            const dk = Math.max(0, game.enemiesKilled - game.lastKills);

            // ì€í ì½”íŒ… ì—…ê·¸ë ˆì´ë“œë¡œ ì¶•ì  ê°ì†Œ
            const gainMult = (game.alertGainMult || 1);

            // ê°ì—¼/í‚¬ì— ë”°ë¥¸ ê²½ë³´ ìƒìŠ¹
            game.immuneAlert += (di * 0.35 + dk * 1.2) * gainMult;

            // ì‹œê°„ì´ ì§€ë‚˜ë©´ ì¡°ê¸ˆ ê°ì†Œ
            const decay = game.immuneAlertDecay * (gameMode === 'challenge' ? 0.6 : 1);
            game.immuneAlert = Math.max(0, Math.min(100, game.immuneAlert - decay));

            game.lastInfected = game.infected;
            game.lastKills = game.enemiesKilled;
        }

        // ì„¸í¬ ìƒì„±
        function createCell() {
            const type = Math.random() < 0.6 ? 'normal' : Math.random() < 0.7 ? 'nutrient' : 'bonus';
            const baseSize = 10 + Math.random() * 25 + game.wave * 1.5;
            
            let cell = {
                x: Math.random() * game.worldSize,
                y: Math.random() * game.worldSize,
                size: baseSize,
                type,
                vx: (Math.random() - 0.5) * 2,
                vy: (Math.random() - 0.5) * 2,
                pulsePhase: Math.random() * Math.PI * 2,
                organelles: []
            };
            
            for (let i = 0; i < 3; i++) {
                cell.organelles.push({
                    rx: (Math.random() - 0.5) * 0.6,
                    ry: (Math.random() - 0.5) * 0.6,
                    size: 0.1 + Math.random() * 0.2,
                    phase: Math.random() * Math.PI * 2
                });
            }
            
            if (type === 'normal') {
                cell.color = { h: 350 + Math.random() * 20, s: 70, l: 45 };
            } else if (type === 'nutrient') {
                cell.color = { h: 45 + Math.random() * 15, s: 85, l: 55 };
            } else {
                cell.color = { h: 200 + Math.random() * 40, s: 80, l: 55 };
            }
            
            return cell;
        }
        
        // ì  ìƒì„±
        function createEnemy(type = 'whiteBlood') {
            const baseStats = {
                whiteBlood: { size: 40, speed: 1.5, hp: 50, icon: 'âšª', name: 'ë°±í˜ˆêµ¬', id: 'whiteblood' },
                antibody: { size: 18, speed: 4.5, hp: 15, icon: 'ğŸŸ¡', name: 'í•­ì²´', id: 'antibody' },
                macrophage: { size: 70, speed: 0.9, hp: 120, icon: 'ğŸ”´', name: 'ëŒ€ì‹ì„¸í¬', id: 'macrophage' },
                tcell: { size: 32, speed: 3.5, hp: 45, icon: 'ğŸŸ£', name: 'Tì„¸í¬', id: 'tcell' },
                nkcell: { size: 38, speed: 4, hp: 60, icon: 'ğŸ’œ', name: 'NKì„¸í¬', id: 'nkcell' }
            };
            
            const stats = baseStats[type];
            const isElite = Math.random() < 0.1 + (gameMode === 'challenge' ? 0.1 : 0); // 10% í™•ë¥ ë¡œ ì—˜ë¦¬íŠ¸
            
            // ë„ê° í•´ê¸ˆ
            const immuneCell = scienceData.immuneCells.find(c => c.id === stats.id);
            if (immuneCell && !immuneCell.unlocked) {
                immuneCell.unlocked = true;
                showAIAnalysis(`ë©´ì—­ ì„¸í¬ ë°œê²¬: ${immuneCell.name}`);
            }
            
            // í”Œë ˆì´ì–´ì—ê²Œì„œ ë©€ë¦¬ ìŠ¤í°
            let x, y;
            do {
                x = Math.random() * game.worldSize;
                y = Math.random() * game.worldSize;
            } while (Math.hypot(x - player.x, y - player.y) < 400);
            
            const waveMult = 1 + game.wave * 0.15;
            let hp = stats.hp * waveMult;
            let speed = (stats.speed + game.wave * 0.08) * difficulty.enemySpeedMult;
            let size = stats.size + game.wave * 2;

            if (isElite) {
                hp *= 2.5;
                speed *= 1.2;
                size *= 1.3;
            }

            return {
                x, y,
                size: size,
                speed: speed,
                type,
                hp: hp,
                maxHp: hp,
                icon: stats.icon,
                name: (isElite ? 'ì—˜ë¦¬íŠ¸ ' : '') + stats.name,
                angle: Math.random() * Math.PI * 2,
                wobble: Math.random() * Math.PI * 2,
                aiState: 'patrol',
                aiTimer: 0,
                attackCooldown: 0,
                isElite: isElite
            };
        }
        
        // ë¯¸ì‚¬ì¼ ìƒì„± (ë„ì „ ëª¨ë“œ)
        function createMissile(x, y) {
            missiles.push({
                x, y,
                speed: 3 + game.wave * 0.2,
                angle: Math.atan2(player.y - y, player.x - x),
                life: 300,
                trail: []
            });
        }
        
        // ë…ì„± ì§€ì—­ ìƒì„±
        function createToxicZone() {
            toxicZones.push({
                x: Math.random() * game.worldSize,
                y: Math.random() * game.worldSize,
                radius: 100 + Math.random() * 150,
                pulsePhase: Math.random() * Math.PI * 2
            });
        }
        
        // DNA í”½ì—… ìƒì„±
        function createDNAPickup(x, y) {
            dnaPickups.push({
                x: x + (Math.random() - 0.5) * 30,
                y: y + (Math.random() - 0.5) * 30,
                bobPhase: Math.random() * Math.PI * 2,
                life: 300
            });
        }
        
        // íŒŒì›Œì—… ìƒì„±
        function createPowerup() {
            const types = ['invincible', 'xpBoost', 'heal', 'research'];
            const type = types[Math.floor(Math.random() * types.length)];
            
            const colors = {
                invincible: { h: 60, s: 100, l: 60, icon: 'â­' },
                xpBoost: { h: 280, s: 80, l: 60, icon: 'âœ¨' },
                heal: { h: 0, s: 80, l: 55, icon: 'â¤ï¸' },
                research: { h: 180, s: 90, l: 50, icon: 'ğŸ”¬' }
            };
            
            return {
                x: Math.random() * game.worldSize,
                y: Math.random() * game.worldSize,
                type,
                color: colors[type],
                size: 25,
                bobPhase: Math.random() * Math.PI * 2
            };
        }
        
        // ë°°ê²½ ìš”ì†Œ ìƒì„±
        function createBackgroundElements() {
            backgroundElements = [];
            for (let i = 0; i < 300; i++) {
                backgroundElements.push({
                    x: Math.random() * game.worldSize,
                    y: Math.random() * game.worldSize,
                    size: 1 + Math.random() * 3,
                    twinkle: Math.random() * Math.PI * 2,
                    type: Math.random() < 0.3 ? 'molecule' : 'particle'
                });
            }
        }
        
        // íŒŒí‹°í´ ìƒì„±
        function createParticles(x, y, color, count, speed = 8) {
            for (let i = 0; i < count; i++) {
                const angle = (Math.PI * 2 / count) * i + Math.random() * 0.5;
                particles.push({
                    x, y,
                    vx: Math.cos(angle) * speed * (0.5 + Math.random()),
                    vy: Math.sin(angle) * speed * (0.5 + Math.random()),
                    size: 3 + Math.random() * 6,
                    color,
                    life: 40 + Math.random() * 20
                });
            }
        }
        
        // í”Œë¡œíŒ… í…ìŠ¤íŠ¸
        function createFloatingText(x, y, text, color) {
            floatingTexts.push({ x, y, text, color, life: 60, vy: -2 });
        }
        
        // ê²Œì„ ì´ˆê¸°í™”
        function initGame() {
            difficulty = difficultySettings[gameMode];

            // ì €ì¥ëœ ì—°êµ¬ ì—…ê·¸ë ˆì´ë“œ ë¡œë“œ
            loadPersistent();

            player.x = game.worldSize / 2;
            player.y = game.worldSize / 2;
            player.size = 25;
            player.level = 1;
            player.xp = 0;
            player.xpToLevel = 100;
            player.hp = 100;
            player.maxHp = 100;
            player.dashCooldown = 0;
            player.speedMult = 1;
            player.absorbMult = 1;
            player.defenseMult = 0;
            player.regen = 0;
            player.dashCooldownMult = 1;
            player.splitlings = [];
            player.companions = [];
            player.companionCount = 0;
            player.companionTimer = 0;
            player.isHidden = false;
            player.hostCell = null;
            player.color = { h: 280, s: 80, l: 55 };
            Object.keys(player.skills).forEach(k => {
                player.skills[k].cooldown = 0;
                player.skills[k].active = false;
            });
            player.skills.magnet.maxCooldown = difficulty.magnetCooldown;
            Object.keys(player.powerups).forEach(k => player.powerups[k] = 0);
            
            game.infected = 0;
            game.enemiesKilled = 0;
            game.startTime = Date.now();
            game.zoom = 1;
            game.wave = 1;
            game.waveTimer = 0;
            game.combo = 0;
            game.maxCombo = 0;
            game.researchPoints = 0;
            game.dnaCollected = 0;
            game.quizCorrect = 0;
            game.quizTotal = 0;
            game.tipTimer = 0;
            game.learnedFacts = [];
            game.stage = 1; // ìŠ¤í…Œì´ì§€ ì´ˆê¸°í™”
            game.bossActive = false;
            game.boss = null;
            game.portal = null;
            game.immuneAlert = 0;
            game.lastInfected = 0;
            game.lastKills = 0;
            game.stormActive = false;
            game.stormTimer = 0;
            game.stormCooldown = 0;
            game.feverTimer = 0;
            game.feverActive = false;
            document.getElementById('bossHpContainer').classList.add('hidden');
            
            // ìŠ¤í…Œì´ì§€ UI ì´ˆê¸°í™”
            document.getElementById('stageName').textContent = game.stageData[0].name;
            document.getElementById('stageDesc').textContent = game.stageData[0].desc;
            
            cells = [];
            enemies = [];
            particles = [];
            powerups = [];
            floatingTexts = [];
            dnaPickups = [];
            missiles = [];
            toxicZones = [];
            stormProjectiles = [];
            
            // ë„ê° ì´ˆê¸°í™”
            scienceData.viruses.forEach((v, i) => v.unlocked = i === 0);
            scienceData.immuneCells.forEach((c, i) => c.unlocked = i === 0);
            scienceData.aiConcepts.forEach((a, i) => { a.unlocked = i === 0; a.learned = i === 0 ? 100 : 0; });
            
            for (let i = 0; i < 200; i++) cells.push(createCell());
            
            const enemyCount = gameMode === 'challenge' ? 8 : 3;
            for (let i = 0; i < enemyCount; i++) enemies.push(createEnemy('whiteBlood'));
            if (gameMode === 'challenge') {
                for (let i = 0; i < 3; i++) enemies.push(createEnemy('antibody'));
            }
            
            for (let i = 0; i < 5; i++) powerups.push(createPowerup());
            
            // ë…ì„± ì§€ì—­ ìƒì„±
            for (let i = 0; i < difficulty.toxicZones; i++) {
                createToxicZone();
            }
            
            player.tentacles = [];
            for (let i = 0; i < 12; i++) {
                player.tentacles.push({
                    angle: (Math.PI * 2 / 12) * i,
                    length: 1,
                    wave: Math.random() * Math.PI * 2,
                    thickness: 0.5 + Math.random() * 0.5
                });
            }
            
            createBackgroundElements();
            
            // ì˜êµ¬ ì—…ê·¸ë ˆì´ë“œ ì ìš© (ì´ˆê¸° ìŠ¤íƒ¯/ë©€í‹°í”Œë¼ì´ì–´)
            applyPersistentUpgrades();

            // UI ì—…ë°ì´íŠ¸
            const badge = document.getElementById('difficultyBadge');
            // ëª¨ë“œ ë³€ê²½ ì‹œ ê²½ê³  í…Œë‘ë¦¬ ì´ˆê¸°í™”
            document.getElementById('leftPanel').classList.remove('warning-border');
            document.getElementById('challengeOverlay').classList.add('hidden');

            if (gameMode === 'learn') {
                badge.textContent = 'ğŸ“š í•™ìŠµ';
                badge.className = 'px-3 py-1 rounded-full text-xs font-bold korean-font bg-green-600';
            } else if (gameMode === 'normal') {
                badge.textContent = 'ğŸ® ì¼ë°˜';
                badge.className = 'px-3 py-1 rounded-full text-xs font-bold korean-font bg-blue-600';
            } else {
                badge.textContent = 'ğŸ’€ ë„ì „';
                badge.className = 'px-3 py-1 rounded-full text-xs font-bold korean-font bg-red-600 animate-pulse';
                document.getElementById('challengeOverlay').classList.remove('hidden');
                document.getElementById('leftPanel').classList.add('warning-border');
            }
            
            setTimeout(showScienceTip, 3000);
        }
        
        // ì§„í™” ì„ íƒ
        function showEvolutionScreen() {
            game.paused = true;
            document.getElementById('evolutionScreen').classList.remove('hidden');
            
            // ë„ì „ ëª¨ë“œ ê²½ê³ 
            if (gameMode === 'challenge') {
                document.getElementById('evolutionWarning').textContent = 'âš ï¸ í¬ê¸° ì¦ê°€ ì‹œ ì†ë„ê°€ í¬ê²Œ ê°ì†Œí•©ë‹ˆë‹¤!';
            } else if (gameMode === 'normal') {
                document.getElementById('evolutionWarning').textContent = 'ğŸ’¡ í¬ê¸°ê°€ ì»¤ì§€ë©´ ì•½ê°„ ëŠë ¤ì§‘ë‹ˆë‹¤';
            } else {
                document.getElementById('evolutionWarning').textContent = '';
            }
            
            const container = document.getElementById('evolutionChoices');
            container.innerHTML = '';
            
            const shuffled = [...evolutionOptions].sort(() => Math.random() - 0.5);
            const choices = shuffled.slice(0, 3);
            
            choices.forEach(opt => {
                const card = document.createElement('div');
                card.className = `ui-panel rounded-2xl p-8 w-64 bg-gradient-to-br ${opt.color} cursor-pointer hover:scale-105 transition`;
                card.innerHTML = `
                    <div class="text-6xl mb-4">${opt.icon}</div>
                    <div class="text-2xl font-black text-white mb-2 korean-font">${opt.name}</div>
                    <div class="text-gray-200 mb-4 korean-font">${opt.desc}</div>
                    <div class="text-sm text-white/70 korean-font border-t border-white/20 pt-3">ğŸ’¡ ${opt.fact}</div>
                `;
                card.addEventListener('click', () => {
                    opt.apply();
                    document.getElementById('evolutionScreen').classList.add('hidden');
                    game.paused = false;
                    createParticles(player.x, player.y, 'rgba(255, 255, 0, 0.8)', 30, 12);
                    game.cameraShake = 10;
                    
                    // ë°”ì´ëŸ¬ìŠ¤ ë„ê° í•´ê¸ˆ
                    const nextVirus = scienceData.viruses.find(v => !v.unlocked);
                    if (nextVirus && Math.random() < 0.3) {
                        nextVirus.unlocked = true;
                        showAIAnalysis(`ìƒˆ ë°”ì´ëŸ¬ìŠ¤ ë³€ì´ ë°œê²¬: ${nextVirus.name}`);
                    }
                });
                container.appendChild(card);
            });
        }
        
        // ë ˆë²¨ì—…
        function levelUp() {
            SoundManager.play('levelUp');
            player.level++;
            player.xp -= player.xpToLevel;
            player.xpToLevel = Math.floor(player.xpToLevel * 1.5);
            player.size += 2;
            
            createParticles(player.x, player.y, 'rgba(138, 43, 226, 0.8)', 40, 15);
            game.cameraShake = 15;
            
            showEvolutionScreen();
            
            // í•™ìŠµ ëª¨ë“œì—ì„œ í€´ì¦ˆ ì¶œì œ
            if (gameMode === 'learn' && player.level % 2 === 0) {
                setTimeout(showQuiz, 500);
            } else if (gameMode === 'challenge' && player.level % 3 === 0) {
                setTimeout(showQuiz, 500);
            }
        }
        
        // ì›¨ì´ë¸Œ ì§„í–‰
        function advanceWave() {
            game.wave++;
            game.waveTimer = 0;

            // ìŠ¤í…Œì´ì§€ë³„ ë³´ìŠ¤ ë“±ì¥ (5ì›¨ì´ë¸Œ ë§ˆë‹¤)
            if (game.wave % 5 === 0) {
                spawnBoss();
                return;
            }
            
            const spawnCount = Math.ceil(difficulty.enemySpawnMult * (1 + game.wave * 0.3));
            
            for (let i = 0; i < spawnCount; i++) {
                enemies.push(createEnemy('whiteBlood'));
            }
            
            if (game.wave % 2 === 0) {
                for (let i = 0; i < Math.ceil(spawnCount * 0.5); i++) {
                    enemies.push(createEnemy('antibody'));
                }
            }
            if (game.wave % 3 === 0) {
                enemies.push(createEnemy('macrophage'));
            }
            if (game.wave >= 4) {
                enemies.push(createEnemy('tcell'));
            }
            if (game.wave >= 6 && gameMode === 'challenge') {
                enemies.push(createEnemy('nkcell'));
            }
            
            // ë„ì „ ëª¨ë“œì—ì„œ ë¯¸ì‚¬ì¼ ë°œì‚¬
            if (difficulty.missiles && game.wave >= 3) {
                for (let i = 0; i < game.wave - 2; i++) {
                    const edge = Math.floor(Math.random() * 4);
                    let x, y;
                    if (edge === 0) { x = 0; y = Math.random() * game.worldSize; }
                    else if (edge === 1) { x = game.worldSize; y = Math.random() * game.worldSize; }
                    else if (edge === 2) { x = Math.random() * game.worldSize; y = 0; }
                    else { x = Math.random() * game.worldSize; y = game.worldSize; }
                    createMissile(x, y);
                }
            }
            
            // ì¶”ê°€ ë…ì„± ì§€ì—­
            if (gameMode === 'challenge' && game.wave % 2 === 0) {
                createToxicZone();
            }
            
            showAIAnalysis(`ì›¨ì´ë¸Œ ${game.wave}: ë©´ì—­ ë°˜ì‘ ê°•í™”!`);
        }

        // ìŠ¤í…Œì´ì§€ ê¸°ë¯¹ ì ìš©
        function clampToWorld(obj, radius = 0) {
            // ì›”ë“œ ê²½ê³„ ì•ˆìœ¼ë¡œ ê°•ì œ (í˜ˆë¥˜/ë°”ëŒ ë“± ìŠ¤í…Œì´ì§€ ê¸°ë¯¹ìœ¼ë¡œ ë°€ë ¤ë‚˜ê°€ëŠ” ë¬¸ì œ ë°©ì§€)
            obj.x = Math.max(radius, Math.min(game.worldSize - radius, obj.x));
            obj.y = Math.max(radius, Math.min(game.worldSize - radius, obj.y));
        }

        function applyStageMechanics() {
            const currentStage = game.stageData[game.stage - 1] || game.stageData[0];
            
            // 1. í˜ˆê´€: í˜ˆë¥˜ (í”Œë ˆì´ì–´ì™€ ëª¨ë“  ë¬¼ì²´ë¥¼ í•œìª½ìœ¼ë¡œ ë°ˆ)
            if (game.stage === 1) {
                const force = 0.3;
                player.x += force;
                cells.forEach(c => c.x += force * 0.8);
                enemies.forEach(e => e.x += force * 0.5);
                
                // íŒŒí‹°í´ë¡œ íë¦„ í‘œí˜„
                if (Math.random() < 0.1) {
                    createParticles(0, Math.random() * game.worldSize, 'rgba(255,100,100,0.2)', 1, 10);
                }
            }
            
            // 2. í: ê¸°ì¹¨ (ì£¼ê¸°ì ìœ¼ë¡œ ê°•í•œ ë°”ëŒ)
            else if (game.stage === 2) {
                if (Math.random() < 0.005) { // ê¸°ì¹¨ ë°œìƒ
                    createFloatingText(player.x, player.y - 100, "âš ï¸ ê¸°ì¹¨ ë°œìƒ! âš ï¸", "#ffffff");
                    game.cameraShake = 20;
                    const windDir = Math.random() * Math.PI * 2;
                    const windForce = 15;
                    
                    // í”Œë ˆì´ì–´ ë°€ì¹˜ê¸°
                    player.x += Math.cos(windDir) * windForce;
                    player.y += Math.sin(windDir) * windForce;
                    
                    // ëª¨ë“  ê°ì²´ ë°€ì¹˜ê¸°
                    const objects = [...cells, ...enemies];
                    objects.forEach(o => {
                        o.x += Math.cos(windDir) * windForce * 1.5;
                        o.y += Math.sin(windDir) * windForce * 1.5;
                    });
                }
            }
            
            // 3. ì‹ ê²½ê³„: ì „ê¸° ì¶©ê²© (ëœë¤í•œ ìœ„ì¹˜ì— ì „ê¸°ì¥ ìƒì„±)
            else if (game.stage === 3) {
                if (Math.random() < 0.02) {
                    const x = player.x + (Math.random() - 0.5) * 1000;
                    const y = player.y + (Math.random() - 0.5) * 1000;
                    stormProjectiles.push({
                        x: x, y: y,
                        vx: 0, vy: 0,
                        life: 60,
                        isStatic: true // ì›€ì§ì´ì§€ ì•ŠëŠ” ì „ê¸°ì¥
                    });
                }
            }

            // ìŠ¤í…Œì´ì§€ ê¸°ë¯¹ ì ìš© í›„: ì›”ë“œ ë°–ìœ¼ë¡œ ë‚˜ê°€ëŠ” ë¬¸ì œë¥¼ ì¦‰ì‹œ ë³´ì •
            clampToWorld(player, player.size);
            cells.forEach(c => clampToWorld(c, c.size));
            enemies.forEach(e => clampToWorld(e, e.size));
            if (game.bossActive && game.boss) clampToWorld(game.boss, game.boss.size);
            if (game.portal) clampToWorld(game.portal, game.portal.radius);
        }

        // ë³´ìŠ¤ ìƒì„±
        function spawnBoss() {
            game.bossActive = true;
            createFloatingText(player.x, player.y - 100, "âš ï¸ ë³´ìŠ¤ ì¶œí˜„! âš ï¸", "#ff0000");
            game.cameraShake = 30;
            showAIAnalysis("ê±°ëŒ€ ë©´ì—­ ì„¸í¬ ê°ì§€! ì£¼ì˜í•˜ì‹­ì‹œì˜¤.");
            
            // ê¸°ì¡´ ì ë“¤ ì œê±° (ë³´ìŠ¤ì „ì— ì§‘ì¤‘)
            enemies = [];

            let bossType = 'giant';
            let bossName = 'ê±°ëŒ€ ëŒ€ì‹ì„¸í¬';
            let bossHp = 2000 * game.stage;
            
            if (game.stage === 2) { bossType = 'swarm'; bossName = 'í•­ì²´ êµ°ì§‘ì²´'; bossHp = 1500 * game.stage; }
            if (game.stage === 3) { bossType = 'cyber'; bossName = 'ì‹ ê²½ ë°©ì–´ ì‹œìŠ¤í…œ'; bossHp = 3000 * game.stage; }

            game.boss = {
                x: player.x + 800, // í”Œë ˆì´ì–´ ê·¼ì²˜ ìŠ¤í°
                y: player.y,
                size: 150,
                type: bossType,
                name: bossName,
                hp: bossHp,
                maxHp: bossHp,
                angle: 0,
                speed: 2 + game.stage * 0.5,
                attackTimer: 0,
                phase: 1
            };
            
            document.getElementById('bossHpContainer').classList.remove('hidden');
            document.getElementById('bossName').textContent = bossName;
            updateBossUI();
        }

        function updateBoss() {
            if (!game.boss) return;
            const b = game.boss;
            const dist = Math.hypot(player.x - b.x, player.y - b.y);
            const angle = Math.atan2(player.y - b.y, player.x - b.x);

            // ì´ë™
            b.x += Math.cos(angle) * b.speed * (b.phase === 2 ? 1.5 : 1);
            b.y += Math.sin(angle) * b.speed * (b.phase === 2 ? 1.5 : 1);
            
            // ê³µê²© íŒ¨í„´
            b.attackTimer++;
            
            // ë³´ìŠ¤ íƒ€ì…ë³„ íŒ¨í„´
            if (b.type === 'giant') {
                // 1. ì¡¸ê°œ ì†Œí™˜
                if (b.attackTimer % 300 === 0) {
                    for(let i=0; i<3; i++) {
                        let e = createEnemy('whiteBlood');
                        e.x = b.x; e.y = b.y;
                        enemies.push(e);
                    }
                }
                // 2. ëŒì§„
                if (b.attackTimer % 400 === 200) {
                    b.speed = 8; // ëŒì§„
                    setTimeout(() => b.speed = 2, 1000);
                }
            } else if (b.type === 'swarm') {
                // íƒ„ë§‰ ë°œì‚¬
                if (b.attackTimer % 100 === 0) {
                    for(let i=0; i<8; i++) {
                        const shotAngle = (Math.PI * 2 / 8) * i + b.angle;
                        createMissile(b.x, b.y); // ìœ ë„ ë¯¸ì‚¬ì¼ ì¬í™œìš©
                    }
                }
            } else if (b.type === 'cyber') {
                // ì „ê¸°ì¥ ìƒì„±
                if (b.attackTimer % 60 === 0) {
                    stormProjectiles.push({
                        x: player.x, y: player.y, // í”Œë ˆì´ì–´ ìœ„ì¹˜ì— ìƒì„±
                        vx: 0, vy: 0,
                        life: 120,
                        isStatic: true
                    });
                }
            }

            // í”Œë ˆì´ì–´ ì¶©ëŒ
            if (dist < player.size + b.size) {
                 if (!player.skills.shield.active && player.powerups.invincible <= 0) {
                    player.hp -= 1; // ì ‘ì´‰ ì‹œ ì§€ì† í”¼í•´
                    game.cameraShake = 2;
                 }
            }
            
            // í”Œë ˆì´ì–´ ê³µê²© (ì¶©ëŒì´ ì•„ë‹ˆë¼ í´ë¦­ ìŠ¤í‚¬ ë“±ìœ¼ë¡œ ê³µê²©í•œë‹¤ê³  ê°€ì •í•˜ì§€ë§Œ, ì—¬ê¸°ì„  ëª¸ë°•ìœ¼ë¡œ ê³µê²©)
            // ë°”ì´ëŸ¬ìŠ¤ ê²Œì„ íŠ¹ì„±ìƒ ëª¸ë°•ì´ë‚˜ ìŠ¤í‚¬ë¡œ ë°ë¯¸ì§€
            // ë³´ìŠ¤ëŠ” í”Œë ˆì´ì–´ í¬ê¸°ì— ë¹„ë¡€í•œ í”¼í•´ë¥¼ ì¡°ê¸ˆì”© ì…ìŒ (ì§€ì† ì‹¸ì›€)
            if (dist < player.size + b.size) {
                 b.hp -= player.size * 0.05 * player.absorbMult; // ë¯¸ì„¸í•œ í”¼í•´
            }
            
            // ìŠ¤í‚¬ í”¼í•´ (ë…ì†Œ, ë¶„ì—´ ë“±)
            if (player.skills.toxin.active) {
                 const toxinDist = Math.hypot(player.x - b.x, player.y - b.y);
                 if (toxinDist < player.size * 2.5 + b.size) {
                     b.hp -= 2 * player.absorbMult; // ë…ì†Œ í”¼í•´
                     createParticles(b.x + (Math.random()-0.5)*b.size, b.y + (Math.random()-0.5)*b.size, '#00ff00', 1);
                 }
            }

            // ë³´ìŠ¤ ì²˜ì¹˜
            if (b.hp <= 0) {
                killBoss();
            }
            
            updateBossUI();
        }

        function updateBossUI() {
            if(!game.boss) return;
            const pct = Math.max(0, (game.boss.hp / game.boss.maxHp) * 100);
            document.getElementById('bossHpBar').style.width = pct + '%';
            document.getElementById('bossHpText').textContent = Math.floor(pct) + '%';
        }

        function killBoss() {
            game.bossActive = false;
            game.boss = null;
            document.getElementById('bossHpContainer').classList.add('hidden');
            
            // ë³´ìƒ
            createParticles(player.x, player.y, '#ffd700', 100);
            createFloatingText(player.x, player.y, "BOSS CLEARED!", "#ffd700");
            game.researchPoints += 500;
            player.xp += 1000;
            
            // ì „ì´ (ìŠ¤í…Œì´ì§€ ì´ë™)
            setTimeout(nextStage, 2000);
        }

        function nextStage() {
            if (game.stage >= 3) {
                // ì—”ë”© ë˜ëŠ” ë¬´í•œ ëª¨ë“œ
                createFloatingText(player.x, player.y, "ëª¨ë“  ê¸°ê´€ ì •ë³µ ì™„ë£Œ! ë¬´í•œ ëª¨ë“œ ì§„ì…", "#ffffff");
                game.stage = 1; // ë‹¤ì‹œ ë£¨í”„ ëŒê±°ë‚˜ ì—”ë”© ì²˜ë¦¬
            } else {
                game.stage++;
            }
            
            const stageInfo = game.stageData[game.stage - 1];
            
            // ìŠ¤í…Œì´ì§€ ì „í™˜ ì—°ì¶œ
            game.paused = true;
            
            // ì˜¤ë²„ë ˆì´ ìƒì„±í•´ì„œ ë³´ì—¬ì£¼ê¸°
            const overlay = document.createElement('div');
            overlay.className = 'fixed inset-0 bg-black z-50 flex items-center justify-center transition-opacity duration-1000';
            overlay.innerHTML = `
                <div class="text-center">
                    <div class="text-6xl mb-4">ğŸ§¬ ì „ì´ ì„±ê³µ</div>
                    <div class="text-4xl font-bold text-cyan-400 mb-2">${stageInfo.name} ì§„ì…</div>
                    <div class="text-xl text-gray-400">${stageInfo.desc}</div>
                </div>
            `;
            document.body.appendChild(overlay);
            
            setTimeout(() => {
                // ë°ì´í„° ì´ˆê¸°í™” ë° ì´ë™
                player.x = game.worldSize / 2;
                player.y = game.worldSize / 2;
                cells = [];
                enemies = [];
                for(let i=0; i<200; i++) cells.push(createCell());
                
                // ìŠ¤í…Œì´ì§€ UI ì—…ë°ì´íŠ¸
                document.getElementById('stageName').textContent = stageInfo.name;
                document.getElementById('stageDesc').textContent = stageInfo.desc;
                
                game.wave = (game.stage - 1) * 5 + 1; // ì›¨ì´ë¸Œ ì¡°ì •
                
                game.paused = false;
                
                // ì˜¤ë²„ë ˆì´ ì œê±°
                overlay.style.opacity = '0';
                setTimeout(() => overlay.remove(), 1000);
                
            }, 3000);
        }
        
        // í¬ê¸°ì— ë”°ë¥¸ ì†ë„ í˜ë„í‹° ê³„ì‚°
        function getSizeSpeedPenalty() {
            const sizeOver = Math.max(0, player.size - 30);
            return Math.max(0.3, 1 - sizeOver * difficulty.sizeSpeedPenalty);
        }
        
        // ì—…ë°ì´íŠ¸
        function update() {
            if (!game.running || game.paused) return;
            
            // ì¤Œ ì¡°ì • (ê³¼í•™ì  ìŠ¤ì¼€ì¼ë§: í¬ê¸°ê°€ ì»¤ì§ˆìˆ˜ë¡ ë¡œê·¸í•¨ìˆ˜ì ìœ¼ë¡œ ì¤Œì•„ì›ƒ)
            // ê¸°ì¡´ ì„ í˜• ì¤Œë³´ë‹¤ ë” ë„“ê²Œ ë³´ì—¬ì£¼ì–´ í™”ë©´ ê½‰ ì°¸ ë°©ì§€
            game.targetZoom = Math.max(0.15, Math.min(1.2, 300 / (player.size * 2 + 200)));
            game.zoom += (game.targetZoom - game.zoom) * 0.03;

            // ì ë³µ ìƒíƒœ ë¡œì§
            if (player.isHidden && player.hostCell) {
                player.x = player.hostCell.x;
                player.y = player.hostCell.y;
                player.hp = Math.min(player.maxHp, player.hp + 0.5); // ë¹ ë¥¸ íšŒë³µ
                // ìˆ™ì£¼ëŠ” ì„œì„œíˆ ì‘ì•„ì§ (ë°”ì´ëŸ¬ìŠ¤ ìƒì‚° ì†Œëª¨)
                player.hostCell.size -= 0.05;
                if (player.hostCell.size < player.size * 0.5) {
                    toggleHide(); // ë„ˆë¬´ ì‘ì•„ì§€ë©´ í„°ì§
                }
            }
            
            // ë°œì—´(Fever) ì‹œìŠ¤í…œ
            if (!game.bossActive) { // ë³´ìŠ¤ì „ì—” ë°©í•´ ì•ˆë˜ê²Œ
                game.feverTimer++;
                // 60ì´ˆë§ˆë‹¤ 10ì´ˆê°„ ë°œì—´
                if (game.feverTimer > 3600 && !game.feverActive) {
                    game.feverActive = true;
                    game.feverTimer = 0;
                    createFloatingText(player.x, player.y - 100, "ğŸŒ¡ï¸ ë©´ì—­ ë°˜ì‘: ë°œì—´! ğŸŒ¡ï¸", "#ff5500");
                    showAIAnalysis("ê³ ì—´ ê°ì§€: ë‹¨ë°±ì§ˆ ë³€ì„± ìœ„í—˜! í™œë™ ì£¼ì˜.");
                } else if (game.feverActive && game.feverTimer > 600) {
                    game.feverActive = false;
                    game.feverTimer = 0;
                    createFloatingText(player.x, player.y - 100, "ì²´ì˜¨ ì •ìƒí™”", "#00ff00");
                }

                if (game.feverActive) {
                    // ë°œì—´ ì‹œ ì§€ì† í”¼í•´ (ê°‘ì˜·í˜•ì€ ë©´ì—­)
                    if (player.strain !== 'tank' && !player.isHidden) {
                        player.hp -= 0.1; 
                    }
                }
            }
            
            // ì›¨ì´ë¸Œ íƒ€ì´ë¨¸ (ë³´ìŠ¤ì „ ì•„ë‹ ë•Œë§Œ)
            if (!game.bossActive) {
                game.waveTimer++;
                if (game.waveTimer >= difficulty.waveSpeed) advanceWave();
            }

            // ìŠ¤í…Œì´ì§€ ê¸°ë¯¹ íš¨ê³¼
            applyStageMechanics();
            
            // ë³´ìŠ¤ ì—…ë°ì´íŠ¸
            if (game.bossActive && game.boss) {
                updateBoss();
            }
            
            // ì½¤ë³´ íƒ€ì´ë¨¸
            if (game.comboTimer > 0) {
                game.comboTimer--;
                if (game.comboTimer <= 0) game.combo = 0;
            }
            
            // íŒ íƒ€ì´ë¨¸
            game.tipTimer++;
            if (game.tipTimer >= 1200) {
                game.tipTimer = 0;
                if (Math.random() < 0.5) showScienceTip();
            }
            
            // ë¯¸ì…˜ ì‹œìŠ¤í…œ
            if (!game.mission && Math.random() < 0.002 && game.wave > 1) {
                generateMission();
            }
            if (game.mission) {
                game.mission.duration--;
                document.getElementById('missionTimer').textContent = Math.ceil(game.mission.duration / 60) + 's';
                document.getElementById('missionProgress').style.width = (game.mission.current / game.mission.target * 100) + '%';
                
                if (game.mission.duration <= 0) {
                    createFloatingText(player.x, player.y - 50, "ë¯¸ì…˜ ì‹¤íŒ¨...", "#ff4444");
                    game.mission = null;
                    document.getElementById('missionDisplay').classList.add('translate-x-full');
                } else if (game.mission.current >= game.mission.target) {
                    completeMission();
                }
            }

            // í•­ì²´ í­í’ ì´ë²¤íŠ¸ (ë¹ˆë„/ëŒ€ë¯¸ì§€ ë°¸ëŸ°ìŠ¤ ìˆ˜ì •)
            // - ë„ˆë¬´ ìì£¼ í„°ì§€ì§€ ì•Šë„ë¡ ì¿¨ë‹¤ìš´ ì¶”ê°€
            // - ë°œì‚¬ ë¹ˆë„/íƒ„ ì†ë„/íƒ„ ìˆ˜ë¥¼ ì¡°ì ˆ
            if (game.stormCooldown === undefined) game.stormCooldown = 0;
            if (game.stormCooldown > 0) game.stormCooldown--;

            // ëª¨ë“œë³„ ìŠ¤ì¼€ì¼
            const stormChanceBase = (gameMode === 'challenge') ? 0.00006 : (gameMode === 'normal' ? 0.00004 : 0.00002);
            const stormWaveScale = Math.min(3, game.wave / 6); // ì›¨ì´ë¸Œê°€ ì˜¬ë¼ê°€ë„ ê³¼ë„í•˜ê²Œ ì¦ê°€í•˜ì§€ ì•Šê²Œ ìº¡

            if (!game.stormActive && game.stormCooldown <= 0 && Math.random() < stormChanceBase * stormWaveScale) {
                game.stormActive = true;
                game.stormTimer = (gameMode === 'challenge') ? 480 : 420; // 8s / 7s
                game.stormCooldown = 2400; // 40ì´ˆ ì¿¨ë‹¤ìš´
                createFloatingText(player.x, player.y - 80, "âš ï¸ í•­ì²´ í­í’ ê²½ë³´! âš ï¸", "#ff0000");
                showAIAnalysis("ëŒ€ê·œëª¨ í•­ì²´ ë°˜ì‘ ê°ì§€! íšŒí”¼ ê¸°ë™ ê¶Œì¥.");
            }
            if (game.stormActive) {
                game.stormTimer--;

                // ë°œì‚¬ ê°„ê²© ì™„í™” (ì´ì „: 5í”„ë ˆì„ë§ˆë‹¤)
                const interval = (gameMode === 'challenge') ? 12 : 14;
                if (game.stormTimer % interval === 0) {
                    const angle = Math.random() * Math.PI * 2;
                    const dist = 650;
                    const sx = player.x + Math.cos(angle) * dist;
                    const sy = player.y + Math.sin(angle) * dist;
                    const targetX = player.x + (Math.random() - 0.5) * 240;
                    const targetY = player.y + (Math.random() - 0.5) * 240;
                    const shootAngle = Math.atan2(targetY - sy, targetX - sx);

                    const projectileSpeed = (gameMode === 'challenge') ? 7.2 : 6.2;
                    stormProjectiles.push({
                        x: sx, y: sy,
                        vx: Math.cos(shootAngle) * projectileSpeed,
                        vy: Math.sin(shootAngle) * projectileSpeed,
                        life: 160,
                        isStorm: true
                    });
                }

                if (game.stormTimer <= 0) {
                    game.stormActive = false;
                    createFloatingText(player.x, player.y - 80, "í­í’ ì¢…ë£Œ", "#00ff00");
                }
            }

            // íš¨ê³¼ ê°ì†Œ
            if (game.cameraShake > 0) game.cameraShake *= 0.9;
            
            // í˜•ì§ˆ ì¬ìƒ ë° ìŠ¤íƒ¯ ì ìš©
            const strain = player.strainStats[player.strain];
            const currentRegen = (player.regen + (player.strain === 'tank' ? 0.05 : 0));
            if (currentRegen > 0) {
                player.hp = Math.min(player.maxHp, player.hp + currentRegen * difficulty.healMult);
            }
            
            // ë…ì„± ì§€ì—­ í”¼í•´
            toxicZones.forEach(zone => {
                zone.pulsePhase += 0.02;
                const dist = Math.hypot(player.x - zone.x, player.y - zone.y);
                if (dist < zone.radius) {
                    player.hp -= 0.3 * difficulty.damageMult;
                }
            });
            
            // í”Œë ˆì´ì–´ ì´ë™
            let dx = 0, dy = 0;
            if (keys['KeyW'] || keys['ArrowUp']) dy -= 1;
            if (keys['KeyS'] || keys['ArrowDown']) dy += 1;
            if (keys['KeyA'] || keys['ArrowLeft']) dx -= 1;
            if (keys['KeyD'] || keys['ArrowRight']) dx += 1;
            
            if (dx !== 0 || dy !== 0) {
                const len = Math.sqrt(dx * dx + dy * dy);
                let speed = player.baseSpeed * player.speedMult * getSizeSpeedPenalty() * strain.speed;
                if (player.dashActive) speed *= 3;
                player.x += (dx / len) * speed;
                player.y += (dy / len) * speed;
            }
            
            player.x = Math.max(player.size, Math.min(game.worldSize - player.size, player.x));
            player.y = Math.max(player.size, Math.min(game.worldSize - player.size, player.y));
            
            // ì¿¨ë‹¤ìš´
            if (player.dashCooldown > 0) player.dashCooldown--;
            Object.values(player.skills).forEach(s => {
                if (s.cooldown > 0) s.cooldown--;
                if (s.duration > 0) {
                    s.duration--;
                    if (s.duration <= 0) s.active = false;
                }
            });
            Object.keys(player.powerups).forEach(k => {
                if (player.powerups[k] > 0) player.powerups[k]--;
            });
            
            // ì´‰ìˆ˜ ì—…ë°ì´íŠ¸
            player.tentacles.forEach(t => {
                t.wave += 0.12;
                t.length = 0.7 + Math.sin(t.wave) * 0.4;
            });
            
            // ë¶„ì‹  ì—…ë°ì´íŠ¸
            player.splitlings = player.splitlings.filter(s => {
                s.x += s.vx;
                s.y += s.vy;
                s.vx *= 0.95;
                s.vy *= 0.95;
                s.life--;
                
                cells.forEach((cell, i) => {
                    const dist = Math.hypot(s.x - cell.x, s.y - cell.y);
                    if (dist < s.size + cell.size && cell.size < player.size * 0.8) {
                        createParticles(cell.x, cell.y, `hsl(${cell.color.h}, 80%, 50%)`, 8);
                        cells.splice(i, 1);
                        cells.push(createCell());
                        player.xp += Math.floor(cell.size * 0.3 * difficulty.xpMult);
                        game.infected++;
                    }
                });
                
                return s.life > 0;
            });

            // ê³µìƒì²´ ì—…ë°ì´íŠ¸
            const desiredCompanions = player.companionCount || 0;
            if (player.companions.length < desiredCompanions) {
                player.companions.push({
                    angle: (Math.PI * 2 / desiredCompanions) * player.companions.length,
                    dist: 60 + player.size,
                    laserCooldown: 0
                });
            }
            // ìˆ˜ ì¤„ì´ê¸° (ì—…ê·¸ë ˆì´ë“œ ì´ˆê¸°í™” ë“±ì˜ ê²½ìš°)
            if (player.companions.length > desiredCompanions) {
                player.companions = player.companions.slice(0, desiredCompanions);
            }

            player.companions.forEach((comp, i) => {
                // ê³µì „ ë° ìì—°ìŠ¤ëŸ¬ìš´ ì¶”ì  (Lerp)
                comp.angle += 0.05;
                comp.dist = 60 + player.size; // í”Œë ˆì´ì–´ í¬ê¸°ì— ë§ì¶° ê±°ë¦¬ ì¡°ì ˆ
                const targetX = player.x + Math.cos(comp.angle) * comp.dist;
                const targetY = player.y + Math.sin(comp.angle) * comp.dist;
                
                // ê¸°ê³„ì ì¸ ê³ ì • ëŒ€ì‹  ë¶€ë“œëŸ¬ìš´ ë”°ë¼ì˜¤ê¸° (Lerp)
                if (!comp.x) { comp.x = targetX; comp.y = targetY; }
                comp.x += (targetX - comp.x) * 0.1;
                comp.y += (targetY - comp.y) * 0.1;
                
                const cx = comp.x;
                const cy = comp.y;

                if (comp.laserCooldown > 0) comp.laserCooldown--;

                // ìë™ DNA ìˆ˜ì§‘
                dnaPickups.forEach(dna => {
                    const d = Math.hypot(cx - dna.x, cy - dna.y);
                    if (d < 100) { // ìì„ íš¨ê³¼
                        dna.x += (cx - dna.x) * 0.1;
                        dna.y += (cy - dna.y) * 0.1;
                    }
                });

                // ì  ê³µê²© (ë ˆì´ì €)
                if (comp.laserCooldown <= 0) {
                    let closest = null;
                    let minDist = 300;
                    enemies.forEach(e => {
                        const d = Math.hypot(cx - e.x, cy - e.y);
                        if (d < minDist) {
                            minDist = d;
                            closest = e;
                        }
                    });

                    if (closest) {
                        comp.laserCooldown = 40;
                        closest.hp -= 10;
                        SoundManager.play('shoot');
                        // ë ˆì´ì € ì‹œê° íš¨ê³¼ëŠ” ë Œë”ë§ì—ì„œ ì²˜ë¦¬í•˜ê±°ë‚˜ ë³„ë„ ë°°ì—´ì— ë„£ì–´ì•¼ í•¨. 
                        // ê°„ë‹¨í•˜ê²Œ íŒŒí‹°í´ ìƒì„±ìœ¼ë¡œ ëŒ€ì²´
                        createParticles(closest.x, closest.y, '#00ffff', 5);
                        
                        // ë ˆì´ì € íŠ¸ë ˆì¼ (ì¼ì‹œì )
                        comp.targetX = closest.x;
                        comp.targetY = closest.y;
                        comp.fireFrame = 5; 
                    }
                }
                if (comp.fireFrame > 0) comp.fireFrame--;
            });
            
            // ì„¸í¬ ì—…ë°ì´íŠ¸
            cells.forEach((cell, index) => {
                if (cell.poisoned) {
                    cell.poisonTimer--;
                    cell.size -= 0.2;
                    if (cell.poisonTimer <= 0 || cell.size <= 5) {
                        let xpGain = Math.floor(cell.size * player.absorbMult * difficulty.xpMult);
                        player.xp += xpGain;
                        game.infected++;
                        game.researchPoints += 2;
                        createDNAPickup(cell.x, cell.y);
                        createParticles(cell.x, cell.y, 'rgba(0, 255, 0, 0.6)', 10);
                        cells.splice(index, 1);
                        cells.push(createCell());
                        return;
                    }
                }
                
                // ìì„ íš¨ê³¼ (ë„ˆí”„ë¨)
                if (player.skills.magnet.active || player.powerups.magnet > 0) {
                    if (cell.size < player.size * 0.7) { // ë” ì‘ì€ ì„¸í¬ë§Œ
                        const angle = Math.atan2(player.y - cell.y, player.x - cell.x);
                        const dist = Math.hypot(player.x - cell.x, player.y - cell.y);
                        if (dist < player.size * difficulty.magnetRange) {
                            const force = (1 - dist / (player.size * difficulty.magnetRange)) * difficulty.magnetForce;
                            cell.vx += Math.cos(angle) * force;
                            cell.vy += Math.sin(angle) * force;
                        }
                    }
                }
                
                cell.pulsePhase += 0.05;
                cell.x += cell.vx;
                cell.y += cell.vy;
                cell.vx *= 0.99;
                cell.vy *= 0.99;
                
                if (cell.x < cell.size || cell.x > game.worldSize - cell.size) cell.vx *= -1;
                if (cell.y < cell.size || cell.y > game.worldSize - cell.size) cell.vy *= -1;
                
                const dist = Math.hypot(player.x - cell.x, player.y - cell.y);
                if (dist < player.size + cell.size * 0.5) {
                    if (cell.size < player.size * 0.9) { // ìì‹ ë³´ë‹¤ ì‘ì€ ì„¸í¬ë§Œ
                        let xpGain = Math.floor(cell.size * player.absorbMult * difficulty.xpMult);
                        if (cell.type === 'nutrient') xpGain *= 2;
                        if (cell.type === 'bonus') xpGain *= 3;
                        
                        player.xp += xpGain;
                        player.size += cell.size * 0.02;
                        game.infected++;
                        game.researchPoints += 1;
                        game.combo++;
                        game.comboTimer = 120;
                        if (game.combo > game.maxCombo) game.maxCombo = game.combo;
                        
                        if (Math.random() < 0.2) createDNAPickup(cell.x, cell.y);
                        createParticles(cell.x, cell.y, `hsl(${cell.color.h}, 80%, 50%)`, 15);
                        createFloatingText(cell.x, cell.y, `+${xpGain}`, `hsl(${cell.color.h}, 100%, 70%)`);
                        SoundManager.play('collect');
                        
                        cells.splice(index, 1);
                        cells.push(createCell());
                        
                        if (player.xp >= player.xpToLevel) levelUp();
                    }
                }
            });
            
            // DNA í”½ì—… ì—…ë°ì´íŠ¸
            dnaPickups = dnaPickups.filter(dna => {
                dna.bobPhase += 0.1;
                dna.life--;
                
                const dist = Math.hypot(player.x - dna.x, player.y - dna.y);
                if (dist < player.size + 15) {
                    game.dnaCollected++;
                    game.researchPoints += 5;
                    createFloatingText(dna.x, dna.y, '+5 ğŸ”¬', '#00ffaa');
                    return false;
                }
                
                return dna.life > 0;
            });
            
            // ë¯¸ì‚¬ì¼ ì—…ë°ì´íŠ¸
            missiles = missiles.filter(m => {
                // ìœ ë„
                const targetAngle = Math.atan2(player.y - m.y, player.x - m.x);
                let angleDiff = targetAngle - m.angle;
                while (angleDiff > Math.PI) angleDiff -= Math.PI * 2;
                while (angleDiff < -Math.PI) angleDiff += Math.PI * 2;
                m.angle += angleDiff * 0.03;
                
                m.x += Math.cos(m.angle) * m.speed;
                m.y += Math.sin(m.angle) * m.speed;
                m.life--;
                
                // íŠ¸ë ˆì¼
                m.trail.push({ x: m.x, y: m.y });
                if (m.trail.length > 20) m.trail.shift();
                
                // í”Œë ˆì´ì–´ì™€ ì¶©ëŒ
                const dist = Math.hypot(player.x - m.x, player.y - m.y);
                if (dist < player.size + 10) {
                    if (!player.skills.shield.active && player.powerups.invincible <= 0) {
                        let damage = 25 * difficulty.damageMult;
                        if (player.strain === 'tank') damage *= 0.7; // ê°‘ì˜·í˜• í”¼í•´ ê°ì†Œ
                        if (player.strain === 'infect') damage *= 1.2; // ê°ì—¼í˜• í”¼í•´ ì¦ê°€
                        
                        player.hp -= damage;
                        game.cameraShake = 20;
                        createParticles(m.x, m.y, '#ff4444', 20);
                        createFloatingText(m.x, m.y, `-${Math.floor(damage)} HP`, '#ff0000');
                    }
                    return false;
                }
                
                return m.life > 0 && m.x > 0 && m.x < game.worldSize && m.y > 0 && m.y < game.worldSize;
            });

            // í•­ì²´ í­í’ íˆ¬ì‚¬ì²´ & ì „ê¸°ì¥ ì—…ë°ì´íŠ¸ (ëŒ€ë¯¸ì§€/íŒì • ë°¸ëŸ°ìŠ¤)
            stormProjectiles = stormProjectiles.filter(p => {
                if (!p.isStatic) {
                    p.x += p.vx;
                    p.y += p.vy;
                }
                p.life--;

                // í”Œë ˆì´ì–´ ì¶©ëŒ
                // - ì „ê¸°ì¥: ë„“ì§€ë§Œ í‹± ëŒ€ë¯¸ì§€ë¡œ ì™„í™”
                // - í­í’ íˆ¬ì‚¬ì²´: íˆíŠ¸ë°•ìŠ¤/ëŒ€ë¯¸ì§€ ì™„í™”
                const hitDist = p.isStatic ? 34 : (p.isStorm ? 6 : 5);
                const dist = Math.hypot(player.x - p.x, player.y - p.y);

                if (dist < player.size + hitDist) {
                    if (!player.skills.shield.active && player.powerups.invincible <= 0) {
                        let damage;
                        if (p.isStatic) {
                            // ì „ê¸°ì¥: ì§€ì†í˜•ì´ë¯€ë¡œ í•œ ë²ˆ ë§ì„ ë•ŒëŠ” ì•½í•˜ê²Œ
                            damage = 4 * difficulty.damageMult;
                        } else {
                            // í­í’/ê¸°íƒ€ íˆ¬ì‚¬ì²´
                            damage = 6 * difficulty.damageMult;
                        }

                        if (player.strain === 'tank') damage *= 0.7;
                        if (player.strain === 'infect') damage *= 1.15;

                        player.hp -= damage;
                        game.cameraShake = p.isStatic ? 3 : 5;
                        createParticles(p.x, p.y, p.isStatic ? '#00ffff' : '#ffff00', 8);
                        createFloatingText(p.x, p.y, `-${Math.floor(damage)} HP`, '#ff0000');

                        // íˆ¬ì‚¬ì²´ëŠ” ì‚¬ë¼ì§ / ì „ê¸°ì¥ì€ ë‚¨ìŒ(í‹±ë§ˆë‹¤ ë§ê²Œ)
                        if (!p.isStatic) return false;
                    }
                }

                // ì „ê¸°ì¥ ì§€ì†ì„±
                return p.life > 0;
            });
            
            // ì  ì—…ë°ì´íŠ¸
            enemies.forEach((enemy, ei) => {
                enemy.wobble += 0.05;
                enemy.aiTimer++;
                if (enemy.attackCooldown > 0) enemy.attackCooldown--;
                
                const distToPlayer = Math.hypot(player.x - enemy.x, player.y - enemy.y);
                
                // í¬ê¸°ì— ë”°ë¥¸ ì¶”ì  ë²”ìœ„ ì¦ê°€ (í° ë°”ì´ëŸ¬ìŠ¤ì¼ìˆ˜ë¡ ë” ë©€ë¦¬ì„œ ì¶”ì )
                const detectionRange = 250 + (player.size - 25) * 3;
                
                if (enemy.aiState === 'patrol') {
                    if (distToPlayer < detectionRange) {
                        enemy.aiState = 'chase';
                    }
                    if (enemy.aiTimer % 60 === 0) {
                        enemy.angle += (Math.random() - 0.5) * Math.PI;
                    }
                } else if (enemy.aiState === 'chase') {
                    const angle = Math.atan2(player.y - enemy.y, player.x - enemy.x);
                    enemy.angle += (angle - enemy.angle) * 0.08;
                    
                    if (distToPlayer > detectionRange * 2) {
                        enemy.aiState = 'patrol';
                    }
                }
                
                enemy.x += Math.cos(enemy.angle) * enemy.speed;
                enemy.y += Math.sin(enemy.angle) * enemy.speed;
                
                enemy.x = Math.max(enemy.size, Math.min(game.worldSize - enemy.size, enemy.x));
                enemy.y = Math.max(enemy.size, Math.min(game.worldSize - enemy.size, enemy.y));
                
                if (distToPlayer < player.size + enemy.size * 0.6 && enemy.attackCooldown <= 0) {
                    if (player.powerups.invincible > 0 || player.skills.shield.active) {
                        const pushAngle = Math.atan2(enemy.y - player.y, enemy.x - player.x);
                        enemy.x += Math.cos(pushAngle) * 30;
                        enemy.y += Math.sin(pushAngle) * 30;
                        enemy.hp -= 15;
                    } else if (player.size > enemy.size * 1.3) {
                        player.xp += Math.floor(enemy.size * 2 * difficulty.xpMult);
                        player.size += enemy.size * 0.05;
                        game.researchPoints += 20;
                        game.enemiesKilled++;
                        createParticles(enemy.x, enemy.y, '#ffffff', 30);
                        createFloatingText(enemy.x, enemy.y, `+${Math.floor(enemy.size * 2)}`, '#ffff00');
                        enemies.splice(ei, 1);
                        game.cameraShake = 15;
                    } else {
                        let damage = (10 + enemy.size * 0.2) * difficulty.damageMult * (1 - player.defenseMult - strain.def);
                        if (player.strain === 'infect') damage *= 1.2;
                        player.hp -= damage;
                        game.cameraShake = 10;
                        enemy.attackCooldown = 30;
                        
                        const pushAngle = Math.atan2(player.y - enemy.y, player.x - enemy.x);
                        player.x += Math.cos(pushAngle) * 25;
                        player.y += Math.sin(pushAngle) * 25;
                    }
                }
                
                if (enemy.hp <= 0) {
                    createParticles(enemy.x, enemy.y, '#ffffff', 20);
                    game.researchPoints += 15;
                    game.enemiesKilled++;
                    if (game.mission && game.mission.type === 'kill') game.mission.current++;
                    enemies.splice(ei, 1);
                }
            });
            
            // íŒŒì›Œì—… ì—…ë°ì´íŠ¸
            powerups.forEach((pu, index) => {
                pu.bobPhase += 0.08;
                
                const dist = Math.hypot(player.x - pu.x, player.y - pu.y);
                if (dist < player.size + pu.size) {
                    if (pu.type === 'invincible') {
                        player.powerups.invincible = 180;
                    } else if (pu.type === 'xpBoost') {
                        const xpGain = 80 * player.level * difficulty.xpMult;
                        player.xp += xpGain;
                        createFloatingText(pu.x, pu.y, `+${Math.floor(xpGain)} XP`, '#ff00ff');
                    } else if (pu.type === 'heal') {
                        const healAmount = 40 * difficulty.healMult;
                        player.hp = Math.min(player.maxHp, player.hp + healAmount);
                        createFloatingText(pu.x, pu.y, `+${Math.floor(healAmount)} HP`, '#ff6666');
                    } else if (pu.type === 'research') {
                        game.researchPoints += 50;
                        createFloatingText(pu.x, pu.y, '+50 ğŸ”¬', '#00ffff');
                    }
                    
                    createParticles(pu.x, pu.y, `hsl(${pu.color.h}, 80%, 60%)`, 20);
                    powerups.splice(index, 1);
                    
                    if (player.xp >= player.xpToLevel) levelUp();
                }
            });
            
            if (powerups.length < 4 && Math.random() < 0.006) {
                powerups.push(createPowerup());
            }
            
            // íŒŒí‹°í´ ì—…ë°ì´íŠ¸
            particles = particles.filter(p => {
                p.x += p.vx;
                p.y += p.vy;
                p.vx *= 0.94;
                p.vy *= 0.94;
                p.life--;
                return p.life > 0;
            });
            
            // í”Œë¡œíŒ… í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
            floatingTexts = floatingTexts.filter(t => {
                t.y += t.vy;
                t.life--;
                return t.life > 0;
            });
            
            // ë°°ê²½ ìš”ì†Œ ì—…ë°ì´íŠ¸
            backgroundElements.forEach(el => {
                el.twinkle += 0.03;
            });

            // í™”ë©´ ë°–ìœ¼ë¡œ ë‚˜ê°€ëŠ” ê²ƒ ë°©ì§€ (ìŠ¤í…Œì´ì§€ íš¨ê³¼ ë•Œë¬¸ì— í•„ìš”)
            player.x = Math.max(player.size, Math.min(game.worldSize - player.size, player.x));
            player.y = Math.max(player.size, Math.min(game.worldSize - player.size, player.y));
            
            // ì²´ë ¥ ì²´í¬
            if (player.hp <= 0) gameOver();
            
            updateUI();
        }
        
        // UI ì—…ë°ì´íŠ¸
        function updateUI() {
            document.getElementById('level').textContent = player.level;
            document.getElementById('size').textContent = Math.floor(player.size);
            document.getElementById('xp').textContent = Math.floor(player.xp);
            document.getElementById('xpMax').textContent = player.xpToLevel;
            document.getElementById('xpBar').style.width = Math.min(100, (player.xp / player.xpToLevel * 100)) + '%';
            document.getElementById('hp').textContent = Math.floor(player.hp);
            document.getElementById('hpMax').textContent = player.maxHp;
            document.getElementById('hpBar').style.width = Math.max(0, (player.hp / player.maxHp * 100)) + '%';
            document.getElementById('infected').textContent = game.infected;
            document.getElementById('currentWave').textContent = game.wave;
            document.getElementById('maxCombo').textContent = game.maxCombo;
            document.getElementById('enemiesKilled').textContent = game.enemiesKilled;
            document.getElementById('researchPoints').textContent = game.researchPoints;
            document.getElementById('dnaCollected').textContent = game.dnaCollected;
            
            const speedPenalty = getSizeSpeedPenalty();
            document.getElementById('statSpeed').textContent = Math.floor(player.speedMult * speedPenalty * 100) + '%';
            document.getElementById('statAbsorb').textContent = Math.floor(player.absorbMult * 100) + '%';
            document.getElementById('statDefense').textContent = Math.floor(player.defenseMult * 100) + '%';
            
            // í¬ê¸° í˜ë„í‹° í‘œì‹œ
            if (speedPenalty < 1) {
                document.getElementById('sizeDebuff').innerHTML = `<span class="text-red-400">âš ï¸ ì†ë„ ${Math.floor((1 - speedPenalty) * 100)}% ê°ì†Œ</span>`;
            } else {
                document.getElementById('sizeDebuff').textContent = '';
            }
            
            const elapsed = Math.floor((Date.now() - game.startTime) / 1000);
            const mins = Math.floor(elapsed / 60).toString().padStart(2, '0');
            const secs = (elapsed % 60).toString().padStart(2, '0');
            document.getElementById('time').textContent = `${mins}:${secs}`;
            
            document.getElementById('cooldownQ').style.height = (player.skills.toxin.cooldown / player.skills.toxin.maxCooldown * 100) + '%';
            document.getElementById('cooldownE').style.height = (player.skills.magnet.cooldown / difficulty.magnetCooldown * 100) + '%';
            document.getElementById('cooldownR').style.height = (player.skills.split.cooldown / player.skills.split.maxCooldown * 100) + '%';
            document.getElementById('cooldownF').style.height = (player.skills.shield.cooldown / player.skills.shield.maxCooldown * 100) + '%';
            
            const effectsContainer = document.getElementById('activeEffects');
            effectsContainer.innerHTML = '';
            if (player.powerups.invincible > 0 || player.skills.shield.active) {
                effectsContainer.innerHTML += '<span class="bg-yellow-500/30 px-2 py-1 rounded text-yellow-400 text-xs korean-font">ğŸ›¡ï¸</span>';
            }
            if (player.powerups.magnet > 0 || player.skills.magnet.active) {
                effectsContainer.innerHTML += '<span class="bg-blue-500/30 px-2 py-1 rounded text-blue-400 text-xs korean-font">ğŸ§²</span>';
            }
            if (player.strain === 'speed') {
                document.getElementById('strain1').classList.add('strain-active');
                document.getElementById('strain2').classList.remove('strain-active');
                document.getElementById('strain3').classList.remove('strain-active');
                document.getElementById('currentStrainName').textContent = 'ì‹ ì†í˜•';
                document.getElementById('currentStrainName').className = 'text-blue-400 font-bold';
            } else if (player.strain === 'tank') {
                document.getElementById('strain1').classList.remove('strain-active');
                document.getElementById('strain2').classList.add('strain-active');
                document.getElementById('strain3').classList.remove('strain-active');
                document.getElementById('currentStrainName').textContent = 'ê°‘ì˜·í˜•';
                document.getElementById('currentStrainName').className = 'text-green-400 font-bold';
            } else if (player.strain === 'infect') {
                document.getElementById('strain1').classList.remove('strain-active');
                document.getElementById('strain2').classList.remove('strain-active');
                document.getElementById('strain3').classList.add('strain-active');
                document.getElementById('currentStrainName').textContent = 'ê°ì—¼í˜•';
                document.getElementById('currentStrainName').className = 'text-red-400 font-bold';
            } else {
                document.getElementById('strain1').classList.remove('strain-active');
                document.getElementById('strain2').classList.remove('strain-active');
                document.getElementById('strain3').classList.remove('strain-active');
                document.getElementById('currentStrainName').textContent = 'ê¸°ë³¸í˜•';
                document.getElementById('currentStrainName').className = 'text-gray-400 font-bold';
            }
        }
        
        function generateMission() {
            const types = ['infect', 'kill'];
            const type = types[Math.floor(Math.random() * types.length)];
            let target = 0;
            let description = '';
            
            if (type === 'infect') {
                target = 10 + Math.floor(game.wave * 1.5);
                description = `ì„¸í¬ ${target}ë§ˆë¦¬ ê°ì—¼ì‹œí‚¤ê¸°`;
            } else {
                target = 2 + Math.floor(game.wave * 0.5);
                description = `ì  ${target}ë§ˆë¦¬ ì²˜ì¹˜í•˜ê¸°`;
            }
            
            game.mission = {
                type,
                target,
                current: 0,
                duration: 30 * 60, // 30ì´ˆ
                description,
                reward: 200 * player.level
            };
            
            document.getElementById('missionText').textContent = description;
            document.getElementById('missionDisplay').classList.remove('translate-x-full');
            createFloatingText(player.x, player.y - 80, "ì‹ ê·œ ë¯¸ì…˜!", "#ffffff");
        }
        
        function completeMission() {
            game.researchPoints += game.mission.reward;
            player.xp += game.mission.reward;
            createFloatingText(player.x, player.y - 80, `ë¯¸ì…˜ ì™„ë£Œ! +${game.mission.reward} RP`, "#00ff00");
            createParticles(player.x, player.y, '#ffd700', 30);
            game.mission = null;
            document.getElementById('missionDisplay').classList.add('translate-x-full');
            if (player.xp >= player.xpToLevel) levelUp();
        }

        // ë Œë”ë§
        function render() {
            // ë°°ê²½ (ìŠ¤í…Œì´ì§€ë³„ ìƒ‰ìƒ)
            const stageInfo = game.stageData[game.stage - 1] || game.stageData[0];
            
            const bgGrad = ctx.createRadialGradient(
                canvas.width / 2, canvas.height / 2, 0,
                canvas.width / 2, canvas.height / 2, canvas.width
            );
            
            if (gameMode === 'challenge') {
                bgGrad.addColorStop(0, '#1a0808');
                bgGrad.addColorStop(0.5, '#0d0404');
                bgGrad.addColorStop(1, '#050202');
            } else {
                bgGrad.addColorStop(0, stageInfo.colorStart);
                bgGrad.addColorStop(0.5, '#000000');
                bgGrad.addColorStop(1, stageInfo.colorEnd);
            }
            ctx.fillStyle = bgGrad;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            const shakeX = (Math.random() - 0.5) * game.cameraShake;
            const shakeY = (Math.random() - 0.5) * game.cameraShake;
            
            ctx.save();
            ctx.translate(canvas.width / 2 + shakeX, canvas.height / 2 + shakeY);
            ctx.scale(game.zoom, game.zoom);
            ctx.translate(-player.x, -player.y);
            
            // ë°°ê²½ ìš”ì†Œ
            backgroundElements.forEach(el => {
                const brightness = 0.2 + Math.sin(el.twinkle) * 0.15;
                ctx.beginPath();
                if (el.type === 'molecule') {
                    ctx.arc(el.x, el.y, el.size * 2, 0, Math.PI * 2);
                    ctx.fillStyle = `rgba(0, 200, 255, ${brightness * 0.3})`;
                } else {
                    ctx.arc(el.x, el.y, el.size, 0, Math.PI * 2);
                    ctx.fillStyle = `rgba(150, 100, 255, ${brightness})`;
                }
                ctx.fill();
            });
            
            // í•­ì²´ í­í’ íˆ¬ì‚¬ì²´ & ì „ê¸°ì¥
            stormProjectiles.forEach(p => {
                if (p.isStatic) {
                    // ì „ê¸°ì¥ (ì‹ ê²½ê³„)
                    const flicker = Math.random() * 0.5 + 0.5;
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, 30, 0, Math.PI * 2);
                    ctx.fillStyle = `rgba(100, 200, 255, ${0.3 * flicker})`;
                    ctx.fill();
                    ctx.strokeStyle = `rgba(200, 255, 255, ${0.8 * flicker})`;
                    ctx.stroke();
                    // ë²ˆê°œ íš¨ê³¼
                    ctx.beginPath();
                    ctx.moveTo(p.x + (Math.random()-0.5)*20, p.y + (Math.random()-0.5)*20);
                    ctx.lineTo(p.x + (Math.random()-0.5)*20, p.y + (Math.random()-0.5)*20);
                    ctx.stroke();
                } else {
                    // ì¼ë°˜ íˆ¬ì‚¬ì²´
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, 4, 0, Math.PI * 2);
                    ctx.fillStyle = '#ffff00';
                    ctx.fill();
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, 8, 0, Math.PI * 2);
                    ctx.fillStyle = 'rgba(255, 255, 0, 0.3)';
                    ctx.fill();
                }
            });

            // AI ë””ë²„ê·¸ ì‹œê°í™” (êµìœ¡ìš©)
            if (game.aiDebugMode) {
                enemies.forEach(e => {
                    // ì¸ì‹ ë²”ìœ„ ì›
                    const detectionRange = 250 + (player.size - 25) * 3;
                    ctx.beginPath();
                    ctx.arc(e.x, e.y, detectionRange, 0, Math.PI * 2);
                    ctx.strokeStyle = 'rgba(255, 0, 0, 0.2)';
                    ctx.setLineDash([5, 5]);
                    ctx.stroke();
                    ctx.setLineDash([]);
                    
                    // ì¶”ì  ë¼ì¸
                    ctx.beginPath();
                    ctx.moveTo(e.x, e.y);
                    ctx.lineTo(player.x, player.y);
                    
                    const dist = Math.hypot(player.x - e.x, player.y - e.y);
                    if (dist < detectionRange) {
                        ctx.strokeStyle = 'rgba(255, 0, 0, 0.8)'; // ì¶”ì  ì¤‘
                        ctx.lineWidth = 2;
                        
                        // ì•Œê³ ë¦¬ì¦˜ í…ìŠ¤íŠ¸
                        ctx.fillStyle = '#ffaaaa';
                        ctx.font = '10px monospace';
                        ctx.fillText(`A* Target: Player (${Math.floor(dist)}m)`, e.x, e.y - 20);
                    } else {
                        ctx.strokeStyle = 'rgba(100, 100, 100, 0.3)'; // ëŒ€ê¸° ì¤‘
                        ctx.lineWidth = 1;
                        ctx.fillStyle = '#aaaaaa';
                        ctx.font = '10px monospace';
                        ctx.fillText('Patrol Mode', e.x, e.y - 20);
                    }
                    ctx.stroke();
                });
            }

            // ê·¸ë¦¬ë“œ
            ctx.strokeStyle = 'rgba(0, 100, 150, 0.08)';
            ctx.lineWidth = 1;
            const gridSize = 100;
            for (let x = 0; x < game.worldSize; x += gridSize) {
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, game.worldSize);
                ctx.stroke();
            }
            for (let y = 0; y < game.worldSize; y += gridSize) {
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(game.worldSize, y);
                ctx.stroke();
            }
            
            // ë…ì„± ì§€ì—­
            toxicZones.forEach(zone => {
                const pulse = 0.3 + Math.sin(zone.pulsePhase) * 0.2;
                ctx.beginPath();
                ctx.arc(zone.x, zone.y, zone.radius, 0, Math.PI * 2);
                const grad = ctx.createRadialGradient(zone.x, zone.y, 0, zone.x, zone.y, zone.radius);
                grad.addColorStop(0, `rgba(0, 255, 0, ${pulse * 0.4})`);
                grad.addColorStop(0.7, `rgba(0, 200, 0, ${pulse * 0.2})`);
                grad.addColorStop(1, 'transparent');
                ctx.fillStyle = grad;
                ctx.fill();
                
                ctx.beginPath();
                ctx.arc(zone.x, zone.y, zone.radius, 0, Math.PI * 2);
                ctx.strokeStyle = `rgba(0, 255, 0, ${pulse * 0.5})`;
                ctx.lineWidth = 2;
                ctx.stroke();
            });
            
            // ì›”ë“œ ê²½ê³„
            ctx.strokeStyle = gameMode === 'challenge' ? 'rgba(255, 50, 50, 0.5)' : 'rgba(0, 200, 255, 0.5)';
            ctx.lineWidth = 5;
            ctx.strokeRect(0, 0, game.worldSize, game.worldSize);
            
            // DNA í”½ì—…
            dnaPickups.forEach(dna => {
                const bobY = Math.sin(dna.bobPhase) * 5;
                ctx.save();
                ctx.translate(dna.x, dna.y + bobY);
                ctx.rotate(dna.bobPhase * 0.5);
                
                ctx.beginPath();
                for (let i = 0; i < 20; i++) {
                    const t = i / 20;
                    const x1 = Math.sin(t * Math.PI * 4) * 8;
                    const y1 = (t - 0.5) * 20;
                    ctx.lineTo(x1, y1);
                }
                ctx.strokeStyle = '#00ff88';
                ctx.lineWidth = 2;
                ctx.stroke();
                
                ctx.beginPath();
                for (let i = 0; i < 20; i++) {
                    const t = i / 20;
                    const x1 = -Math.sin(t * Math.PI * 4) * 8;
                    const y1 = (t - 0.5) * 20;
                    ctx.lineTo(x1, y1);
                }
                ctx.strokeStyle = '#00aaff';
                ctx.lineWidth = 2;
                ctx.stroke();
                
                ctx.restore();
            });
            
            // íŒŒì›Œì—…
            powerups.forEach(pu => {
                const bobY = Math.sin(pu.bobPhase) * 5;
                
                ctx.beginPath();
                ctx.arc(pu.x, pu.y + bobY, pu.size * 2, 0, Math.PI * 2);
                const glow = ctx.createRadialGradient(pu.x, pu.y + bobY, 0, pu.x, pu.y + bobY, pu.size * 2);
                glow.addColorStop(0, `hsla(${pu.color.h}, ${pu.color.s}%, ${pu.color.l}%, 0.4)`);
                glow.addColorStop(1, 'transparent');
                ctx.fillStyle = glow;
                ctx.fill();
                
                ctx.beginPath();
                ctx.arc(pu.x, pu.y + bobY, pu.size, 0, Math.PI * 2);
                const grad = ctx.createRadialGradient(pu.x - 5, pu.y + bobY - 5, 0, pu.x, pu.y + bobY, pu.size);
                grad.addColorStop(0, `hsl(${pu.color.h}, ${pu.color.s}%, ${pu.color.l + 20}%)`);
                grad.addColorStop(1, `hsl(${pu.color.h}, ${pu.color.s}%, ${pu.color.l - 20}%)`);
                ctx.fillStyle = grad;
                ctx.fill();
                
                ctx.font = `${pu.size}px Arial`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(pu.color.icon, pu.x, pu.y + bobY);
            });
            
            // ì„¸í¬
            cells.forEach(cell => {
                const pulse = Math.sin(cell.pulsePhase) * 0.05 + 1;
                const size = cell.size * pulse;
                
                ctx.beginPath();
                ctx.arc(cell.x, cell.y, size * 1.3, 0, Math.PI * 2);
                const outerGlow = ctx.createRadialGradient(cell.x, cell.y, size, cell.x, cell.y, size * 1.3);
                outerGlow.addColorStop(0, `hsla(${cell.color.h}, ${cell.color.s}%, ${cell.color.l}%, 0.3)`);
                outerGlow.addColorStop(1, 'transparent');
                ctx.fillStyle = outerGlow;
                ctx.fill();
                
                ctx.beginPath();
                ctx.arc(cell.x, cell.y, size, 0, Math.PI * 2);
                const membraneGrad = ctx.createRadialGradient(
                    cell.x - size * 0.3, cell.y - size * 0.3, 0,
                    cell.x, cell.y, size
                );
                membraneGrad.addColorStop(0, `hsl(${cell.color.h}, ${cell.color.s}%, ${cell.color.l + 25}%)`);
                membraneGrad.addColorStop(0.7, `hsl(${cell.color.h}, ${cell.color.s}%, ${cell.color.l}%)`);
                membraneGrad.addColorStop(1, `hsl(${cell.color.h}, ${cell.color.s - 10}%, ${cell.color.l - 15}%)`);
                ctx.fillStyle = membraneGrad;
                ctx.fill();
                
                ctx.beginPath();
                ctx.arc(cell.x + size * 0.1, cell.y + size * 0.1, size * 0.35, 0, Math.PI * 2);
                ctx.fillStyle = `hsla(${cell.color.h + 30}, ${cell.color.s}%, ${cell.color.l - 20}%, 0.7)`;
                ctx.fill();
                
                ctx.beginPath();
                ctx.arc(cell.x - size * 0.35, cell.y - size * 0.35, size * 0.2, 0, Math.PI * 2);
                ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
                ctx.fill();
                
                if (cell.poisoned) {
                    ctx.beginPath();
                    ctx.arc(cell.x, cell.y, size * 1.2, 0, Math.PI * 2);
                    ctx.strokeStyle = 'rgba(0, 255, 0, 0.6)';
                    ctx.lineWidth = 3;
                    ctx.stroke();
                }
            });
            
            // ë¯¸ì‚¬ì¼
            missiles.forEach(m => {
                // íŠ¸ë ˆì¼
                if (m.trail.length > 1) {
                    ctx.beginPath();
                    ctx.moveTo(m.trail[0].x, m.trail[0].y);
                    for (let i = 1; i < m.trail.length; i++) {
                        ctx.lineTo(m.trail[i].x, m.trail[i].y);
                    }
                    ctx.strokeStyle = 'rgba(255, 100, 0, 0.5)';
                    ctx.lineWidth = 3;
                    ctx.stroke();
                }
                
                // ë¯¸ì‚¬ì¼ ë³¸ì²´
                ctx.save();
                ctx.translate(m.x, m.y);
                ctx.rotate(m.angle);
                
                ctx.beginPath();
                ctx.moveTo(15, 0);
                ctx.lineTo(-10, -6);
                ctx.lineTo(-10, 6);
                ctx.closePath();
                ctx.fillStyle = '#ff4400';
                ctx.fill();
                
                ctx.beginPath();
                ctx.arc(0, 0, 8, 0, Math.PI * 2);
                const missileGlow = ctx.createRadialGradient(0, 0, 0, 0, 0, 12);
                missileGlow.addColorStop(0, 'rgba(255, 200, 0, 0.8)');
                missileGlow.addColorStop(1, 'transparent');
                ctx.fillStyle = missileGlow;
                ctx.fill();
                
                ctx.restore();
            });
            
            // ì  & ë³´ìŠ¤ ë Œë”ë§
            const renderTarget = [...enemies];
            if (game.bossActive && game.boss) {
                renderTarget.push(game.boss);
            }

            renderTarget.forEach(enemy => {
                const isBoss = !!enemy.phase; // ë³´ìŠ¤ êµ¬ë¶„
                const wobble = Math.sin(game.waveTimer * 0.1) * 3; // ë³´ìŠ¤ëŠ” wobble ì†ì„± ì—†ìœ¼ë¯€ë¡œ waveTimer ì‚¬ìš©
                
                // ì—˜ë¦¬íŠ¸ ì  ì˜¤ë¼
                if (enemy.isElite) {
                    ctx.beginPath();
                    ctx.arc(enemy.x, enemy.y, enemy.size * 2, 0, Math.PI * 2);
                    const eliteGlow = ctx.createRadialGradient(enemy.x, enemy.y, enemy.size, enemy.x, enemy.y, enemy.size * 2);
                    eliteGlow.addColorStop(0, 'rgba(255, 215, 0, 0.3)'); // ê³¨ë“œ/ì˜¤ë Œì§€ ë¹›
                    eliteGlow.addColorStop(1, 'transparent');
                    ctx.fillStyle = eliteGlow;
                    ctx.fill();
                    
                    // íšŒì „í•˜ëŠ” ë 
                    const time = Date.now() / 500;
                    ctx.beginPath();
                    ctx.arc(enemy.x, enemy.y, enemy.size * 1.6, time, time + Math.PI);
                    ctx.strokeStyle = 'rgba(255, 215, 0, 0.6)';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                }

                ctx.beginPath();
                ctx.arc(enemy.x, enemy.y, enemy.size * 1.5, 0, Math.PI * 2);
                const dangerGlow = ctx.createRadialGradient(enemy.x, enemy.y, enemy.size, enemy.x, enemy.y, enemy.size * 1.5);
                dangerGlow.addColorStop(0, 'rgba(255, 100, 100, 0.2)');
                dangerGlow.addColorStop(1, 'transparent');
                ctx.fillStyle = dangerGlow;
                ctx.fill();
                
                ctx.beginPath();
                if (enemy.type === 'macrophage' || enemy.type === 'giant') {
                    for (let i = 0; i < 8; i++) {
                        const a = (Math.PI * 2 / 8) * i;
                        const r = enemy.size * (0.9 + Math.sin((enemy.wobble||0) + i) * 0.15);
                        if (i === 0) ctx.moveTo(enemy.x + Math.cos(a) * r, enemy.y + Math.sin(a) * r);
                        else ctx.lineTo(enemy.x + Math.cos(a) * r, enemy.y + Math.sin(a) * r);
                    }
                    ctx.closePath();
                } else {
                    ctx.arc(enemy.x, enemy.y + wobble, enemy.size, 0, Math.PI * 2);
                }
                
                const enemyGrad = ctx.createRadialGradient(
                    enemy.x - enemy.size * 0.3, enemy.y - enemy.size * 0.3, 0,
                    enemy.x, enemy.y, enemy.size
                );
                
                if (isBoss) {
                     enemyGrad.addColorStop(0, '#ff0000');
                     enemyGrad.addColorStop(0.5, '#aa0000');
                     enemyGrad.addColorStop(1, '#550000');
                } else if (enemy.type === 'whiteBlood') {
                    enemyGrad.addColorStop(0, '#ffffff');
                    enemyGrad.addColorStop(0.6, '#dddddd');
                    enemyGrad.addColorStop(1, '#888888');
                } else if (enemy.type === 'antibody') {
                    enemyGrad.addColorStop(0, '#ffdd00');
                    enemyGrad.addColorStop(0.6, '#ffaa00');
                    enemyGrad.addColorStop(1, '#885500');
                } else if (enemy.type === 'tcell') {
                    enemyGrad.addColorStop(0, '#cc88ff');
                    enemyGrad.addColorStop(0.6, '#9944cc');
                    enemyGrad.addColorStop(1, '#552288');
                } else if (enemy.type === 'nkcell') {
                    enemyGrad.addColorStop(0, '#ff88ff');
                    enemyGrad.addColorStop(0.6, '#cc44cc');
                    enemyGrad.addColorStop(1, '#882288');
                } else {
                    enemyGrad.addColorStop(0, '#ff8888');
                    enemyGrad.addColorStop(0.6, '#ff4444');
                    enemyGrad.addColorStop(1, '#881111');
                }
                
                ctx.fillStyle = enemyGrad;
                ctx.fill();
                
                // HP ë°” (ë³´ìŠ¤ëŠ” í™”ë©´ ìƒë‹¨ì— ë³„ë„ë¡œ ìˆìŒ)
                if (!isBoss) {
                    ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
                    ctx.fillRect(enemy.x - enemy.size, enemy.y - enemy.size - 15, enemy.size * 2, 8);
                    ctx.fillStyle = '#ff4444';
                    ctx.fillRect(enemy.x - enemy.size, enemy.y - enemy.size - 15, enemy.size * 2 * (enemy.hp / enemy.maxHp), 8);
                }
                
                // ì•„ì´ì½˜
                ctx.font = `bold ${enemy.size * 0.5}px Arial`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillStyle = '#ff0000';
                ctx.shadowColor = '#ff0000';
                ctx.shadowBlur = 10;
                ctx.fillText(isBoss ? 'â˜ ï¸' : 'âš ', enemy.x, enemy.y + wobble);
                ctx.shadowBlur = 0;
            });
            
            // íŒŒí‹°í´
            particles.forEach(p => {
                ctx.beginPath();
                ctx.arc(p.x, p.y, p.size * (p.life / 60), 0, Math.PI * 2);
                ctx.fillStyle = p.color;
                ctx.fill();
            });
            
            // í”Œë ˆì´ì–´
            const time = Date.now() / 1000;
            
            // ì‰´ë“œ íš¨ê³¼
            if (player.skills.shield.active) {
                ctx.beginPath();
                ctx.arc(player.x, player.y, player.size * 1.8, 0, Math.PI * 2);
                ctx.strokeStyle = `rgba(100, 200, 255, ${0.5 + Math.sin(time * 10) * 0.3})`;
                ctx.lineWidth = 6;
                ctx.stroke();
            }
            
            // ë¬´ì  íš¨ê³¼
            if (player.powerups.invincible > 0) {
                ctx.beginPath();
                ctx.arc(player.x, player.y, player.size * 2, 0, Math.PI * 2);
                const invGlow = ctx.createRadialGradient(player.x, player.y, player.size, player.x, player.y, player.size * 2);
                invGlow.addColorStop(0, 'rgba(255, 215, 0, 0.4)');
                invGlow.addColorStop(1, 'transparent');
                ctx.fillStyle = invGlow;
                ctx.fill();
            }
            
            // ì™¸ë¶€ ê¸€ë¡œìš°
            ctx.beginPath();
            ctx.arc(player.x, player.y, player.size * 2, 0, Math.PI * 2);
            const outerGlow = ctx.createRadialGradient(player.x, player.y, player.size * 0.5, player.x, player.y, player.size * 2);
            outerGlow.addColorStop(0, `hsla(${player.color.h}, ${player.color.s}%, ${player.color.l}%, 0.4)`);
            outerGlow.addColorStop(1, 'transparent');
            ctx.fillStyle = outerGlow;
            ctx.fill();
            
            // ì´‰ìˆ˜ (ì ë³µ ì‹œ ìˆ¨ê¹€)
            if (!player.isHidden) {
                player.tentacles.forEach((t, i) => {
                    const angle = t.angle + time * 0.3;
                    const length = player.size * (0.6 + t.length * 0.6);
                    const thickness = 3 + t.thickness * 3;
                    
                    const startX = player.x + Math.cos(angle) * player.size * 0.6;
                    const startY = player.y + Math.sin(angle) * player.size * 0.6;
                    const endX = player.x + Math.cos(angle) * length;
                    const endY = player.y + Math.sin(angle) * length;
                    
                    ctx.beginPath();
                    ctx.moveTo(startX, startY);
                    ctx.lineTo(endX, endY);
                    
                    const tentGrad = ctx.createLinearGradient(startX, startY, endX, endY);
                    tentGrad.addColorStop(0, `hsla(${player.color.h}, ${player.color.s}%, ${player.color.l}%, 0.9)`);
                    tentGrad.addColorStop(1, `hsla(${player.color.h + 30}, ${player.color.s}%, ${player.color.l + 20}%, 0.6)`);
                    
                    ctx.strokeStyle = tentGrad;
                    ctx.lineWidth = thickness;
                    ctx.lineCap = 'round';
                    ctx.stroke();
                    
                    ctx.beginPath();
                    ctx.arc(endX, endY, thickness * 0.8, 0, Math.PI * 2);
                    ctx.fillStyle = `hsl(${player.color.h + 40}, ${player.color.s}%, ${player.color.l + 25}%)`;
                    ctx.fill();
                });
            }
            
            // ë³¸ì²´ (ì ë³µ ì‹œ ìˆ¨ê¹€ or ë°˜íˆ¬ëª…)
            if (!player.isHidden) {
                ctx.beginPath();
                ctx.arc(player.x, player.y, player.size, 0, Math.PI * 2);
                const bodyGrad = ctx.createRadialGradient(
                    player.x - player.size * 0.3, player.y - player.size * 0.3, 0,
                    player.x, player.y, player.size
                );
                bodyGrad.addColorStop(0, `hsl(${player.color.h}, ${player.color.s}%, ${player.color.l + 35}%)`);
                bodyGrad.addColorStop(0.4, `hsl(${player.color.h}, ${player.color.s}%, ${player.color.l + 15}%)`);
                bodyGrad.addColorStop(0.7, `hsl(${player.color.h}, ${player.color.s}%, ${player.color.l}%)`);
                bodyGrad.addColorStop(1, `hsl(${player.color.h + 20}, ${player.color.s + 10}%, ${player.color.l - 25}%)`);
                ctx.fillStyle = bodyGrad;
                ctx.fill();
            } else if (player.hostCell) {
                // ìˆ™ì£¼ ì•ˆì— ìˆ¨ì€ ëª¨ìŠµ (í¬ë¯¸í•˜ê²Œ)
                ctx.beginPath();
                ctx.arc(player.x, player.y, player.size * 0.5, 0, Math.PI * 2);
                ctx.fillStyle = `hsla(${player.color.h}, ${player.color.s}%, 50%, 0.3)`;
                ctx.fill();
            }
            
            // DNA ë‚˜ì„ 
            ctx.save();
            ctx.translate(player.x, player.y);
            ctx.rotate(time);
            for (let i = 0; i < 2; i++) {
                ctx.beginPath();
                for (let j = 0; j < 20; j++) {
                    const a = (j / 20) * Math.PI * 2;
                    const r = player.size * 0.3;
                    const x = Math.cos(a + i * Math.PI) * r;
                    const y = Math.sin(a) * r * 0.3 + (j - 10) * player.size * 0.03;
                    if (j === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                }
                ctx.strokeStyle = `hsla(${player.color.h + 60}, 80%, 70%, 0.6)`;
                ctx.lineWidth = 2;
                ctx.stroke();
            }
            ctx.restore();
            
            // í•˜ì´ë¼ì´íŠ¸
            ctx.beginPath();
            ctx.arc(player.x - player.size * 0.35, player.y - player.size * 0.35, player.size * 0.22, 0, Math.PI * 2);
            ctx.fillStyle = 'rgba(255, 255, 255, 0.6)';
            ctx.fill();
            
            // ë¶„ì‹ 
            player.splitlings.forEach(s => {
                ctx.beginPath();
                ctx.arc(s.x, s.y, s.size, 0, Math.PI * 2);
                const splitGrad = ctx.createRadialGradient(s.x, s.y, 0, s.x, s.y, s.size);
                splitGrad.addColorStop(0, `hsla(${player.color.h}, ${player.color.s}%, ${player.color.l + 20}%, ${s.life / 90})`);
                splitGrad.addColorStop(1, `hsla(${player.color.h}, ${player.color.s}%, ${player.color.l}%, ${s.life / 180})`);
                ctx.fillStyle = splitGrad;
                ctx.fill();
            });
            
            // í”Œë¡œíŒ… í…ìŠ¤íŠ¸
            ctx.font = 'bold 16px "Noto Sans KR"';
            floatingTexts.forEach(t => {
                ctx.textAlign = 'center';
                ctx.fillStyle = t.color;
                ctx.globalAlpha = t.life / 60;
                ctx.fillText(t.text, t.x, t.y);
                ctx.globalAlpha = 1;
            });

            // ê³µìƒì²´ ê·¸ë¦¬ê¸°
            player.companions?.forEach(comp => {
                const cx = player.x + Math.cos(comp.angle) * comp.dist;
                const cy = player.y + Math.sin(comp.angle) * comp.dist;
                
                // ë³¸ì²´
                ctx.beginPath();
                ctx.arc(cx, cy, 8, 0, Math.PI * 2);
                ctx.fillStyle = '#00ffff';
                ctx.fill();
                ctx.strokeStyle = '#ffffff';
                ctx.lineWidth = 2;
                ctx.stroke();

                // ì—°ê²°ì„ 
                ctx.beginPath();
                ctx.moveTo(player.x, player.y);
                ctx.lineTo(cx, cy);
                ctx.strokeStyle = 'rgba(0, 255, 255, 0.2)';
                ctx.lineWidth = 1;
                ctx.stroke();

                // ë ˆì´ì € ë°œì‚¬ íš¨ê³¼
                if (comp.fireFrame > 0 && comp.targetX) {
                    ctx.beginPath();
                    ctx.moveTo(cx, cy);
                    ctx.lineTo(comp.targetX, comp.targetY);
                    ctx.strokeStyle = `rgba(0, 255, 255, ${comp.fireFrame / 5})`;
                    ctx.lineWidth = 3;
                    ctx.stroke();
                }
            });
            
            ctx.restore();
            
            // ë¹„ë„¤íŠ¸
            const vignette = ctx.createRadialGradient(
                canvas.width / 2, canvas.height / 2, canvas.height * 0.3,
                canvas.width / 2, canvas.height / 2, canvas.height
            );
            vignette.addColorStop(0, 'transparent');
            vignette.addColorStop(1, gameMode === 'challenge' ? 'rgba(50, 0, 0, 0.7)' : 'rgba(0, 0, 0, 0.6)');
            ctx.fillStyle = vignette;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // ë¯¸ë‹ˆë§µ
            const mapSize = 140;
            const mapX = canvas.width - mapSize - 20;
            const mapY = canvas.height - mapSize - 70;
            
            ctx.fillStyle = 'rgba(0, 20, 40, 0.9)';
            ctx.fillRect(mapX - 3, mapY - 3, mapSize + 6, mapSize + 6);
            ctx.strokeStyle = gameMode === 'challenge' ? 'rgba(255, 50, 50, 0.6)' : 'rgba(0, 200, 255, 0.6)';
            ctx.lineWidth = 2;
            ctx.strokeRect(mapX - 3, mapY - 3, mapSize + 6, mapSize + 6);
            
            const scale = mapSize / game.worldSize;
            
            // ë…ì„± ì§€ì—­
            toxicZones.forEach(zone => {
                ctx.beginPath();
                ctx.arc(mapX + zone.x * scale, mapY + zone.y * scale, zone.radius * scale, 0, Math.PI * 2);
                ctx.fillStyle = 'rgba(0, 255, 0, 0.3)';
                ctx.fill();
            });
            
            cells.forEach(cell => {
                ctx.beginPath();
                ctx.arc(mapX + cell.x * scale, mapY + cell.y * scale, 2, 0, Math.PI * 2);
                ctx.fillStyle = `hsl(${cell.color.h}, ${cell.color.s}%, ${cell.color.l}%)`;
                ctx.fill();
            });
            
            missiles.forEach(m => {
                ctx.beginPath();
                ctx.arc(mapX + m.x * scale, mapY + m.y * scale, 3, 0, Math.PI * 2);
                ctx.fillStyle = '#ff8800';
                ctx.fill();
            });
            
            enemies.forEach(enemy => {
                ctx.beginPath();
                ctx.arc(mapX + enemy.x * scale, mapY + enemy.y * scale, 4, 0, Math.PI * 2);
                ctx.fillStyle = '#ff4444';
                ctx.fill();
            });
            
            ctx.beginPath();
            ctx.arc(mapX + player.x * scale, mapY + player.y * scale, 6, 0, Math.PI * 2);
            ctx.fillStyle = `hsl(${player.color.h}, 80%, 60%)`;
            ctx.fill();
            ctx.strokeStyle = '#ffffff';
            ctx.lineWidth = 2;
            ctx.stroke();
        }
        
        // ê²Œì„ ì˜¤ë²„
        function gameOver() {
            game.running = false;
            
            if (game.quizTimerInterval) clearInterval(game.quizTimerInterval);
            
            document.getElementById('challengeOverlay').classList.add('hidden');
            document.getElementById('leftPanel').classList.remove('warning-border');
            document.getElementById('missionDisplay').classList.add('translate-x-full');
            
            document.getElementById('finalLevel').textContent = player.level;
            document.getElementById('finalInfected').textContent = game.infected;
            document.getElementById('finalKills').textContent = game.enemiesKilled;
            
            const elapsed = Math.floor((Date.now() - game.startTime) / 1000);
            
            // ìµœê³  ê¸°ë¡ ì €ì¥ ë° ê°±ì‹ 
            let score = game.infected * 10 + game.enemiesKilled * 50 + elapsed * 5;
            if (score > game.highScore) {
                game.highScore = score;
                localStorage.setItem('virusLabHighScore', score);
                createFloatingText(window.innerWidth/2, window.innerHeight/2 - 100, "ğŸ† ìµœê³  ê¸°ë¡ ê°±ì‹ ! ğŸ†", "#ffd700");
            }

            const mins = Math.floor(elapsed / 60).toString().padStart(2, '0');
            const secs = (elapsed % 60).toString().padStart(2, '0');
            document.getElementById('finalTime').textContent = `${mins}:${secs}`;
            
            const learned = document.getElementById('learnedToday');
            if (game.learnedFacts.length > 0) {
                learned.innerHTML = game.learnedFacts.slice(0, 3).map(f => `â€¢ ${f}`).join('<br>');
            } else {
                learned.textContent = 'ë‹¤ìŒì—ëŠ” ë” ì˜¤ë˜ ìƒì¡´í•´ì„œ ê³¼í•™ ìƒì‹ì„ ë°°ì›Œë³´ì„¸ìš”!';
            }
            
            document.getElementById('gameOverScreen').classList.remove('hidden');
        }
        
        // ê²Œì„ ë£¨í”„
        function gameLoop() {
            update();
            render();
            requestAnimationFrame(gameLoop);
        }
        
        // ê²Œì„ ëª¨ë“œ ì„ íƒ
        document.querySelectorAll('.mode-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('ring-4', 'ring-white'));
                btn.classList.add('ring-4', 'ring-white');
                gameMode = btn.dataset.mode;
                
                if (gameMode === 'challenge') {
                    document.getElementById('challengeWarning').classList.remove('hidden');
                } else {
                    document.getElementById('challengeWarning').classList.add('hidden');
                }
            });
        });
        
        // ì´ë²¤íŠ¸
        document.getElementById('startBtn').addEventListener('click', () => {
            document.getElementById('startScreen').classList.add('hidden');
            SoundManager.init();
            initGame();
            game.running = true;
        });

        document.getElementById('soundBtn').addEventListener('click', () => {
            SoundManager.toggle();
        });
        
        document.getElementById('restartBtn').addEventListener('click', () => {
            document.getElementById('gameOverScreen').classList.add('hidden');
            initGame();
            game.running = true;
        });
        
        // ì‹œì‘
        document.querySelector('.mode-btn[data-mode="learn"]').classList.add('ring-4', 'ring-white');
        gameLoop();
    </script>
</body>
</html>
