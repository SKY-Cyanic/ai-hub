<!DOCTYPE html>
<html lang="ko" class="dark">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>WikiGraph Pro Max (Dark)</title>

  <!-- Tailwind (Browser CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>

  <!-- vis-network -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/universal-sentence-encoder"></script>
  <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>

  <!-- Font -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">

  <style>
    :root {
      /* Dark Theme Enforcement */
      --bg-primary: #0b1220;
      --bg-secondary: #0f172a;
      --text-primary: #f1f5f9;
      --text-secondary: #94a3b8;
      --border-color: #1e293b;
      --glass-bg: rgba(15, 23, 42, 0.85);
      --highlight: #3b82f6;
      --highlight-hover: #2563eb;
    }

    body {
      font-family: 'Noto Sans KR', sans-serif;
      overflow: hidden;
      background-color: var(--bg-primary);
      color: var(--text-primary);
    }

    /* Common Utilities */
    .glass {
      background: var(--glass-bg);
      backdrop-filter: blur(12px);
      border: 1px solid var(--border-color);
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
    }

    .custom-scrollbar::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }

    .custom-scrollbar::-webkit-scrollbar-track {
      background: transparent;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb {
      background: #334155;
      border-radius: 999px;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
      background: #475569;
    }

    .loader {
      border: 2px solid var(--border-color);
      border-top: 2px solid var(--highlight);
      border-radius: 50%;
      width: 16px;
      height: 16px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    /* Context Menu */
    #context-menu {
      position: absolute;
      z-index: 50;
      display: none;
      min-width: 180px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
      border-radius: 0.75rem;
      overflow: hidden;
    }

    /* Minimap */
    #minimap-container {
      position: absolute;
      bottom: 20px;
      left: 20px;
      width: 240px;
      height: 170px;
      z-index: 40;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      overflow: hidden;
      display: none;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
    }

    #minimap {
      width: 100%;
      height: 100%;
      background: #0b1220;
    }

    #minimap-viewport {
      position: absolute;
      border: 2px solid rgba(59, 130, 246, 0.6);
      background: rgba(59, 130, 246, 0.15);
      pointer-events: none;
      z-index: 10;
      border-radius: 4px;
      transition: all 0.1s;
    }

    /* Input Range */
    input[type=range] {
      -webkit-appearance: none;
      width: 100%;
      background: transparent;
    }

    input[type=range]::-webkit-slider-thumb {
      -webkit-appearance: none;
      height: 16px;
      width: 16px;
      border-radius: 50%;
      background: var(--highlight);
      cursor: pointer;
      margin-top: -6px;
    }

    input[type=range]::-webkit-slider-runnable-track {
      width: 100%;
      height: 4px;
      cursor: pointer;
      background: var(--border-color);
      border-radius: 999px;
    }

    /* Tabs */
    .tab-btn {
      transition: color 0.2s, border-color 0.2s;
    }

    .tab-btn.active {
      border-bottom: 2px solid var(--highlight);
      color: var(--highlight);
    }

    /* Command Palette & KBD */
    .kbd {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.15rem 0.4rem;
      border-radius: 0.35rem;
      border: 1px solid var(--border-color);
      background: rgba(255, 255, 255, 0.05);
      font-size: 0.7rem;
      line-height: 1;
      color: var(--text-secondary);
      font-family: monospace;
    }

    /* Animations */
    .fade-in {
      animation: fadeIn 200ms ease-out;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(5px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .pulse-ring {
      animation: pulse-ring 2s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
    }

    @keyframes pulse-ring {
      0% {
        transform: scale(0.9);
        box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7);
      }

      70% {
        transform: scale(1);
        box-shadow: 0 0 0 10px rgba(59, 130, 246, 0);
      }

      100% {
        transform: scale(0.9);
        box-shadow: 0 0 0 0 rgba(59, 130, 246, 0);
      }
    }

    /* Timeline */
    #timeline-container {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 80px;
      z-index: 35;
      background: rgba(15, 23, 42, 0.95);
      border-top: 1px solid var(--border-color);
      display: none;
      transition: transform 0.3s;
    }

    .timeline-track {
      display: flex;
      gap: 30px;
      padding: 10px 40px;
      overflow-x: auto;
      height: 100%;
      align-items: center;
    }

    .timeline-item {
      flex: none;
      display: flex;
      flex-direction: column;
      align-items: center;
      cursor: pointer;
      min-width: 60px;
      transition: transform 0.2s;
    }

    .timeline-item:hover {
      transform: scale(1.1);
    }

    .timeline-year {
      font-weight: bold;
      font-size: 0.8rem;
      color: var(--highlight);
    }

    .timeline-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--border-color);
      margin: 4px 0;
    }

    .timeline-item.active .timeline-dot {
      background: var(--highlight);
      box-shadow: 0 0 10px var(--highlight);
    }

    .timeline-label {
      font-size: 0.65rem;
      color: var(--text-secondary);
      max-width: 80px;
      text-align: center;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Race Widget */
    #race-widget {
      position: absolute;
      top: 20px;
      right: 20px;
      z-index: 40;
      display: none;
    }

    /* Recommendation Cards */
    .reco-card {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      padding: 10px;
      transition: all 0.2s;
      cursor: pointer;
    }

    .reco-card:hover {
      background: rgba(59, 130, 246, 0.1);
      border-color: rgba(59, 130, 246, 0.3);
    }

    /* TTS Text Highlight */
    .tts-highlight {
      background-color: rgba(59, 130, 246, 0.4);
      border-bottom: 2px solid var(--highlight);
      transition: all 0.2s;
    }

    /* Race Specific */
    .race-log-item {
      border-left: 2px solid #334155;
      padding-left: 10px;
      position: relative;
    }

    .race-log-item::before {
      content: '';
      position: absolute;
      left: -5px;
      top: 0;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #475569;
    }

    .race-log-item.current::before {
      background: var(--highlight);
      box-shadow: 0 0 8px var(--highlight);
    }

    /* Global View Mode */
    body.global-view-active #sidebar,
    body.global-view-active nav,
    body.global-view-active #minimap-container,
    body.global-view-active #stats-hud,
    body.global-view-active #timeline-container,
    body.global-view-active #floating-controls-container,
    body.global-view-active #race-widget {
      display: none !important;
    }

    body.global-view-active #global-view-exit {
      display: flex !important;
    }
  </style>
</head>

<body class="h-screen flex flex-col selection:bg-blue-500 selection:text-white">

  <!-- Navbar -->
  <nav class="glass h-16 flex-none z-30 relative">
    <div class="max-w-full mx-auto px-4 h-full flex items-center justify-between gap-4">

      <!-- Left: Logo & Lang -->
      <div class="flex items-center gap-3 min-w-fit">
        <button class="lg:hidden p-2 rounded-lg hover:bg-white/5 text-gray-400" onclick="toggleSidebar()">
          <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
          </svg>
        </button>

        <div class="flex items-center gap-2 cursor-pointer hover:opacity-80 transition" onclick="resetApp()"
          title="ì´ˆê¸° í™”ë©´ìœ¼ë¡œ">
          <div
            class="bg-gradient-to-br from-blue-600 to-indigo-600 text-white p-1.5 rounded-lg shadow-lg shadow-blue-900/20">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
              stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
            </svg>
          </div>
          <span class="text-xl font-bold tracking-tight hidden md:block text-slate-100">Wiki<span
              class="text-blue-500">Graph</span></span>
        </div>

        <select id="lang-select"
          class="bg-slate-800/50 border border-slate-700 text-slate-200 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-1.5 outline-none hover:bg-slate-800 transition">
          <option value="ko" selected>ğŸ‡°ğŸ‡· KO</option>
          <option value="en">ğŸ‡ºğŸ‡¸ EN</option>
          <option value="ja">ğŸ‡¯ğŸ‡µ JA</option>
          <option value="zh">ğŸ‡¨ğŸ‡³ ZH</option>
          <option value="de">ğŸ‡©ğŸ‡ª DE</option>
          <option value="fr">ğŸ‡«ğŸ‡· FR</option>
        </select>
      </div>

      <!-- Search -->
      <div class="flex-1 max-w-xl relative group z-50">
        <div class="relative">
          <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
            <svg class="h-5 w-5 text-slate-500 group-focus-within:text-blue-500 transition-colors" fill="none"
              viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
          </div>

          <input type="text" id="search-input" autocomplete="off"
            class="block w-full pl-10 pr-24 py-2 border border-slate-700 rounded-full leading-5 bg-slate-900/50 text-slate-200 placeholder-slate-500 focus:outline-none focus:bg-slate-900 focus:ring-2 focus:ring-blue-500/50 transition-all shadow-sm"
            placeholder="ê²€ìƒ‰ì–´ ì…ë ¥ (ë‹¨ì¶•í‚¤: /)" />

          <div class="absolute inset-y-0 right-0 flex items-center pr-1 gap-1">
            <button id="palette-btn"
              class="hidden sm:flex items-center gap-2 px-2 py-1 rounded-md text-xs text-slate-500 hover:text-slate-300 hover:bg-white/5 transition"
              title="ëª…ë ¹ íŒ”ë ˆíŠ¸ (Ctrl+K)" onclick="openPalette()">
              <span class="kbd">Ctrl K</span>
            </button>
            <button id="search-btn"
              class="bg-blue-600 hover:bg-blue-700 text-white rounded-full p-1.5 px-3 text-sm font-medium transition-colors shadow-sm flex items-center gap-1">
              Go
            </button>
          </div>
        </div>
        <div id="autocomplete-list"
          class="hidden shadow-xl rounded-b-xl border border-slate-700 border-t-0 absolute top-full left-0 right-0 bg-slate-900 overflow-hidden z-50">
        </div>
      </div>

      <!-- Actions -->
      <div class="flex items-center gap-1.5">
        <button onclick="toggleModal('workspace-modal')"
          class="p-2 text-slate-400 hover:text-blue-400 hover:bg-white/5 rounded-full transition-colors" title="ì›Œí¬ìŠ¤í˜ì´ìŠ¤">
          <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M3 7a2 2 0 012-2h6l2 2h6a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V7z" />
          </svg>
        </button>

        <button onclick="toggleModal('bookmarks-modal')"
          class="p-2 text-slate-400 hover:text-yellow-400 hover:bg-white/5 rounded-full transition-colors relative"
          title="ë¶ë§ˆí¬">
          <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z" />
          </svg>
          <span id="bookmark-badge" class="absolute top-1.5 right-1.5 h-2 w-2 bg-red-500 rounded-full hidden"></span>
        </button>

        <button onclick="toggleModal('settings-modal')"
          class="p-2 text-slate-400 hover:text-slate-200 hover:bg-white/5 rounded-full transition-colors" title="ì„¤ì •">
          <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
          </svg>
        </button>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="flex-1 flex overflow-hidden relative">

    <!-- Sidebar -->
    <aside id="sidebar"
      class="w-full lg:w-96 glass border-r border-slate-800 flex flex-col absolute lg:static inset-y-0 left-0 transform -translate-x-full lg:translate-x-0 transition-transform duration-300 z-20">
      <div class="p-3 border-b border-slate-800 flex justify-between items-center bg-slate-900/50">
        <h2 class="font-bold text-slate-200 flex items-center gap-2">
          <svg class="h-5 w-5 text-blue-500" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd"
              d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"
              clip-rule="evenodd" />
          </svg>
          ì •ë³´ íŒ¨ë„
        </h2>
        <button onclick="toggleSidebar()" class="lg:hidden text-slate-400 hover:text-white">
          <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>

      <!-- Tabs -->
      <div class="flex border-b border-slate-800 bg-slate-900/30 overflow-x-auto custom-scrollbar">
        <button onclick="switchTab('info')" id="tab-info"
          class="tab-btn flex-none px-4 py-3 text-sm font-medium text-slate-400 hover:text-blue-400 active whitespace-nowrap">ì •ë³´</button>
        <button onclick="switchTab('ai')" id="tab-ai"
          class="tab-btn flex-none px-4 py-3 text-sm font-medium text-slate-400 hover:text-blue-400 whitespace-nowrap">AI
          ë¶„ì„</button>
        <button onclick="switchTab('notes')" id="tab-notes"
          class="tab-btn flex-none px-4 py-3 text-sm font-medium text-slate-400 hover:text-blue-400 whitespace-nowrap">ë©”ëª¨/íƒœê·¸</button>
        <button onclick="switchTab('media')" id="tab-media"
          class="tab-btn flex-none px-4 py-3 text-sm font-medium text-slate-400 hover:text-blue-400 whitespace-nowrap">ë¯¸ë””ì–´</button>
        <button onclick="switchTab('cluster')" id="tab-cluster"
          class="tab-btn flex-none px-4 py-3 text-sm font-medium text-slate-400 hover:text-blue-400 whitespace-nowrap">ê·¸ë£¹(ë§µ)</button>
      </div>

      <div id="sidebar-content" class="flex-1 overflow-y-auto p-4 custom-scrollbar bg-slate-900">
        <div class="text-center text-slate-500 mt-20 flex flex-col items-center">
          <svg class="w-12 h-12 text-slate-700 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          <p class="text-sm">ë…¸ë“œë¥¼ ì„ íƒí•˜ì—¬<br>ìƒì„¸ ì •ë³´ë¥¼ í™•ì¸í•˜ì„¸ìš”.</p>
        </div>
      </div>

      <!-- History -->
      <div class="p-3 border-t border-slate-800 bg-slate-900/50">
        <div class="flex justify-between items-center mb-2">
          <p class="text-xs font-bold text-slate-500 uppercase">ìµœê·¼ íƒìƒ‰</p>
          <button onclick="clearHistory()" class="text-xs text-red-400 hover:text-red-500">ì§€ìš°ê¸°</button>
        </div>
        <div id="recent-tags" class="flex flex-wrap gap-2 max-h-24 overflow-y-auto custom-scrollbar"></div>
      </div>
    </aside>

    <!-- Graph Area -->
    <main class="flex-1 relative bg-[#0b1220] overflow-hidden">
      <div id="network" class="w-full h-full cursor-grab active:cursor-grabbing"></div>

      <!-- Minimap -->
      <div id="minimap-container">
        <div id="minimap"></div>
        <div id="minimap-viewport"></div>
      </div>

      <!-- Status -->
      <div id="status-msg"
        class="absolute top-4 left-1/2 transform -translate-x-1/2 glass px-4 py-2 rounded-full text-sm text-slate-200 flex items-center gap-2 hidden z-10 border border-blue-500/30">
        <div class="loader"></div>
        <span id="status-text">ì²˜ë¦¬ ì¤‘...</span>
      </div>

      <!-- Stats HUD -->
      <div id="stats-hud"
        class="absolute top-4 left-4 glass rounded-xl px-3 py-2 text-xs text-slate-200 z-10 hidden sm:block border border-slate-700">
        <div class="flex items-center gap-4">
          <div class="flex flex-col">
            <span class="text-slate-500 text-[10px]">NODES</span>
            <span id="stat-nodes" class="font-bold text-blue-400 text-sm">0</span>
          </div>
          <div class="flex flex-col">
            <span class="text-slate-500 text-[10px]">CITS (Citation)</span>
            <span id="stat-cits" class="font-bold text-green-400 text-sm">0</span>
          </div>
          <div class="flex flex-col">
            <span class="text-slate-500 text-[10px]">PINNED</span>
            <span id="stat-pins" class="font-bold text-yellow-500 text-sm">0</span>
          </div>
          <div class="h-8 w-[1px] bg-slate-800"></div>
          <button onclick="toggleModal('semantic-modal')"
            class="flex flex-col items-center hover:text-purple-400 transition relative" title="AI ì‹œë§¨í‹± íƒìƒ‰">
            <span class="text-purple-500 font-bold text-[10px]">ğŸ¤– AI CRAWL</span>
            <span class="text-[9px] text-slate-500">ì‹œë§¨í‹± íƒìƒ‰</span>
            <div class="absolute -top-1 -right-2 bg-purple-600 text-[7px] text-white px-1 rounded-full font-bold">BETA
            </div>
          </button>
          <div class="h-8 w-[1px] bg-slate-800"></div>
          <button onclick="toggleRaceMode(true)" class="flex flex-col items-center hover:text-green-400 transition">
            <span class="text-green-500 font-bold text-[10px]">ğŸ RACE</span>
            <span class="text-[9px] text-slate-500">ê²Œì„ ì‹œì‘</span>
          </button>
        </div>
        <div class="border-t border-slate-700 mt-1 pt-1 text-[10px] text-slate-400">
          Sel: <span id="stat-selected" class="text-white">-</span> (Link: <span id="stat-degree">0</span>)
        </div>
      </div>

      <!-- Wiki Race HUD -->
      <div id="race-widget"
        class="glass rounded-2xl p-4 border-2 border-green-500/50 min-w-48 shadow-lg shadow-green-900/20">
        <div class="flex justify-between items-start mb-2">
          <span class="text-green-400 font-bold text-xs uppercase tracking-widest">ğŸ ìœ„í‚¤ ë ˆì´ìŠ¤ ëª¨ë“œ</span>
          <button onclick="toggleRaceMode(false)" class="text-slate-500 hover:text-white">Ã—</button>
        </div>
        <div class="space-y-1">
          <div class="text-[10px] text-slate-500">ëª©í‘œ ì§€ì :</div>
          <div id="race-target" class="text-sm font-bold text-white truncate">ì„ íƒ ì•ˆë¨</div>
          <div class="flex justify-between mt-3 text-xs">
            <span>ğŸ‘£ í´ë¦­ ìˆ˜: <b id="race-clicks" class="text-green-400">0</b></span>
            <span>â± <b id="race-timer" class="text-slate-300">00:00</b></span>
          </div>
        </div>
      </div>

      <!-- Timeline Area -->
      <div id="timeline-container">
        <div
          class="flex items-center px-4 bg-slate-900 border-b border-slate-700 h-6 text-[10px] text-slate-500 font-bold uppercase justify-between">
          <span>â³ ì§€ì‹ íƒ€ì„ë¼ì¸ (ì—°ëŒ€ìˆœ)</span>
          <button onclick="toggleTimeline(false)" class="hover:text-white">ë‹«ê¸°</button>
        </div>
        <div id="timeline-track" class="timeline-track custom-scrollbar">
          <!-- Timeline items injected here -->
        </div>
      </div>

      <!-- Floating Controls -->
      <div id="floating-controls-container" class="absolute bottom-6 right-6 flex flex-col gap-3 z-10">
        <!-- Global View Beta Button -->
        <button onclick="toggleGlobalView(true)"
          class="glass rounded-full w-12 h-12 flex items-center justify-center text-slate-300 hover:text-orange-400 hover:bg-orange-500/10 transition border border-slate-700 hover:border-orange-500/50"
          title="ê¸€ë¡œë²Œ ì „ì²´ ë·°">
          <span class="text-[10px] font-black leading-none text-center">FULL<br>VIEW</span>
        </button>

        <!-- Auto Explore -->
        <button id="auto-explore-btn" onclick="toggleAutoExplore()"
          class="glass rounded-full w-12 h-12 flex items-center justify-center text-slate-300 hover:text-green-400 hover:bg-green-500/10 transition border border-slate-700 hover:border-green-500/50"
          title="ìë™ íƒí—˜ ì‹œì‘/ì •ì§€">
          <svg id="auto-play-icon" class="w-6 h-6 ml-0.5" fill="currentColor" viewBox="0 0 24 24">
            <path d="M8 5v14l11-7z" />
          </svg>
          <svg id="auto-pause-icon" class="w-6 h-6 hidden" fill="currentColor" viewBox="0 0 24 24">
            <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z" />
          </svg>
        </button>

        <!-- Layout Controls -->
        <div class="glass rounded-xl p-2 flex flex-col gap-1 bg-slate-900/80 border border-slate-700">
          <button onclick="changeLayout('standard')"
            class="p-2 text-slate-400 hover:bg-white/10 hover:text-blue-400 rounded-lg transition" title="ë¬¼ë¦¬ ë°°ì¹˜">
            <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5" />
            </svg>
          </button>
          <button onclick="changeLayout('circular')"
            class="p-2 text-slate-400 hover:bg-white/10 hover:text-blue-400 rounded-lg transition" title="ì›í˜• ë°°ì¹˜">
            <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M12 2a10 10 0 100 20 10 10 0 000-20z" />
            </svg>
          </button>
        </div>

        <div class="glass rounded-xl p-2 flex flex-col gap-1 bg-slate-900/80 border border-slate-700">
          <button onclick="zoomIn()"
            class="p-2 text-slate-400 hover:bg-white/10 hover:text-blue-400 rounded-lg transition" title="í™•ëŒ€"><svg
              class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
            </svg></button>
          <button onclick="zoomOut()"
            class="p-2 text-slate-400 hover:bg-white/10 hover:text-blue-400 rounded-lg transition" title="ì¶•ì†Œ"><svg
              class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4" />
            </svg></button>
          <button onclick="fitGraph()"
            class="p-2 text-slate-400 hover:bg-white/10 hover:text-blue-400 rounded-lg transition" title="í™”ë©´ ë§ì¶¤"><svg
              class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" />
            </svg></button>
          <button onclick="downloadImage()"
            class="p-2 text-slate-400 hover:bg-white/10 hover:text-blue-400 rounded-lg transition" title="ìº¡ì²˜"><svg
              class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg></button>
        </div>
      </div>

    </main>
  </div>

  <!-- Context Menu -->
  <div id="context-menu" class="text-sm font-medium text-slate-200">
    <div id="ctx-title"
      class="px-4 py-2 bg-slate-800 border-b border-slate-700 text-slate-400 text-xs font-bold uppercase truncate">Title
    </div>
    <button onclick="ctxAction('expand')"
      class="w-full text-left px-4 py-2 hover:bg-blue-600/20 hover:text-blue-400 flex items-center gap-2">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
      </svg> í™•ì¥
    </button>
    <button onclick="ctxAction('focus')"
      class="w-full text-left px-4 py-2 hover:bg-blue-600/20 hover:text-blue-400 flex items-center gap-2">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z">
        </path>
      </svg> í¬ì»¤ìŠ¤
    </button>
    <button onclick="ctxAction('open')"
      class="w-full text-left px-4 py-2 hover:bg-blue-600/20 hover:text-blue-400 flex items-center gap-2">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
      </svg> ì—´ê¸°
    </button>
    <button onclick="ctxAction('pin')"
      class="w-full text-left px-4 py-2 hover:bg-blue-600/20 hover:text-blue-400 flex items-center gap-2">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"></path>
      </svg> <span id="ctx-pin-text">ê³ ì •</span>
    </button>
    <button onclick="ctxAction('bookmark')"
      class="w-full text-left px-4 py-2 hover:bg-blue-600/20 hover:text-blue-400 flex items-center gap-2">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"></path>
      </svg> ë¶ë§ˆí¬
    </button>
    <div class="border-t border-slate-700 my-1"></div>
    <button onclick="ctxAction('delete')"
      class="w-full text-left px-4 py-2 hover:bg-red-900/40 hover:text-red-400 flex items-center gap-2">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
        </path>
      </svg> ì‚­ì œ
    </button>
  </div>

  <!-- Settings Modal -->
  <div id="settings-modal"
    class="fixed inset-0 bg-black/70 z-50 hidden flex items-center justify-center backdrop-blur-sm">
    <div
      class="bg-slate-900 rounded-2xl shadow-2xl w-full max-w-md p-6 m-4 relative text-slate-200 border border-slate-800">
      <button onclick="toggleModal('settings-modal')" class="absolute top-4 right-4 text-slate-500 hover:text-white">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
      <h3 class="text-xl font-bold mb-6 flex items-center gap-2">
        <svg class="w-6 h-6 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
        </svg>
        ì„¤ì •
      </h3>
      <div class="space-y-6">
        <div>
          <div class="flex justify-between mb-2">
            <label class="text-sm font-medium text-slate-400">ë…¸ë“œ í™•ì¥ ê°œìˆ˜</label>
            <span id="limit-val" class="text-sm text-blue-400 font-bold bg-blue-500/10 px-2 py-0.5 rounded">15</span>
          </div>
          <input type="range" id="limit-range" min="5" max="50" value="15"
            oninput="updateSetting('maxLinks', this.value)">
        </div>
        <div>
          <div class="flex justify-between mb-2">
            <label class="text-sm font-medium text-slate-400">ë…¸ë“œ ê°„ ê±°ë¦¬</label>
            <span id="dist-val" class="text-sm text-blue-400 font-bold bg-blue-500/10 px-2 py-0.5 rounded">200</span>
          </div>
          <input type="range" id="dist-range" min="50" max="400" value="200"
            oninput="updateSetting('springLength', this.value)">
        </div>
        <div class="flex flex-col gap-2">
          <label
            class="flex items-center justify-between cursor-pointer p-3 rounded-lg bg-slate-800/50 hover:bg-slate-800">
            <span>ë¯¸ë‹ˆë§µ í‘œì‹œ</span>
            <input type="checkbox" id="minimap-toggle" class="accent-blue-600 w-5 h-5"
              onchange="toggleMinimap(this.checked)">
          </label>
          <label
            class="flex items-center justify-between cursor-pointer p-3 rounded-lg bg-slate-800/50 hover:bg-slate-800">
            <span>ë¬¼ë¦¬ ì—”ì§„ (Physics)</span>
            <input type="checkbox" id="physics-toggle" class="accent-blue-600 w-5 h-5" checked
              onchange="togglePhysics(this.checked)">
          </label>
        </div>
        <div class="pt-4 border-t border-slate-800">
          <button onclick="clearGraph(); toggleModal('settings-modal')"
            class="w-full py-2.5 bg-red-500/10 text-red-400 rounded-lg hover:bg-red-500/20 transition font-medium border border-red-500/20">ê·¸ë˜í”„
            ì „ì²´ ì´ˆê¸°í™”</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bookmarks Modal -->
  <div id="bookmarks-modal"
    class="fixed inset-0 bg-black/70 z-50 hidden flex items-center justify-center backdrop-blur-sm">
    <div
      class="bg-slate-900 rounded-2xl shadow-2xl w-full max-w-md p-6 m-4 relative h-[500px] flex flex-col text-slate-200 border border-slate-800">
      <button onclick="toggleModal('bookmarks-modal')" class="absolute top-4 right-4 text-slate-500 hover:text-white">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
      <h3 class="text-xl font-bold mb-4 flex items-center gap-2 text-yellow-500">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z" />
        </svg>
        ë¶ë§ˆí¬
      </h3>
      <div id="bookmark-list" class="flex-1 overflow-y-auto custom-scrollbar space-y-2 p-1"></div>
    </div>
  </div>

  <!-- Workspace Modal -->
  <div id="workspace-modal"
    class="fixed inset-0 bg-black/70 z-50 hidden flex items-center justify-center backdrop-blur-sm">
    <div
      class="bg-slate-900 rounded-2xl shadow-2xl w-full max-w-2xl m-4 relative flex flex-col text-slate-200 border border-slate-800 overflow-hidden max-h-[90vh]">
      <div class="p-4 border-b border-slate-800 flex justify-between items-center bg-slate-900/50">
        <h3 class="text-xl font-bold flex items-center gap-2">
          <svg class="w-6 h-6 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M3 7a2 2 0 012-2h6l2 2h6a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V7z" />
          </svg>
          ì›Œí¬ìŠ¤í˜ì´ìŠ¤
        </h3>
        <button onclick="toggleModal('workspace-modal')" class="text-slate-500 hover:text-white">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>

      <div class="flex flex-col md:flex-row flex-1 overflow-hidden">
        <div
          class="w-full md:w-48 border-b md:border-b-0 md:border-r border-slate-800 bg-slate-900/50 p-3 flex flex-col gap-2">
          <button
            class="ws-tab-btn active w-full text-left px-3 py-2 rounded-lg hover:bg-white/5 text-sm font-medium transition"
            onclick="switchWsTab('sessions')">ì €ì¥ëœ ì„¸ì…˜</button>
          <button
            class="ws-tab-btn w-full text-left px-3 py-2 rounded-lg hover:bg-white/5 text-sm font-medium transition"
            onclick="switchWsTab('import')">ê°€ì ¸ì˜¤ê¸°/ë‚´ë³´ë‚´ê¸°</button>
          <button
            class="ws-tab-btn w-full text-left px-3 py-2 rounded-lg hover:bg-white/5 text-sm font-medium transition"
            onclick="switchWsTab('share')">ê³µìœ  ë§í¬</button>
          <button
            class="ws-tab-btn w-full text-left px-4 py-3 bg-blue-600/10 text-blue-400 rounded-lg hover:bg-blue-600/20 text-xs font-bold transition mt-auto flex items-center gap-2 border border-blue-500/20"
            onclick="exportKnowledgeReport()">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
              </path>
            </svg>
            ì§€ì‹ ë¦¬í¬íŠ¸ ì¶”ì¶œ
          </button>
        </div>
        <div class="flex-1 p-6 overflow-y-auto custom-scrollbar" id="ws-content">
          <!-- Content injected by JS -->
        </div>
      </div>
    </div>
  </div>

  <!-- Command Palette -->
  <div id="palette-modal"
    class="fixed inset-0 bg-black/80 z-50 hidden flex items-start justify-center pt-24 backdrop-blur-sm">
    <div class="bg-slate-900 w-full max-w-2xl mx-4 rounded-xl shadow-2xl border border-slate-700 overflow-hidden">
      <div class="p-3 border-b border-slate-800">
        <input id="palette-input"
          class="w-full bg-transparent text-slate-200 placeholder-slate-500 outline-none text-lg px-2"
          placeholder="ëª…ë ¹ ë˜ëŠ” ë…¸ë“œ ê²€ìƒ‰..." autocomplete="off">
      </div>
      <div id="palette-list" class="max-h-80 overflow-y-auto custom-scrollbar p-2"></div>
      <div class="p-2 border-t border-slate-800 bg-slate-950 text-xs text-slate-500 flex justify-end gap-3 px-4">
        <span><span class="kbd">â†‘â†“</span> ì´ë™</span>
        <span><span class="kbd">Enter</span> ì„ íƒ</span>
        <span><span class="kbd">Esc</span> ë‹«ê¸°</span>
      </div>
    </div>
  </div>

  <!-- Race Setup Modal -->
  <div id="race-setup-modal"
    class="fixed inset-0 bg-black/80 z-[60] hidden flex items-center justify-center backdrop-blur-md">
    <div
      class="bg-slate-900 w-full max-w-md p-8 rounded-3xl border border-green-500/30 shadow-2xl relative overflow-hidden">
      <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-green-500 to-blue-500"></div>
      <h3 class="text-2xl font-bold text-white mb-6 flex items-center gap-2">
        <span class="text-3xl">ğŸ</span> ìœ„í‚¤ ë ˆì´ìŠ¤ ì¤€ë¹„
      </h3>
      <div class="space-y-4">
        <div class="grid grid-cols-1 gap-4">
          <div>
            <label class="block text-xs font-bold text-slate-500 uppercase tracking-widest mb-2">ì‹œì‘ ì§€ì  (Starting
              point)</label>
            <div class="flex gap-2">
              <input id="race-input-start"
                class="flex-1 bg-slate-800 border border-slate-700 rounded-xl px-4 py-2.5 text-sm text-white outline-none focus:border-blue-500 transition"
                placeholder="ì–´ë””ì„œ ì‹œì‘í• ê¹Œìš”?">
              <button onclick="setRandomRaceStart()"
                class="bg-slate-800 hover:bg-slate-700 border border-slate-700 px-3 rounded-xl"
                title="ëœë¤ ì‹œì‘">ğŸ²</button>
            </div>
          </div>
          <div>
            <label class="block text-xs font-bold text-slate-500 uppercase tracking-widest mb-2">ëª©í‘œ ì£¼ì œ (Target
              theme)</label>
            <div class="flex gap-2">
              <input id="race-input-target"
                class="flex-1 bg-slate-800 border border-slate-700 rounded-xl px-4 py-2.5 text-sm text-white outline-none focus:border-green-500 transition"
                placeholder="ì–´ë””ì— ë„ì°©í• ê¹Œìš”?">
              <button onclick="setRandomRaceTarget()"
                class="bg-slate-800 hover:bg-slate-700 border border-slate-700 px-3 rounded-xl"
                title="ëœë¤ ëª©í‘œ">ğŸ²</button>
            </div>
          </div>
        </div>
        <div
          class="bg-indigo-600/10 p-3 rounded-xl border border-indigo-500/20 text-[10px] text-indigo-300 leading-tight">
          ğŸ’¡ <b>ë ˆì´ìŠ¤ ì •ì¹™:</b> ì‹œì‘ ì‹œ í˜„ì¬ ì‘ì—… ì„¸ì…˜ì´ ìë™ ì €ì¥ë©ë‹ˆë‹¤. ë ˆì´ìŠ¤ ì¤‘ì—ëŠ” ê²€ìƒ‰ ê¸°ëŠ¥ì´ ì œí•œë˜ë©° ì˜¤ì§ ë…¸ë“œ í´ë¦­ìœ¼ë¡œë§Œ ì´ë™í•´ì•¼ í•©ë‹ˆë‹¤.
        </div>
        <div class="bg-slate-800/50 p-4 rounded-2xl border border-slate-800 space-y-2">
          <h4 class="text-xs font-bold text-green-500 uppercase tracking-widest flex items-center gap-1">
            <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd"
                d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"
                clip-rule="evenodd"></path>
            </svg>
            ê²Œì„ ë°©ë²• (Race Guide)
          </h4>
          <ul class="text-[11px] text-slate-400 space-y-2">
            <li class="flex gap-2">
              <span class="text-green-500 font-bold">01.</span>
              <span><b>ëª©í‘œ ì„¤ì •:</b> ë„ì°©í•˜ê³  ì‹¶ì€ ìœ„í‚¤ë°±ê³¼ ì£¼ì œë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.</span>
            </li>
            <li class="flex gap-2">
              <span class="text-green-500 font-bold">02.</span>
              <span><b>ë…¸ë“œ í´ë¦­:</b> í˜„ì¬ ìœ„ì¹˜ì—ì„œ <b>ì—°ê²°ëœ ë…¸ë“œë§Œ</b> í´ë¦­í•˜ì—¬ ì´ë™í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</span>
            </li>
            <li class="flex gap-2">
              <span class="text-green-500 font-bold">03.</span>
              <span><b>ëª©í‘œ ë„ë‹¬:</b> ìµœì†Œí•œì˜ í´ë¦­ê³¼ ì‹œê°„ìœ¼ë¡œ ëª©í‘œ ì£¼ì œë¥¼ ì°¾ì•„ë‚´ë©´ ìŠ¹ë¦¬!</span>
            </li>
          </ul>
        </div>
        <div class="flex gap-3 pt-2">
          <button onclick="toggleModal('race-setup-modal')"
            class="flex-1 py-3 bg-slate-800 hover:bg-slate-700 text-slate-300 rounded-xl font-bold transition">ì·¨ì†Œ</button>
          <button onclick="startRaceFromSetup()"
            class="flex-[2] py-3 bg-green-600 hover:bg-green-700 text-white rounded-xl font-bold shadow-lg shadow-green-900/20 transition">ë ˆì´ìŠ¤
            ì‹œì‘!</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Semantic AI Modal -->
  <div id="semantic-modal"
    class="fixed inset-0 bg-black/60 z-[60] hidden items-center justify-center p-4 backdrop-blur-sm">
    <div
      class="bg-slate-900 w-full max-w-md rounded-2xl border border-slate-700 shadow-2xl overflow-hidden flex flex-col">
      <div class="p-4 border-b border-slate-800 flex justify-between items-center bg-slate-900/50">
        <h3 class="font-bold text-slate-200 flex items-center gap-2">
          <svg class="h-5 w-5 text-purple-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
          </svg>
          AI ì‹œë§¨í‹± íƒìƒ‰ (Beta)
        </h3>
        <button onclick="toggleModal('semantic-modal')" class="text-slate-500 hover:text-white transition">Ã—</button>
      </div>
      <div class="p-6 space-y-6">
        <div class="space-y-4">
          <div>
            <label class="block text-xs font-bold text-slate-500 uppercase tracking-widest mb-2">ì¤‘ì‹¬ ì£¼ì œ (Seed
              Topic)</label>
            <input type="text" id="ai-seed-input"
              class="w-full bg-slate-800 border border-slate-700 rounded-xl px-4 py-3 text-slate-200 focus:ring-2 focus:ring-purple-500 outline-none"
              placeholder="ì˜ˆ: ì¸ê³µì§€ëŠ¥, ìš°ì£¼ë¡ , ì–‘ìì—­í•™">
          </div>
          <div>
            <div class="flex justify-between items-center mb-2">
              <label class="block text-xs font-bold text-slate-500 uppercase tracking-widest">ìœ ì‚¬ë„ ì„ê³„ê°’
                (Threshold)</label>
              <span id="ai-threshold-val" class="text-xs text-purple-400 font-bold">0.4</span>
            </div>
            <input type="range" min="0" max="0.9" step="0.05" value="0.4" id="ai-threshold-range"
              class="w-full h-2 bg-slate-800 rounded-lg appearance-none cursor-pointer accent-purple-500"
              oninput="document.getElementById('ai-threshold-val').innerText = this.value; CONFIG.semanticThreshold = Number(this.value)">
            <p class="text-[10px] text-slate-500 mt-2">ë‚®ì„ìˆ˜ë¡ ë„“ì€ ì£¼ì œë¥¼, ë†’ì„ìˆ˜ë¡ í•µì‹¬ ì£¼ì œë§Œ íƒìƒ‰í•©ë‹ˆë‹¤.</p>
          </div>
        </div>

        <div id="ai-status-panel" class="bg-slate-800/50 p-4 rounded-xl border border-slate-800 hidden">
          <div class="flex justify-between items-center mb-2">
            <span class="text-xs text-slate-400">ëª¨ë¸ ìƒíƒœ: <b id="ai-model-status" class="text-yellow-500">ë¡œë”© ëŒ€ê¸°
                ì¤‘</b></span>
            <div id="ai-spinner" class="loader w-3 h-3 hidden"></div>
          </div>
          <div class="grid grid-cols-2 gap-2 text-center mt-3">
            <div class="bg-slate-900 p-2 rounded-lg">
              <span class="block text-[8px] text-slate-600 uppercase">ë°œê²¬ëœ ë…¸ë“œ</span>
              <span id="ai-found-count" class="text-sm font-bold text-blue-400">0</span>
            </div>
            <div class="bg-slate-900 p-2 rounded-lg">
              <span class="block text-[8px] text-slate-600 uppercase">ì°¨ë‹¨(ë¶€ì ì ˆ)</span>
              <span id="ai-filtered-count" class="text-sm font-bold text-red-400">0</span>
            </div>
          </div>
        </div>

        <div class="flex gap-3">
          <button id="ai-stop-btn" onclick="stopSemanticCrawl()"
            class="hidden flex-1 py-3 bg-red-600/20 hover:bg-red-600/30 text-red-400 rounded-xl font-bold transition border border-red-500/20">ì¤‘ì§€</button>
          <button id="ai-start-btn" onclick="startSemanticCrawl()"
            class="flex-1 py-3 bg-purple-600 hover:bg-purple-700 text-white rounded-xl font-bold shadow-lg shadow-purple-900/20 transition">íƒìƒ‰
            ì‹œì‘</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Race Result Modal -->
  <div id="race-result-modal"
    class="fixed inset-0 bg-black/90 z-[70] hidden flex items-center justify-center backdrop-blur-xl">
    <div
      class="bg-slate-900 w-full max-w-lg p-10 rounded-[2.5rem] border-2 border-yellow-500/30 shadow-[0_0_50px_rgba(234,179,8,0.15)] text-center relative overflow-hidden">
      <div id="confetti-container" class="absolute inset-0 pointer-events-none"></div>
      <div class="text-6xl mb-4">ğŸ†</div>
      <h2 class="text-4xl font-black text-white mb-2 tracking-tighter italic">FINISH!</h2>
      <p class="text-yellow-500 font-bold tracking-widest uppercase text-sm mb-8">ëª©í‘œ ì§€ì ì— ë„ë‹¬í–ˆìŠµë‹ˆë‹¤</p>

      <div class="grid grid-cols-2 gap-4 mb-10">
        <div class="bg-white/5 p-4 rounded-3xl border border-white/10">
          <span class="block text-[10px] text-slate-500 uppercase font-black mb-1">ì´ í´ë¦­ ìˆ˜</span>
          <span id="result-clicks" class="text-3xl font-black text-white">0</span>
        </div>
        <div class="bg-white/5 p-4 rounded-3xl border border-white/10">
          <span class="block text-[10px] text-slate-500 uppercase font-black mb-1">ì†Œìš” ì‹œê°„</span>
          <span id="result-time" class="text-3xl font-black text-white">00:00</span>
        </div>
      </div>

      <div class="text-left mb-10">
        <label class="block text-[10px] text-slate-500 uppercase font-black mb-3 px-2">ì´ë™ ê²½ë¡œ (Race Log)</label>
        <div id="result-path" class="max-h-40 overflow-y-auto custom-scrollbar px-2 space-y-3">
          <!-- Log items -->
        </div>
      </div>

      <div class="flex gap-4">
        <button onclick="toggleModal('race-result-modal')"
          class="flex-1 py-4 bg-slate-800 hover:bg-slate-700 text-slate-300 rounded-2xl font-bold transition">ë‹«ê¸°</button>
        <button onclick="downloadImage();"
          class="flex-1 py-4 bg-blue-600 hover:bg-blue-700 text-white rounded-2xl font-bold shadow-lg shadow-blue-900/20 transition">ì¸ì¦ìƒ·
          ì €ì¥</button>
      </div>
    </div>
  </div>

  <script>
    // --- Configuration & State ---
    const CONFIG = {
      endpoints: {
        ko: 'https://ko.wikipedia.org/w/api.php',
        en: 'https://en.wikipedia.org/w/api.php',
        ja: 'https://ja.wikipedia.org/w/api.php',
        zh: 'https://zh.wikipedia.org/w/api.php',
        de: 'https://de.wikipedia.org/w/api.php',
        fr: 'https://fr.wikipedia.org/w/api.php'
      },
      maxLinks: 15,
      springLength: 200,
      lang: 'ko',
      semanticThreshold: 0.4
    };

    const STATE = {
      network: null,
      minimapNetwork: null,
      nodes: new vis.DataSet([]),
      edges: new vis.DataSet([]),
      processedNodes: new Set(),
      selectedNode: null,
      history: JSON.parse(localStorage.getItem('wg_history') || '[]'),
      bookmarks: JSON.parse(localStorage.getItem('wg_bookmarks') || '[]'),
      sessions: JSON.parse(localStorage.getItem('wg_sessions') || '[]'),
      contextMenuNode: null,
      currentTabData: null,
      activeTab: 'info',
      wsTab: 'sessions',
      autoExplore: {
        active: false,
        timer: null
      },
      palette: {
        open: false,
        items: [],
        index: 0
      },
      notes: JSON.parse(localStorage.getItem('wg_notes') || '{}'),
      clusters: {}, // Category based grouping
      race: {
        active: false,
        target: null,
        startTime: null,
        clicks: 0,
        timer: null,
        path: []
      },
      tts: {
        voice: null,
        rate: 1.0,
        voices: []
      },
      ai: {
        model: null,
        seedEmbedding: null,
        seedText: '',
        crawlActive: false,
        totalFiltered: 0,
        embeddings: {} // cache
      }
    };

    const COLORS = {
      node: {
        bg: '#3b82f6',
        border: '#60a5fa',
        highlight: '#fbbf24',
        levels: [
          { min: 0, bg: '#3b82f6', border: '#60a5fa' }, // Default Blue
          { min: 5, bg: '#8b5cf6', border: '#a78bfa' }, // Purple
          { min: 10, bg: '#ec4899', border: '#f472b6' }, // Pink/Rose
          { min: 20, bg: '#f59e0b', border: '#fbbf24' }  // Gold/Orange
        ]
      },
      edge: { color: '#475569', highlight: '#94a3b8', path: '#10b981' },
      font: { color: '#f1f5f9', stroke: '#0f172a' }
    };

    // --- Initialization ---
    document.addEventListener('DOMContentLoaded', () => {
      loadSettings();
      initNetwork();
      initMinimap();
      initListeners();
      renderHistory();
      renderBookmarks();

      // Auto Restore if hash exists
      if (location.hash.startsWith('#g=')) {
        restoreFromHash();
      } else {
        handleSearch('ì¸ê³µì§€ëŠ¥');
      }

      // Periodic stats update
      setInterval(updateStats, 1000);
    });

    function loadSettings() {
      try {
        const s = JSON.parse(localStorage.getItem('wg_settings'));
        if (s) {
          CONFIG.maxLinks = s.maxLinks || 15;
          CONFIG.springLength = s.springLength || 200;
          document.getElementById('limit-range').value = CONFIG.maxLinks;
          document.getElementById('limit-val').textContent = CONFIG.maxLinks;
          document.getElementById('dist-range').value = CONFIG.springLength;
          document.getElementById('dist-val').textContent = CONFIG.springLength;
        }
      } catch (e) { }
    }

    function initNetwork() {
      const container = document.getElementById('network');
      const data = { nodes: STATE.nodes, edges: STATE.edges };
      const options = {
        nodes: {
          shape: 'dot',
          size: 20,
          font: { size: 14, color: COLORS.font.color, face: 'Noto Sans KR', strokeWidth: 4, strokeColor: COLORS.font.stroke },
          borderWidth: 2,
          color: { background: COLORS.node.bg, border: COLORS.node.border, highlight: { background: COLORS.node.highlight, border: '#f59e0b' } },
          shadow: { enabled: true, color: 'rgba(0,0,0,0.5)', size: 10 },
        },
        edges: {
          width: 1,
          color: { color: COLORS.edge.color, highlight: COLORS.edge.highlight, opacity: 0.6 },
          smooth: { type: 'continuous' }
        },
        physics: {
          forceAtlas2Based: {
            gravitationalConstant: -100,
            centralGravity: 0.005,
            springLength: Number(CONFIG.springLength),
            springConstant: 0.09,
            damping: 0.9
          },
          solver: 'forceAtlas2Based',
          stabilization: { iterations: 150 }
        },
        interaction: { hover: true, tooltipDelay: 200, zoomView: true, keyboard: false }
      };

      STATE.network = new vis.Network(container, data, options);
      initTTS(); // Initialize TTS Voices

      STATE.network.on("click", (params) => {
        hideContextMenu();
        if (params.nodes.length > 0) {
          const nodeId = params.nodes[0];
          STATE.selectedNode = nodeId;
          fetchNodeDetails(nodeId);
          if (window.innerWidth < 1024) toggleSidebar(true);
        }
      });

      STATE.network.on("doubleClick", (params) => {
        if (params.nodes.length > 0) expandNode(params.nodes[0]);
      });

      STATE.network.on("oncontext", (params) => {
        params.event.preventDefault();
        const nodeId = STATE.network.getNodeAt(params.pointer.DOM);
        if (nodeId) {
          STATE.contextMenuNode = nodeId;
          showContextMenu(params.pointer.DOM.x, params.pointer.DOM.y, nodeId);
          STATE.network.selectNodes([nodeId]);
          STATE.selectedNode = nodeId;
        } else {
          hideContextMenu();
        }
      });

      STATE.network.on("afterDrawing", () => {
        syncMinimap();
      });

      STATE.network.on("zoom", () => syncMinimap());
      STATE.network.on("dragEnd", () => syncMinimap());

      // AI Input Auto-load & Enter key
      const aiInput = document.getElementById('ai-seed-input');
      if (aiInput) {
        aiInput.addEventListener('focus', () => initAIModel());
        aiInput.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') startSemanticCrawl();
        });
      }
    }

    // --- Minimap Logic ---
    function initMinimap() {
      const container = document.getElementById('minimap');
      const data = { nodes: STATE.nodes, edges: STATE.edges };
      const options = {
        nodes: { shape: 'dot', size: 15, font: { size: 0 }, borderWidth: 0, shadow: false },
        edges: { width: 1, color: '#1e293b', smooth: false, shadow: false },
        physics: false,
        interaction: { dragNodes: false, dragView: false, zoomView: false, selectable: false },
        layout: { improvedLayout: false }
      };
      STATE.minimapNetwork = new vis.Network(container, data, options);

      // Minimap click/drag to move
      const mmCont = document.getElementById('minimap-container');
      const handleMinimapInteraction = (e) => {
        if (e.buttons !== 1 && e.type !== 'click') return;
        const rect = container.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;

        // Map DOM pixel to Minimap Canvas coord
        const pos = STATE.minimapNetwork.DOMtoCanvas({ x, y });
        // Move main network to that world position
        STATE.network.moveTo({ position: pos, animation: { duration: 500, easingFunction: 'easeInOutQuad' } });
      };
      container.addEventListener('click', handleMinimapInteraction);
      container.addEventListener('mousemove', handleMinimapInteraction);
    }

    function syncMinimap() {
      const container = document.getElementById('minimap-container');
      if (container.style.display === 'none' || !STATE.minimapNetwork) return;

      // 1. Fit minimap to all data
      STATE.minimapNetwork.fit();

      // 2. Calculate main network's viewport in World Coords
      const mainCanvas = document.querySelector('#network canvas');
      if (!mainCanvas) return;

      const topLeft = STATE.network.DOMtoCanvas({ x: 0, y: 0 });
      const bottomRight = STATE.network.DOMtoCanvas({ x: mainCanvas.clientWidth, y: mainCanvas.clientHeight });

      // 3. Map World Coords to Minimap DOM Coords
      const mmTopLeft = STATE.minimapNetwork.canvasToDOM(topLeft);
      const mmBottomRight = STATE.minimapNetwork.canvasToDOM(bottomRight);

      // 4. Update Viewport Rect
      const viewport = document.getElementById('minimap-viewport');
      const width = mmBottomRight.x - mmTopLeft.x;
      const height = mmBottomRight.y - mmTopLeft.y;

      viewport.style.left = mmTopLeft.x + 'px';
      viewport.style.top = mmTopLeft.y + 'px';
      viewport.style.width = Math.max(5, width) + 'px';
      viewport.style.height = Math.max(5, height) + 'px';
    }

    // --- API & Core Logic ---
    async function expandNode(title) {
      if (STATE.processedNodes.has(title)) { setStatus("ì´ë¯¸ í™•ì¥ëœ ë…¸ë“œì…ë‹ˆë‹¤."); return; }
      setStatus(`"${title}" ì—°ê²° íƒìƒ‰ ì¤‘...`, true);

      if (!STATE.nodes.get(title)) {
        STATE.nodes.add({ id: title, label: title, value: 20 });
      }
      STATE.processedNodes.add(title);
      addToHistory(title);

      const params = new URLSearchParams({
        action: 'query', format: 'json', prop: 'links', titles: title,
        pllimit: 'max', plnamespace: 0, origin: '*'
      });

      try {
        const res = await fetch(`${CONFIG.endpoints[CONFIG.lang]}?${params.toString()}`);
        const data = await res.json();
        const pages = data.query.pages;
        const pid = Object.keys(pages)[0];
        const links = (pid !== "-1" && pages[pid].links) ? pages[pid].links.map(l => l.title) : [];

        // Clustering: Fetch categories for the current node to assign a group
        const catParams = new URLSearchParams({ action: 'query', format: 'json', prop: 'categories', titles: title, cllimit: 1, origin: '*' });
        const catRes = await fetch(`${CONFIG.endpoints[CONFIG.lang]}?${catParams.toString()}`);
        const catData = await catRes.json();
        const catPages = catData.query.pages;
        const catPid = Object.keys(catPages)[0];
        let catGroup = undefined;
        if (catPid !== "-1" && catPages[catPid].categories) {
          catGroup = catPages[catPid].categories[0].title.replace('ë¶„ë¥˜:', '').replace('Category:', '');
        }

        if (links.length) {
          const subset = links.sort(() => 0.5 - Math.random()).slice(0, Number(CONFIG.maxLinks));
          const newNodes = [];
          const newEdges = [];

          // Assign group to origin node
          STATE.nodes.update({ id: title, group: catGroup });

          subset.forEach(link => {
            if (!STATE.nodes.get(link) && !newNodes.find(n => n.id === link)) {
              newNodes.push({ id: link, label: link, value: 1 });
            }
            if (!STATE.edges.get({ filter: e => (e.from === title && e.to === link) || (e.from === link && e.to === title) }).length) {
              newEdges.push({ from: title, to: link });
            }
          });

          STATE.nodes.add(newNodes);
          STATE.edges.add(newEdges);
          updateNodeSizes();
        } else {
          setStatus("ì—°ê²°ëœ ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤.");
        }
      } catch (e) { console.error(e); setStatus("ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨"); }
      setStatus(null, false);
    }

    function updateNodeSizes() {
      const updates = [];
      STATE.nodes.forEach(node => {
        const outConnections = STATE.network.getConnectedNodes(node.id);
        const inLinks = STATE.edges.get({ filter: e => e.to === node.id }).length;
        const totalCount = outConnections.length;

        // Determine Color based on Total Level
        let style = COLORS.node.levels[0];
        for (let i = COLORS.node.levels.length - 1; i >= 0; i--) {
          if (totalCount >= COLORS.node.levels[i].min) {
            style = COLORS.node.levels[i];
            break;
          }
        }

        updates.push({
          id: node.id,
          value: Math.max(inLinks * 5, 8), // Size by Citation Index
          title: `ì¸ìš© ì§€ìˆ˜: ${inLinks}\nì´ ì—°ê²°: ${totalCount}\në¶„ë¥˜: ${node.group || 'ì—†ìŒ'}`,
          color: node.physics === false ? { background: '#1e293b', border: '#fbbf24' } : { background: style.bg, border: style.border }
        });
      });
      STATE.nodes.update(updates);

      // Update HUD Citation count
      if (STATE.selectedNode) {
        const selIn = STATE.edges.get({ filter: e => e.to === STATE.selectedNode }).length;
        const statCit = document.getElementById('stat-cits');
        if (statCit) statCit.innerText = selIn;
      }
    }

    async function fetchNodeDetails(title) {
      switchTab('info');
      const container = document.getElementById('sidebar-content');
      container.innerHTML = `<div class="flex h-40 items-center justify-center"><div class="loader"></div></div>`;

      // If in race mode
      if (STATE.race.active) {
        STATE.race.clicks++;
        STATE.race.path.push(title);
        document.getElementById('race-clicks').innerText = STATE.race.clicks;
        if (title === STATE.race.target) {
          endRace(true);
        }
      }

      const params = new URLSearchParams({
        action: 'query', format: 'json',
        prop: 'extracts|pageimages|extlinks|categories',
        titles: title,
        exintro: false, explaintext: true,
        pithumbsize: 600, ellimit: 20, cllimit: 10, origin: '*'
      });

      try {
        const res = await fetch(`${CONFIG.endpoints[CONFIG.lang]}?${params.toString()}`);
        const data = await res.json();
        const pages = data.query.pages;
        const pid = Object.keys(pages)[0];
        if (pid === "-1") throw new Error("Page not found");

        STATE.currentTabData = pages[pid];

        // Citation Analysis: Count inbound links from currently loaded network
        const inLinks = STATE.edges.get({ filter: e => e.to === title }).length;
        STATE.currentTabData.citationCount = inLinks;

        renderSidebarContent();
      } catch (e) {
        container.innerHTML = `<p class="text-red-400 p-4">ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>`;
      }
    }

    // --- Sidebar Rendering ---
    function switchTab(tab) {
      STATE.activeTab = tab;
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active', 'border-b-2', 'text-blue-400');
        if (btn.id === `tab-${tab}`) btn.classList.add('active');
      });
      if (STATE.currentTabData) renderSidebarContent();
    }

    async function renderSidebarContent() {
      const data = STATE.currentTabData;
      const container = document.getElementById('sidebar-content');
      if (!data) return;

      if (STATE.activeTab === 'info') {
        const thumb = data.thumbnail ? data.thumbnail.source : null;
        const intro = data.extract ? data.extract.split('\n')[0].substring(0, 1000) : "ë‚´ìš© ì—†ìŒ";
        const isBookmarked = STATE.bookmarks.includes(data.title);
        const citCount = data.citationCount || 0;

        container.innerHTML = `
          <div class="space-y-4 fade-in">
            ${thumb ? `<div class="rounded-xl overflow-hidden shadow-lg border border-slate-700 bg-slate-800"><img src="${thumb}" class="w-full h-48 object-cover"></div>` : ''}
            <div class="flex justify-between items-start">
              <div>
                <h2 class="text-2xl font-bold leading-tight">${data.title}</h2>
                <div class="flex items-center gap-2 mt-1">
                    <span class="text-[10px] bg-green-500/10 text-green-400 px-2 py-0.5 rounded border border-green-500/20 font-bold uppercase">Citation Index: ${citCount}</span>
                </div>
              </div>
              <button onclick="toggleBookmark('${escapeHtml(data.title)}')" class="text-yellow-500 hover:text-yellow-400">
                <svg class="w-6 h-6" fill="${isBookmarked ? 'currentColor' : 'none'}" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"></path></svg>
              </button>
            </div>
             <div class="flex flex-col gap-2 bg-slate-800/50 p-3 rounded-xl border border-slate-700">
                 <div class="flex justify-between items-center px-1">
                    <span class="text-[10px] font-bold text-slate-500 uppercase">Audio Docent</span>
                    <div class="flex gap-2">
                         <select id="tts-voice-select" onchange="STATE.tts.voice = STATE.tts.voices[this.value]" class="bg-transparent text-[10px] text-slate-400 outline-none border-none cursor-pointer hover:text-white transition"></select>
                         <div class="flex items-center gap-1">
                             <span class="text-[10px] text-slate-500">Speed</span>
                             <input type="range" min="0.5" max="2" step="0.1" value="1" oninput="STATE.tts.rate = this.value; document.getElementById('tts-rate-val').innerText = this.value+'x'" class="w-16 h-1 !bg-slate-700">
                             <span id="tts-rate-val" class="text-[10px] text-blue-400 w-6">1.0x</span>
                         </div>
                    </div>
                 </div>
                 <div class="flex gap-2">
                    <button onclick="speakTextWithHighlight('${escapeHtml(intro.substring(0, 1000))}')" class="flex-1 py-1.5 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-xs font-bold transition flex items-center justify-center gap-2">
                        <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z" /></svg> ì„¤ëª… ë“£ê¸°
                    </button>
                    <button onclick="window.speechSynthesis.cancel()" class="px-3 bg-slate-700 hover:bg-slate-600 text-slate-300 rounded-lg text-xs transition">ì¤‘ì§€</button>
                 </div>
             </div>
             
             <div id="intro-text-container" class="text-slate-300 text-sm leading-relaxed text-justify whitespace-pre-wrap">${intro}...</div>

            <a href="https://${CONFIG.lang}.wikipedia.org/wiki/${encodeURIComponent(data.title)}" target="_blank" class="w-full block text-center text-xs bg-slate-800 text-slate-400 py-2 rounded-lg border border-slate-700 hover:bg-slate-700 transition">ğŸ”— Wikipedia ì›ë¬¸ ë³´ê¸°</a>

            <!-- AI Recommendations -->
            <div class="border-t border-slate-800 pt-4 mt-6">
                <h3 class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-3 flex items-center gap-2">
                    <svg class="w-4 h-4 text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>
                    ê´€ë ¨ ì§€ì‹ ì¶”ì²œ
                </h3>
                <div id="reco-list" class="space-y-2">
                    <div class="loader mx-auto"></div>
                </div>
            </div>
          </div>
        `;
        renderRecommendations(data.title);

        // Populate TTS voices if available
        const select = document.getElementById('tts-voice-select');
        if (select && STATE.tts.voices.length) {
          select.innerHTML = STATE.tts.voices.map((v, i) => `<option value="${i}" ${v.name === (STATE.tts.voice ? STATE.tts.voice.name : '') ? 'selected' : ''}>${v.name.replace(/Microsoft |Google |Apple /g, '')}</option>`).join('');
          document.querySelector('input[oninput*="STATE.tts.rate"]').value = STATE.tts.rate;
          document.getElementById('tts-rate-val').innerText = STATE.tts.rate + 'x';
        }
      }
      else if (STATE.activeTab === 'ai') {
        const summary = performSmartSummary(data.extract || "");
        container.innerHTML = `
          <div class="space-y-4 fade-in">
            <div class="bg-gradient-to-r from-blue-600/20 to-indigo-600/20 p-4 rounded-xl border border-blue-500/20">
              <h3 class="font-bold flex items-center gap-2 mb-1 text-blue-400">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                AI ì§€ì‹ ë§µ ë¶„ì„
              </h3>
              <p class="text-xs text-slate-400">ë¬¸ì„œì˜ í•µì‹¬ ë§¥ë½ê³¼ ì—°ëŒ€í•™ì  ì •ë³´ë¥¼ ë¶„ì„í•©ë‹ˆë‹¤.</p>
            </div>
            
            <div class="space-y-2 border-b border-slate-800 pb-4">
               <h4 class="text-xs font-bold text-slate-500 uppercase">í•µì‹¬ ìš”ì•½</h4>
               ${summary.map((sent, i) => `
                <div class="flex gap-3 items-start bg-slate-800/50 p-2.5 rounded-lg border border-slate-800">
                  <p class="text-sm text-slate-300 leading-relaxed">${sent}</p>
                </div>
              `).join('')}
            </div>

            <button onclick="toggleTimeline(true)" class="w-full py-3 bg-indigo-600/20 hover:bg-indigo-600/30 text-indigo-400 rounded-xl border border-indigo-500/30 text-sm font-bold flex items-center justify-center gap-2 transition">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                ì´ ì£¼ì œì˜ íƒ€ì„ë¼ì¸ ë³´ê¸°
            </button>
          </div>
        `;
      }
      else if (STATE.activeTab === 'notes') {
        const note = STATE.notes[data.title] || "";
        container.innerHTML = `
            <div class="space-y-4 fade-in h-full flex flex-col">
                <div class="flex justify-between items-center">
                    <h3 class="font-bold text-slate-200">ê°œì¸ ì§€ì‹ ë…¸íŠ¸</h3>
                    <span class="text-[10px] text-slate-500">Auto-saved to LocalStorage</span>
                </div>
                <textarea id="node-note" class="flex-1 w-full bg-slate-800 border border-slate-700 rounded-xl p-4 text-sm text-slate-300 outline-none focus:border-blue-500 resize-none min-h-[300px]" placeholder="ì´ ì£¼ì œì— ëŒ€í•œ ìƒê°ì„ ê¸°ë¡í•˜ì„¸ìš”...">${note}</textarea>
                <div class="flex gap-2">
                    <button onclick="saveNote('${escapeHtml(data.title)}')" class="flex-1 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-bold transition">ì €ì¥í•˜ê¸°</button>
                    <button onclick="navigator.clipboard.writeText(document.getElementById('node-note').value); setStatus('ë³µì‚¬ë¨')" class="p-2 bg-slate-800 border border-slate-700 rounded-lg hover:text-white transition">ğŸ“‹</button>
                </div>
            </div>
          `;
      }
      else if (STATE.activeTab === 'cluster') {
        const cats = data.categories || [];
        container.innerHTML = `
            <div class="space-y-4 fade-in">
                <h3 class="font-bold text-slate-200">ì§€ì‹ ë¶„ë¥˜ (Categories)</h3>
                ${cats.length ? `
                    <div class="flex flex-wrap gap-2">
                        ${cats.map(c => {
          const name = c.title.replace('ë¶„ë¥˜:', '').replace('Category:', '');
          return `<span class="px-2 py-1 bg-blue-900/30 text-blue-400 border border-blue-900/50 rounded text-xs cursor-pointer hover:bg-blue-900/50" onclick="handleSearch('${escapeHtml(name)}')">${escapeHtml(name)}</span>`;
        }).join('')}
                    </div>
                ` : `<p class="text-slate-500 text-sm">ë¶„ë¥˜ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>`}
                
                <div class="mt-8 p-4 bg-slate-800/50 rounded-xl border border-dashed border-slate-700">
                    <h4 class="text-xs font-bold text-slate-400 mb-2">í´ëŸ¬ìŠ¤í„°ë§ ì •ë³´</h4>
                    <p class="text-xs text-slate-500 leading-relaxed">ìƒìœ„ ì¹´í…Œê³ ë¦¬ì— ê¸°ë°˜í•˜ì—¬ ë…¸ë“œë“¤ì´ ì„œë¡œ ëŒì–´ë‹¹ê¸°ë©° ìë™ ê·¸ë£¹í™”ë©ë‹ˆë‹¤. (ë¬¼ë¦¬ ì—”ì§„ ì ìš© ì¤‘)</p>
                </div>
            </div>
          `;
      }
      else if (STATE.activeTab === 'media') {
        // Using Generator to fetch real images
        container.innerHTML = `<div class="flex justify-center p-4"><div class="loader"></div></div>`;
        const images = await fetchGalleryImages(data.title);
        if (images.length === 0) {
          container.innerHTML = `<p class="text-center text-slate-500 mt-10">ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</p>`;
        } else {
          container.innerHTML = `
                <div class="grid grid-cols-2 gap-2 fade-in">
                    ${images.map(img => `
                        <a href="${img.url}" target="_blank" class="block aspect-square bg-slate-800 rounded-lg overflow-hidden border border-slate-700 hover:border-blue-500 transition relative group">
                            <img src="${img.thumb || img.url}" class="w-full h-full object-cover">
                            <div class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 flex items-center justify-center transition">
                                <span class="text-xs text-white">ë³´ê¸°</span>
                            </div>
                        </a>
                    `).join('')}
                </div>
             `;
        }
      }
      else if (STATE.activeTab === 'links') {
        const links = data.extlinks || [];
        container.innerHTML = links.length ? `
            <ul class="space-y-2 fade-in">
                ${links.map(l => {
          const url = l['*'];
          let domain = url;
          try { domain = new URL(url).hostname; } catch (e) { }
          return `<li class="truncate">
                        <a href="${url}" target="_blank" class="text-sm text-blue-400 hover:underline flex items-center gap-2">
                             <span class="truncate">${domain}</span>
                        </a>
                    </li>`;
        }).join('')}
            </ul>
         ` : `<p class="text-center text-slate-500 mt-10">ë§í¬ê°€ ì—†ìŠµë‹ˆë‹¤.</p>`;
      }
    }

    async function fetchGalleryImages(title) {
      // Use generator to get image URLs
      const params = new URLSearchParams({
        action: 'query', format: 'json',
        generator: 'images', titles: title,
        gimlimit: 10,
        prop: 'imageinfo', iiprop: 'url|mime',
        origin: '*'
      });
      try {
        const res = await fetch(`${CONFIG.endpoints[CONFIG.lang]}?${params.toString()}`);
        const data = await res.json();
        const pages = data.query.pages || {};
        return Object.values(pages).map(p => {
          if (p.imageinfo && p.imageinfo[0]) {
            return { url: p.imageinfo[0].url, thumb: p.imageinfo[0].url }; // simplified thumb
          }
          return null;
        }).filter(i => i && !i.url.endsWith('.svg') && !i.url.endsWith('.tif')); // Filter SVGs often used as icons
      } catch (e) { return []; }
    }

    // --- Smart Summary & TTS ---
    // --- Smart Summary & TTS ---
    async function initAIModel() {
      if (STATE.ai.model) return true;
      const status = document.getElementById('ai-model-status');
      const spinner = document.getElementById('ai-spinner');
      const panel = document.getElementById('ai-status-panel');

      panel.classList.remove('hidden');
      status.innerText = "ëª¨ë¸ ë¡œë”© ì¤‘...";
      status.className = "text-yellow-500";
      spinner.classList.remove('hidden');

      try {
        STATE.ai.model = await use.load();
        status.innerText = "ë¡œë”© ì™„ë£Œ";
        status.className = "text-green-500";
        spinner.classList.add('hidden');
        return true;
      } catch (e) {
        status.innerText = "ë¡œë”© ì‹¤íŒ¨";
        status.className = "text-red-500";
        spinner.classList.add('hidden');
        return false;
      }
    }

    async function getEmbedding(text) {
      if (!STATE.ai.model) return null;
      if (STATE.ai.embeddings[text]) return STATE.ai.embeddings[text];

      const embeddings = await STATE.ai.model.embed([text]);
      const vec = await embeddings.array();
      STATE.ai.embeddings[text] = vec[0];
      return vec[0];
    }

    function cosineSimilarity(vecA, vecB) {
      let dotProduct = 0;
      let normA = 0;
      let normB = 0;
      for (let i = 0; i < vecA.length; i++) {
        dotProduct += vecA[i] * vecB[i];
        normA += vecA[i] * vecA[i];
        normB += vecB[i] * vecB[i];
      }
      return dotProduct / (Math.sqrt(normA) * Math.sqrt(normB));
    }

    async function startSemanticCrawl() {
      const seed = document.getElementById('ai-seed-input').value.trim();
      if (!seed) { alert("ì‹œë“œ ì£¼ì œë¥¼ ì…ë ¥í•˜ì„¸ìš”."); return; }

      const ready = await initAIModel();
      if (!ready) return;

      STATE.ai.seedText = seed;
      STATE.ai.seedEmbedding = await getEmbedding(seed);
      STATE.ai.crawlActive = true;
      STATE.ai.totalFiltered = 0;

      document.getElementById('ai-start-btn').classList.add('hidden');
      document.getElementById('ai-stop-btn').classList.remove('hidden');
      document.getElementById('ai-found-count').innerText = "0";
      document.getElementById('ai-filtered-count').innerText = "0";

      setStatus(`"${seed}" ê¸°ë°˜ ì‹œë§¨í‹± íƒìƒ‰ ì‹œì‘...`);

      // Initial node
      await handleSearch(seed);

      semanticLoop();
    }

    function stopSemanticCrawl() {
      STATE.ai.crawlActive = false;
      document.getElementById('ai-start-btn').classList.remove('hidden');
      document.getElementById('ai-stop-btn').classList.add('hidden');
      setStatus("ì‹œë§¨í‹± íƒìƒ‰ ì¤‘ì§€");
    }

    async function semanticLoop() {
      if (!STATE.ai.crawlActive) return;

      const allNodes = STATE.nodes.get();
      const candidates = allNodes.filter(n => !STATE.processedNodes.has(n.id));

      if (candidates.length === 0) {
        stopSemanticCrawl();
        setStatus("ë” ì´ìƒ íƒìƒ‰í•  ìˆ˜ ìˆëŠ” ë…¸ë“œê°€ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }

      // Pick the highest priority candidate? 
      // For now, simple BFS/Randomized
      const target = candidates[Math.floor(Math.random() * candidates.length)];

      // Step expansion
      await semanticExpand(target.id);

      // Next tick
      if (STATE.ai.crawlActive) {
        setTimeout(semanticLoop, 1500); // 1.5s delay to avoid API spam & allow UI render
      }
    }

    async function semanticExpand(title) {
      if (STATE.processedNodes.has(title)) return;
      STATE.processedNodes.add(title);
      addToHistory(title);

      const params = new URLSearchParams({
        action: 'query', format: 'json', prop: 'links', titles: title,
        pllimit: 'max', plnamespace: 0, origin: '*'
      });

      try {
        const res = await fetch(`${CONFIG.endpoints[CONFIG.lang]}?${params.toString()}`);
        const data = await res.json();
        const pages = data.query.pages;
        const pid = Object.keys(pages)[0];
        const links = (pid !== "-1" && pages[pid].links) ? pages[pid].links.map(l => l.title) : [];

        if (links.length) {
          const subset = links.sort(() => 0.5 - Math.random()).slice(0, 20); // Check 20 candidates

          for (const link of subset) {
            if (!STATE.ai.crawlActive) break;

            const linkEmbedding = await getEmbedding(link);
            const score = cosineSimilarity(STATE.ai.seedEmbedding, linkEmbedding);

            if (score >= CONFIG.semanticThreshold) {
              if (!STATE.nodes.get(link)) {
                STATE.nodes.add({ id: link, label: link, value: 1 });
                document.getElementById('ai-found-count').innerText = Number(document.getElementById('ai-found-count').innerText) + 1;
              }
              if (!STATE.edges.get({ filter: e => (e.from === title && e.to === link) || (e.from === link && e.to === title) }).length) {
                STATE.edges.add({ from: title, to: link });
              }
            } else {
              STATE.ai.totalFiltered++;
              document.getElementById('ai-filtered-count').innerText = STATE.ai.totalFiltered;
              // Log filtered trace for debugging if needed
              console.log(`[Filtered] ${link} (Score: ${score.toFixed(2)})`);
            }
          }
          updateNodeSizes();
        }
      } catch (e) { console.error(e); }
    }

    function performSmartSummary(text) {
      if (!text) return ["ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤."];
      const sentences = text.match(/[^.?!]+[.?!]/g) || [text];
      if (sentences.length <= 3) return sentences;
      // Simple heuristic: Long sentences often contain more info. First sentence is intro.
      const sorted = sentences.map((s, i) => ({ t: s.trim(), s: s.length + (i === 0 ? 100 : 0), i }))
        .sort((a, b) => b.s - a.s).slice(0, 3).sort((a, b) => a.i - b.i);
      return sorted.map(x => x.t);
    }

    function speakText(text) {
      if (!window.speechSynthesis) return;
      window.speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(text);
      u.lang = CONFIG.lang === 'ko' ? 'ko-KR' : CONFIG.lang === 'en' ? 'en-US' : CONFIG.lang;
      window.speechSynthesis.speak(u);
    }

    // --- Auto Explore ---
    function toggleAutoExplore() {
      if (STATE.autoExplore.active) {
        clearInterval(STATE.autoExplore.timer);
        STATE.autoExplore.active = false;
        document.getElementById('auto-play-icon').classList.remove('hidden');
        document.getElementById('auto-pause-icon').classList.add('hidden');
        document.getElementById('auto-explore-btn').classList.remove('pulse-ring', 'text-green-400');
        setStatus("ìë™ íƒí—˜ ì¤‘ì§€");
      } else {
        STATE.autoExplore.active = true;
        document.getElementById('auto-play-icon').classList.add('hidden');
        document.getElementById('auto-pause-icon').classList.remove('hidden');
        document.getElementById('auto-explore-btn').classList.add('pulse-ring', 'text-green-400');
        setStatus("ìë™ íƒí—˜ ì‹œì‘ (3ì´ˆ ê°„ê²©)");
        autoExploreStep();
        STATE.autoExplore.timer = setInterval(autoExploreStep, 3000);
      }
    }

    function autoExploreStep() {
      if (!STATE.autoExplore.active) return;

      // Strategy: Pick a random leaf node (node with only 1 connection) or any node not processed
      const allNodes = STATE.nodes.get();
      const candidates = allNodes.filter(n => !STATE.processedNodes.has(n.id));

      if (candidates.length === 0) {
        // If all loaded nodes are processed, we need to pick a random loaded node and assume it might have *more* connections we missed?
        // Or just stop.
        // Let's stop to avoid loops if truly fully explored (unlikely).
        // Actually, expanded nodes might still have links if we limit `maxLinks`.
        // But for this demo, let's just pick one.
        if (allNodes.length > 100) { // Safety break
          toggleAutoExplore();
          setStatus("ë…¸ë“œê°€ ë„ˆë¬´ ë§ì•„ ìë™ íƒí—˜ì„ ì¢…ë£Œí•©ë‹ˆë‹¤.");
          return;
        }
        toggleAutoExplore();
        setStatus("íƒí—˜í•  í›„ë³´ ë…¸ë“œê°€ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }

      const target = candidates[Math.floor(Math.random() * candidates.length)];
      STATE.network.focus(target.id, { animation: { duration: 1000 } });
      setTimeout(() => expandNode(target.id), 1200);
    }

    // --- Workspace Logic ---
    function switchWsTab(tab) {
      STATE.wsTab = tab;
      // Update UI
      document.querySelectorAll('.ws-tab-btn').forEach((btn, idx) => {
        const targets = ['sessions', 'import', 'share'];
        if (targets[idx] === tab) btn.classList.add('active', 'bg-white/5', 'text-blue-400');
        else btn.classList.remove('active', 'bg-white/5', 'text-blue-400');
      });

      const content = document.getElementById('ws-content');
      if (tab === 'sessions') {
        content.innerHTML = `
                <div class="space-y-4">
                    <div class="flex gap-2">
                        <input id="session-name" class="flex-1 bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 outline-none focus:border-blue-500" placeholder="ì„¸ì…˜ ì´ë¦„ (ì˜ˆ: AI ì—°êµ¬ #1)">
                        <button onclick="saveSession()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-bold">ì €ì¥</button>
                    </div>
                    <div class="border-t border-slate-800 pt-4">
                        <h4 class="font-bold mb-3 text-slate-400 text-sm">ì €ì¥ëœ ì„¸ì…˜ ëª©ë¡</h4>
                        <div id="session-list" class="space-y-2"></div>
                    </div>
                </div>
            `;
        renderSessions();
      } else if (tab === 'import') {
        content.innerHTML = `
                <div class="space-y-6">
                    <div>
                        <h4 class="font-bold mb-2 text-blue-400">ë‚´ë³´ë‚´ê¸° (Export)</h4>
                        <button onclick="exportJSON()" class="w-full bg-slate-800 hover:bg-slate-700 border border-slate-700 text-slate-300 py-3 rounded-xl flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
                            JSON íŒŒì¼ë¡œ ë‹¤ìš´ë¡œë“œ
                        </button>
                    </div>
                    <div>
                        <h4 class="font-bold mb-2 text-green-400">ê°€ì ¸ì˜¤ê¸° (Import)</h4>
                        <div class="relative">
                            <input type="file" id="import-file" accept=".json" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="importJSON(this)">
                            <div class="w-full bg-slate-800 border border-dashed border-slate-600 hover:border-slate-400 text-slate-400 py-6 rounded-xl flex flex-col items-center justify-center transition">
                                <svg class="w-8 h-8 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/></svg>
                                <span>JSON íŒŒì¼ì„ ì´ê³³ì— ë“œë¡­í•˜ê±°ë‚˜ í´ë¦­í•˜ì„¸ìš”</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
      } else if (tab === 'share') {
        // Generate link
        const data = { nodes: STATE.nodes.get(), edges: STATE.edges.get() };
        const json = JSON.stringify(data);
        const b64 = btoa(unescape(encodeURIComponent(json)));
        const url = `${location.origin}${location.pathname}#g=${b64}`;

        content.innerHTML = `
                <div class="space-y-4">
                    <div class="bg-slate-800 p-4 rounded-xl border border-slate-700">
                        <label class="block text-xs text-slate-500 uppercase font-bold mb-2">ê³µìœ  ë§í¬ (URL Hash)</label>
                        <textarea readonly class="w-full h-24 bg-slate-900 border border-slate-700 rounded-lg p-2 text-xs text-slate-400 break-all resize-none outline-none focus:border-blue-500">${url}</textarea>
                    </div>
                    <button onclick="navigator.clipboard.writeText('${url}'); setStatus('ë§í¬ ë³µì‚¬ ì™„ë£Œ')" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-xl font-bold">
                        ë§í¬ ë³µì‚¬í•˜ê¸°
                    </button>
                    <p class="text-xs text-slate-500 text-center">ì£¼ì˜: ê·¸ë˜í”„ê°€ ë„ˆë¬´ í¬ë©´ URL ê¸¸ì´ ì œí•œìœ¼ë¡œ ì˜ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>ê·¸ëŸ´ ë• 'ë‚´ë³´ë‚´ê¸°'ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.</p>
                </div>
            `;
      }
    }

    function renderSessions() {
      const list = document.getElementById('session-list');
      if (!STATE.sessions.length) {
        list.innerHTML = `<p class="text-slate-500 text-sm text-center py-4">ì €ì¥ëœ ì„¸ì…˜ì´ ì—†ìŠµë‹ˆë‹¤.</p>`;
        return;
      }
      list.innerHTML = STATE.sessions.map((s, i) => `
            <div class="flex items-center justify-between bg-slate-800 p-3 rounded-lg border border-slate-700">
                <div>
                    <div class="font-bold text-slate-200 text-sm">${escapeHtml(s.name)}</div>
                    <div class="text-xs text-slate-500">${new Date(s.date).toLocaleString()} Â· Node ${s.data.nodes.length}</div>
                </div>
                <div class="flex gap-2">
                    <button onclick="loadSession(${i})" class="text-blue-400 hover:text-blue-300 text-xs px-2 py-1 bg-blue-900/30 rounded border border-blue-900/50">ë¶ˆëŸ¬ì˜¤ê¸°</button>
                    <button onclick="deleteSession(${i})" class="text-red-400 hover:text-red-300 text-xs px-2 py-1 bg-red-900/30 rounded border border-red-900/50">ì‚­ì œ</button>
                </div>
            </div>
        `).join('');
    }

    function saveSession(forcedName) {
      const nameInput = document.getElementById('session-name');
      const name = forcedName || (nameInput ? nameInput.value.trim() : "") || `Session ${new Date().toLocaleTimeString()}`;
      const data = { nodes: STATE.nodes.get(), edges: STATE.edges.get() };
      STATE.sessions.push({ name, date: new Date().toISOString(), data });
      localStorage.setItem('wg_sessions', JSON.stringify(STATE.sessions));
      if (nameInput) {
        nameInput.value = '';
        renderSessions();
      }
      setStatus("ì„¸ì…˜ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
    }

    function loadSession(idx) {
      const s = STATE.sessions[idx];
      if (!s) return;
      STATE.nodes.clear(); STATE.edges.clear(); STATE.processedNodes.clear();
      STATE.nodes.add(s.data.nodes);
      STATE.edges.add(s.data.edges);
      // Re-populate processed nodes roughly
      s.data.nodes.forEach(n => STATE.processedNodes.add(n.id));
      setStatus(`ì„¸ì…˜ "${s.name}" ë¶ˆëŸ¬ì˜´`);
      toggleModal('workspace-modal');
    }

    function deleteSession(idx) {
      STATE.sessions.splice(idx, 1);
      localStorage.setItem('wg_sessions', JSON.stringify(STATE.sessions));
      renderSessions();
    }

    function exportJSON() {
      const data = { nodes: STATE.nodes.get(), edges: STATE.edges.get() };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = `wikigraph_${Date.now()}.json`; a.click();
    }

    function importJSON(input) {
      const file = input.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const json = JSON.parse(e.target.result);
          if (json.nodes && json.edges) {
            STATE.nodes.clear(); STATE.edges.clear(); STATE.processedNodes.clear();
            STATE.nodes.add(json.nodes);
            STATE.edges.add(json.edges);
            json.nodes.forEach(n => STATE.processedNodes.add(n.id));
            setStatus("íŒŒì¼ ê°€ì ¸ì˜¤ê¸° ì„±ê³µ");
            toggleModal('workspace-modal');
          } else { throw new Error("Invalid Format"); }
        } catch (err) { alert("JSON í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤."); }
      };
      reader.readAsText(file);
    }

    function restoreFromHash() {
      try {
        const b64 = location.hash.substring(3);
        const json = decodeURIComponent(escape(atob(b64)));
        const data = JSON.parse(json);
        STATE.nodes.add(data.nodes);
        STATE.edges.add(data.edges);
        data.nodes.forEach(n => STATE.processedNodes.add(n.id));
        setStatus("ê³µìœ  ë§í¬ì—ì„œ ë³µì›ë¨");
      } catch (e) { console.error(e); setStatus("ë³µì› ì‹¤íŒ¨: ìœ íš¨í•˜ì§€ ì•Šì€ ë§í¬"); }
    }

    // --- Command Palette ---
    function openPalette() {
      const modal = document.getElementById('palette-modal');
      const input = document.getElementById('palette-input');
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      input.value = '';
      input.focus();
      updatePalette();
      STATE.palette.open = true;
    }

    function closePalette() {
      const modal = document.getElementById('palette-modal');
      modal.classList.add('hidden');
      modal.classList.remove('flex');
      STATE.palette.open = false;
    }

    function updatePalette() {
      const query = document.getElementById('palette-input').value.toLowerCase();
      const list = document.getElementById('palette-list');
      const items = [];

      // Actions
      const actions = [
        { t: 'Reset Graph', f: () => resetApp() },
        { t: 'Toggle Minimap', f: () => { const cb = document.getElementById('minimap-toggle'); cb.checked = !cb.checked; toggleMinimap(cb.checked); } },
        { t: 'Toggle Physics', f: () => { const cb = document.getElementById('physics-toggle'); cb.checked = !cb.checked; togglePhysics(cb.checked); } },
        { t: 'Open Workspace', f: () => toggleModal('workspace-modal') },
        { t: 'Start Auto Explore', f: () => toggleAutoExplore() }
      ];

      // Filter Actions
      actions.forEach(a => {
        if (a.t.toLowerCase().includes(query)) items.push({ type: 'Action', label: a.t, action: a.f });
      });

      // Filter Nodes
      const nodes = STATE.nodes.get();
      nodes.forEach(n => {
        if (n.id.toLowerCase().includes(query)) {
          items.push({ type: 'Node', label: `Focus: ${n.id}`, action: () => { STATE.network.focus(n.id, { animation: true }); fetchNodeDetails(n.id); } });
        }
      });

      // Add Search Command
      if (query.length > 0) {
        items.unshift({ type: 'Search', label: `Search Wiki: "${query}"`, action: () => handleSearch(query) });
      }

      STATE.palette.items = items;
      STATE.palette.index = 0;
      renderPaletteItems();
    }

    function renderPaletteItems() {
      const list = document.getElementById('palette-list');
      list.innerHTML = STATE.palette.items.map((item, i) => `
            <div class="flex items-center justify-between p-3 rounded-lg cursor-pointer ${i === STATE.palette.index ? 'bg-blue-600 text-white' : 'text-slate-300 hover:bg-slate-800'}" onclick="execPalette(${i})">
                <span class="font-medium">${item.label}</span>
                <span class="text-xs opacity-50 uppercase tracking-wider border border-current px-1 rounded">${item.type}</span>
            </div>
        `).join('');
    }

    function execPalette(index) {
      const item = STATE.palette.items[index];
      if (item) {
        item.action();
        closePalette();
      }
    }

    document.getElementById('palette-input').addEventListener('input', updatePalette);
    document.getElementById('palette-input').addEventListener('keydown', (e) => {
      if (e.key === 'ArrowDown') { e.preventDefault(); STATE.palette.index = (STATE.palette.index + 1) % STATE.palette.items.length; renderPaletteItems(); }
      else if (e.key === 'ArrowUp') { e.preventDefault(); STATE.palette.index = (STATE.palette.index - 1 + STATE.palette.items.length) % STATE.palette.items.length; renderPaletteItems(); }
      else if (e.key === 'Enter') { e.preventDefault(); execPalette(STATE.palette.index); }
    });


    // --- General Events ---
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closePalette();
        hideContextMenu();
        document.getElementById('autocomplete-list').classList.add('hidden');
        toggleModal(null);
        if (document.body.classList.contains('global-view-active')) toggleGlobalView(false);
        if (STATE.ai.crawlActive) stopSemanticCrawl();
      }
      // Ctrl+K
      if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
        e.preventDefault();
        STATE.palette.open ? closePalette() : openPalette();
      }
      // Slash for search
      if (e.key === '/' && !STATE.palette.open && document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') {
        e.preventDefault();
        document.getElementById('search-input').focus();
      }
    });

    document.getElementById('search-btn').addEventListener('click', () => handleSearch());
    document.getElementById('search-input').addEventListener('keypress', (e) => { if (e.key === 'Enter') handleSearch(); });

    // Autocomplete
    let debounce;
    document.getElementById('search-input').addEventListener('input', (e) => {
      clearTimeout(debounce);
      const val = e.target.value.trim();
      if (!val) { document.getElementById('autocomplete-list').classList.add('hidden'); return; }
      debounce = setTimeout(async () => {
        try {
          const res = await fetch(`${CONFIG.endpoints[CONFIG.lang]}?action=opensearch&search=${encodeURIComponent(val)}&limit=5&format=json&origin=*`);
          const data = await res.json();
          const list = data[1];
          const container = document.getElementById('autocomplete-list');
          if (list.length) {
            container.classList.remove('hidden');
            container.innerHTML = list.map(t => `
                        <div class="px-4 py-2 hover:bg-slate-800 text-slate-300 cursor-pointer" onclick="handleSearch('${escapeHtml(t)}')">${escapeHtml(t)}</div>
                    `).join('');
          } else container.classList.add('hidden');
        } catch (e) { }
      }, 300);
    });

    // Helpers
    function handleSearch(term, override = false) {
      if (STATE.race.active && !override) {
        setStatus("ë ˆì´ìŠ¤ ì¤‘ì—ëŠ” ê²€ìƒ‰ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", false);
        return;
      }
      const val = term || document.getElementById('search-input').value.trim();
      if (!val) return;
      document.getElementById('autocomplete-list').classList.add('hidden');
      document.getElementById('search-input').value = val;

      if (STATE.nodes.get(val)) {
        STATE.network.selectNodes([val]);
        STATE.network.focus(val, { animation: true, scale: 1.2 });
        fetchNodeDetails(val);
      } else {
        expandNode(val);
      }
    }

    function setStatus(msg, loading) {
      const el = document.getElementById('status-msg');
      if (!msg) { el.classList.add('hidden'); return; }
      el.classList.remove('hidden');
      document.getElementById('status-text').textContent = msg;
      el.querySelector('.loader').style.display = loading ? 'block' : 'none';
      if (!loading) setTimeout(() => el.classList.add('hidden'), 3000);
    }

    function toggleModal(id) {
      document.querySelectorAll('[id$="-modal"]').forEach(m => {
        if (m.id !== id) { m.classList.add('hidden'); m.classList.remove('flex'); }
      });
      if (id) {
        const m = document.getElementById(id);
        if (m.classList.contains('hidden')) { m.classList.remove('hidden'); m.classList.add('flex'); }
        else { m.classList.add('hidden'); m.classList.remove('flex'); }

        // If opening workspace, render current tab
        if (id === 'workspace-modal') switchWsTab(STATE.wsTab);
        if (id === 'race-setup-modal') {
          if (!document.getElementById('race-input-start').value) setRandomRaceStart();
          if (!document.getElementById('race-input-target').value) setRandomRaceTarget();
        }
      }
    }

    function escapeHtml(text) {
      if (!text) return "";
      return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
    }

    // Context Actions
    let pathStartNode = null;
    function hideContextMenu() { document.getElementById('context-menu').style.display = 'none'; STATE.contextMenuNode = null; }
    function showContextMenu(x, y, id) {
      const menu = document.getElementById('context-menu');
      document.getElementById('ctx-title').innerText = id;
      document.getElementById('ctx-pin-text').innerText = STATE.nodes.get(id).physics === false ? "ê³ ì • í•´ì œ" : "ê³ ì •";

      // Dynamic menu item for pathfinding
      const existingPathBtn = document.getElementById('ctx-path-btn');
      if (existingPathBtn) existingPathBtn.remove();

      const pathBtn = document.createElement('button');
      pathBtn.id = 'ctx-path-btn';
      pathBtn.className = 'w-full text-left px-4 py-2 hover:bg-green-600/20 hover:text-green-400 flex items-center gap-2';
      if (!pathStartNode) {
        pathBtn.innerHTML = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path></svg> ê²½ë¡œ íƒìƒ‰ ì‹œì‘`;
        pathBtn.onclick = () => { pathStartNode = id; setStatus(`"${id}" ë¥¼ ì‹œì‘ì ìœ¼ë¡œ ì„¤ì •`); hideContextMenu(); };
      } else {
        pathBtn.innerHTML = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"></path></svg> ê²½ë¡œ íƒìƒ‰ ì¢…ë£Œ`;
        pathBtn.onclick = () => { findPath(pathStartNode, id); pathStartNode = null; hideContextMenu(); };
      }
      menu.appendChild(pathBtn);

      const rect = document.getElementById('network').getBoundingClientRect();
      menu.style.left = (rect.left + x) + 'px';
      menu.style.top = (rect.top + y) + 'px';
      menu.style.display = 'block';
    }

    function findPath(start, end) {
      if (start === end) return;
      setStatus(`${start} -> ${end} ê²½ë¡œ ê³„ì‚° ì¤‘...`, true);

      // BFS for shortest path
      const queue = [[start]];
      const visited = new Set([start]);
      let path = null;

      while (queue.length > 0) {
        const currentPath = queue.shift();
        const node = currentPath[currentPath.length - 1];

        if (node === end) {
          path = currentPath;
          break;
        }

        const neighbors = STATE.network.getConnectedNodes(node);
        for (const neighbor of neighbors) {
          if (!visited.has(neighbor)) {
            visited.add(neighbor);
            queue.push([...currentPath, neighbor]);
          }
        }
      }

      if (path) {
        highlightPath(path);
        setStatus(`ê²½ë¡œ ë°œê²¬! (${path.length - 1}ë‹¨ê³„)`);
      } else {
        setStatus("ê²½ë¡œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
      }
    }

    function highlightPath(path) {
      const edgeUpdates = [];
      const nodeUpdates = [];

      // Reset all first (dim them)
      STATE.edges.forEach(e => edgeUpdates.push({ id: e.id, color: { opacity: 0.1 }, width: 1 }));
      STATE.nodes.forEach(n => nodeUpdates.push({ id: n.id, opacity: 0.2 }));

      // Highlight path
      for (let i = 0; i < path.length; i++) {
        nodeUpdates.push({ id: path[i], opacity: 1, color: { border: COLORS.edge.path } });
        if (i < path.length - 1) {
          const u = path[i];
          const v = path[i + 1];
          const edgeId = STATE.edges.get({ filter: e => (e.from === u && e.to === v) || (e.from === v && e.to === u) })[0].id;
          edgeUpdates.push({ id: edgeId, color: { color: COLORS.edge.path, opacity: 1 }, width: 5 });
        }
      }

      STATE.edges.update(edgeUpdates);
      STATE.nodes.update(nodeUpdates);

      // Reset after 5 seconds
      setTimeout(() => {
        const resetEdges = [];
        const resetNodes = [];
        STATE.edges.forEach(e => resetEdges.push({ id: e.id, color: { color: COLORS.edge.color, opacity: 0.6 }, width: 1 }));
        STATE.nodes.forEach(n => resetNodes.push({ id: n.id, opacity: 1 }));
        STATE.edges.update(resetEdges);
        STATE.nodes.update(resetNodes);
        updateNodeSizes(); // Restore colors
      }, 5000);
    }

    function ctxAction(type) {
      const id = STATE.contextMenuNode;
      if (!id) return;
      if (type === 'expand') expandNode(id);
      if (type === 'focus') { STATE.network.focus(id, { animation: true, scale: 1.2 }); fetchNodeDetails(id); }
      if (type === 'open') window.open(`https://${CONFIG.lang}.wikipedia.org/wiki/${encodeURIComponent(id)}`);
      if (type === 'pin') {
        const n = STATE.nodes.get(id);
        const isPinned = n.physics === false;
        STATE.nodes.update({ id, physics: isPinned, color: isPinned ? undefined : { background: '#1e293b', border: '#fbbf24' } });
      }
      if (type === 'bookmark') toggleBookmark(id);
      if (type === 'delete') { STATE.nodes.remove(id); STATE.processedNodes.delete(id); }
      hideContextMenu();
    }

    // Stats
    function updateStats() {
      if (!STATE.nodes) return;
      document.getElementById('stat-nodes').textContent = STATE.nodes.length;
      document.getElementById('stat-edges').textContent = STATE.edges.length;
      document.getElementById('stat-pins').textContent = STATE.nodes.get({ filter: n => n.physics === false }).length;

      const sel = STATE.selectedNode;
      document.getElementById('stat-selected').textContent = sel ? (sel.length > 10 ? sel.slice(0, 10) + '...' : sel) : '-';
      if (sel) {
        document.getElementById('stat-degree').textContent = STATE.network.getConnectedNodes(sel).length;
      }
    }

    // Bookmarks & History
    function toggleBookmark(t) {
      if (STATE.bookmarks.includes(t)) STATE.bookmarks = STATE.bookmarks.filter(x => x !== t);
      else STATE.bookmarks.push(t);
      localStorage.setItem('wg_bookmarks', JSON.stringify(STATE.bookmarks));
      renderBookmarks();
      if (STATE.selectedNode === t) renderSidebarContent();
    }
    function renderBookmarks() {
      const list = document.getElementById('bookmark-list');
      const badge = document.getElementById('bookmark-badge');
      if (STATE.bookmarks.length) {
        badge.classList.remove('hidden');
        list.innerHTML = STATE.bookmarks.map(b => `
                <div class="flex items-center justify-between p-2 hover:bg-slate-800 rounded border border-transparent hover:border-slate-700">
                    <span class="cursor-pointer" onclick="handleSearch('${escapeHtml(b)}'); toggleModal('bookmarks-modal')">${escapeHtml(b)}</span>
                    <button onclick="toggleBookmark('${escapeHtml(b)}')" class="text-red-400 hover:text-red-300">Ã—</button>
                </div>
            `).join('');
      } else {
        badge.classList.add('hidden');
        list.innerHTML = `<p class="text-center text-slate-500 mt-10">ë¶ë§ˆí¬ ì—†ìŒ</p>`;
      }
    }
    function addToHistory(t) {
      STATE.history = STATE.history.filter(x => x !== t);
      STATE.history.unshift(t);
      if (STATE.history.length > 20) STATE.history.pop();
      localStorage.setItem('wg_history', JSON.stringify(STATE.history));
      renderHistory();
    }
    function renderHistory() {
      const div = document.getElementById('recent-tags');
      if (!STATE.history.length) div.innerHTML = `<span class="text-xs text-slate-600">ê¸°ë¡ ì—†ìŒ</span>`;
      else div.innerHTML = STATE.history.map(t => `
            <button onclick="handleSearch('${escapeHtml(t)}')" class="px-2 py-1 bg-slate-800 border border-slate-700 rounded text-xs text-slate-400 hover:text-blue-400 hover:border-blue-500/50 transition">${escapeHtml(t)}</button>
        `).join('');
    }
    function clearHistory() { STATE.history = []; localStorage.setItem('wg_history', '[]'); renderHistory(); }

    // Misc Exports
    window.toggleSidebar = (f) => { const s = document.getElementById('sidebar'); if (f) s.classList.remove('-translate-x-full'); else s.classList.toggle('-translate-x-full'); };
    window.resetApp = () => { STATE.nodes.clear(); STATE.edges.clear(); STATE.processedNodes.clear(); handleSearch('ì¸ê³µì§€ëŠ¥'); };
    window.clearGraph = () => { STATE.nodes.clear(); STATE.edges.clear(); STATE.processedNodes.clear(); };
    window.zoomIn = () => STATE.network.moveTo({ scale: STATE.network.getScale() + 0.3, animation: true });
    window.zoomOut = () => STATE.network.moveTo({ scale: STATE.network.getScale() - 0.3, animation: true });
    window.fitGraph = () => STATE.network.fit({ animation: true });
    window.changeLayout = (t) => {
      if (t === 'circular') { STATE.network.setOptions({ physics: { enabled: false } }); STATE.network.layoutCircle(); }
      else STATE.network.setOptions({ physics: { enabled: true, solver: 'forceAtlas2Based' } });
    };
    window.toggleMinimap = (chk) => { document.getElementById('minimap-container').style.display = chk ? 'block' : 'none'; if (chk) syncMinimap(); };
    window.togglePhysics = (chk) => STATE.network.setOptions({ physics: { enabled: chk } });
    window.downloadImage = () => {
      const c = document.querySelector('#network canvas');
      const a = document.createElement('a'); a.download = `wiki-graph-${Date.now()}.png`; a.href = c.toDataURL(); a.click();
    };
    // --- TTS & Race ê³ ë„í™” ê¸°ëŠ¥ ---
    function initTTS() {
      if (!window.speechSynthesis) return;

      const loadVoices = () => {
        const v = window.speechSynthesis.getVoices();
        if (!v.length) return;

        STATE.tts.voices = v.filter(voice => voice.lang.startsWith(CONFIG.lang));

        // í•„í„°ë§ëœ í•œêµ­ì–´ ìŒì„± ì¤‘ ê°€ì¥ í’ˆì§ˆì´ ì¢‹ì€ ê²ƒ ì„ íƒ (Natural, Google, Apple ìˆœ)
        STATE.tts.voice = STATE.tts.voices.find(v => v.name.includes('Natural')) ||
          STATE.tts.voices.find(v => v.name.includes('Google')) ||
          STATE.tts.voices[0];

        const select = document.getElementById('tts-voice-select');
        if (select) {
          select.innerHTML = STATE.tts.voices.map((v, i) => `<option value="${i}" ${v === STATE.tts.voice ? 'selected' : ''}>${v.name.replace(/Microsoft |Google |Apple /g, '')}</option>`).join('');
        }
      };

      window.speechSynthesis.onvoiceschanged = loadVoices;
      loadVoices();
    }

    function speakTextWithHighlight(originalText) {
      if (!window.speechSynthesis) return;
      window.speechSynthesis.cancel();

      const container = document.getElementById('intro-text-container');
      if (!container) return;

      // ë¬¸ì¥ ë‹¨ìœ„ë¡œ ë¶„í• í•˜ì—¬ í•˜ì´ë¼ì´íŠ¸ ì¤€ë¹„
      const sentences = originalText.match(/[^.?!]+[.?!]/g) || [originalText];
      container.innerHTML = sentences.map(s => `<span class="tts-sentence">${s}</span>`).join('');
      const sentenceNodes = container.querySelectorAll('.tts-sentence');

      const u = new SpeechSynthesisUtterance(originalText);
      u.voice = STATE.tts.voice;
      u.rate = STATE.tts.rate;
      u.lang = CONFIG.lang === 'ko' ? 'ko-KR' : CONFIG.lang === 'en' ? 'en-US' : CONFIG.lang;

      let lastIndex = 0;
      u.onboundary = (event) => {
        if (event.name !== 'sentence') return;

        // í˜„ì¬ ì½ê³  ìˆëŠ” ë¬¸ì¥ ì°¾ì•„ì„œ í•˜ì´ë¼ì´íŠ¸
        const charIndex = event.charIndex;
        let currentTextLen = 0;
        sentenceNodes.forEach((node, i) => {
          const len = node.textContent.length;
          if (charIndex >= currentTextLen && charIndex < currentTextLen + len) {
            sentenceNodes.forEach(n => n.classList.remove('tts-highlight'));
            node.classList.add('tts-highlight');
            node.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }
          currentTextLen += len;
        });
      };

      u.onend = () => {
        sentenceNodes.forEach(n => n.classList.remove('tts-highlight'));
      };

      window.speechSynthesis.speak(u);
    }

    async function setRandomRaceStart() {
      const popular = CONFIG.lang === 'ko' ? ['ì‚¬ê³¼', 'ì¶•êµ¬', 'ë¹„ë¹”ë°¥', 'ì„œìš¸', 'ë°©íƒ„ì†Œë…„ë‹¨'] : ['Apple', 'Soccer', 'Bibimbap', 'Seoul', 'BTS'];
      const target = popular[Math.floor(Math.random() * popular.length)];
      document.getElementById('race-input-start').value = target;
    }

    async function setRandomRaceTarget() {
      const popular = CONFIG.lang === 'ko' ? ['ì¸ê³µì§€ëŠ¥', 'ì¡°ì„ ì™•ì¡°ì‹¤ë¡', 'ë¸”ë™í™€', 'íƒœì–‘ê³„', 'ì•Œë² ë¥´íŠ¸ ì•„ì¸ìŠˆíƒ€ì¸'] : ['Artificial intelligence', 'Joseon Dynasty', 'Black hole', 'Solar System', 'Albert Einstein'];
      const target = popular[Math.floor(Math.random() * popular.length)];
      document.getElementById('race-input-target').value = target;
    }

    async function startRaceFromSetup() {
      const start = document.getElementById('race-input-start').value.trim();
      const target = document.getElementById('race-input-target').value.trim();

      if (!start || !target) { alert("ì‹œì‘ ì§€ì ê³¼ ëª©í‘œë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }
      if (start === target) { alert("ì‹œì‘ ì§€ì ê³¼ ëª©í‘œê°€ ê°™ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return; }

      // 1. Save Session Automatically
      saveSession(`Race_Backup_${new Date().toLocaleTimeString()}`);

      toggleModal('race-setup-modal');

      // 2. Reset Graph for the Race
      clearGraph();

      STATE.race = {
        active: true,
        target,
        startTime: Date.now(),
        clicks: 0,
        timer: setInterval(updateRaceTimer, 1000),
        path: [start]
      };

      // 3. Start Search for 'start' node (with override)
      await handleSearch(start, true);

      // 4. Disable Search UI
      document.getElementById('search-input').disabled = true;
      document.getElementById('search-input').placeholder = "ë ˆì´ìŠ¤ ì§„í–‰ ì¤‘ (ê²€ìƒ‰ ë¶ˆê°€)";
      document.getElementById('search-input').classList.add('opacity-50', 'cursor-not-allowed');

      const widget = document.getElementById('race-widget');
      widget.style.display = 'block';
      document.getElementById('race-target').innerText = target;
      document.getElementById('race-clicks').innerText = '0';
      setStatus(`ë ˆì´ìŠ¤ ì‹œì‘! "${target}" ì£¼ì œë¥¼ í´ë¦­ìœ¼ë¡œ ì°¾ìœ¼ì„¸ìš”.`);
    }

    function renderRaceResult() {
      document.getElementById('result-clicks').innerText = STATE.race.clicks;
      document.getElementById('result-time').innerText = document.getElementById('race-timer').innerText;

      const pathList = document.getElementById('result-path');
      pathList.innerHTML = STATE.race.path.map((node, i) => `
            <div class="race-log-item ${i === STATE.race.path.length - 1 ? 'current' : ''}">
                <div class="text-[10px] text-slate-500 font-bold uppercase">Step ${i}</div>
                <div class="text-sm font-bold text-slate-200">${escapeHtml(node)}</div>
            </div>
        `).join('');

      toggleModal('race-result-modal');
    }

    function toggleGlobalView(active) {
      if (active) {
        document.body.classList.add('global-view-active');
        setStatus("ëª°ì… ëª¨ë“œ í™œì„±í™” (ESCë¡œ ì¢…ë£Œ)", false);
        // Fit the network to show everything
        setTimeout(() => {
          STATE.network.fit({ animation: { duration: 1000, easingFunction: 'easeInOutQuad' } });
        }, 300);
      } else {
        document.body.classList.remove('global-view-active');
        setStatus(null);
      }
    }

    function toggleRaceMode(chk) {
      if (!chk && STATE.race.active) {
        document.getElementById('race-widget').style.display = 'none';
        STATE.race.active = false;
        clearInterval(STATE.race.timer);
        return;
      }
      toggleModal('race-setup-modal');
    }

    function updateRaceTimer() {
      const diff = Math.floor((Date.now() - STATE.race.startTime) / 1000);
      const m = Math.floor(diff / 60).toString().padStart(2, '0');
      const s = (diff % 60).toString().padStart(2, '0');
      document.getElementById('race-timer').innerText = `${m}:${s}`;
    }

    function endRace(success) {
      if (!STATE.race.active) return;
      clearInterval(STATE.race.timer);
      STATE.race.active = false;

      // Re-enable Search UI
      document.getElementById('search-input').disabled = false;
      document.getElementById('search-input').placeholder = "ì§€ì‹ì˜ ì—°ê²°ê³ ë¦¬ë¥¼ ê²€ìƒ‰í•˜ì„¸ìš”...";
      document.getElementById('search-input').classList.remove('opacity-50', 'cursor-not-allowed');

      if (success) {
        renderRaceResult();
      }
      document.getElementById('race-widget').style.display = 'none';
      setStatus(success ? "ë ˆì´ìŠ¤ ì„±ê³µ!" : "ë ˆì´ìŠ¤ ì¢…ë£Œ");
    }


    // --- New Feature Implementation ---
    function saveNote(title) {
      const text = document.getElementById('node-note').value;
      STATE.notes[title] = text;
      localStorage.setItem('wg_notes', JSON.stringify(STATE.notes));
      setStatus("ë…¸ë“œê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
    }

    async function renderRecommendations(title) {
      const list = document.getElementById('reco-list');
      const connected = STATE.network.getConnectedNodes(title);
      // Strategy: Recommend nodes that have highest degree but are not fully processed
      const candidates = connected.map(id => {
        const deg = STATE.network.getConnectedNodes(id).length;
        return { id, deg, processed: STATE.processedNodes.has(id) };
      }).sort((a, b) => b.deg - a.deg).slice(0, 3);

      list.innerHTML = candidates.map(c => `
            <div class="reco-card flex justify-between items-center" onclick="handleSearch('${escapeHtml(c.id)}')">
                <div class="flex flex-col">
                    <span class="text-sm font-bold text-slate-200">${escapeHtml(c.id)}</span>
                    <span class="text-[10px] text-slate-500">${c.deg}ê°œì˜ ì—°ê²°ë¨</span>
                </div>
                ${c.processed ? '<span class="text-[10px] text-green-500">íƒìƒ‰ë¨</span>' : '<span class="text-[10px] text-blue-500">ìƒˆ ì£¼ì œ</span>'}
            </div>
        `).join('');
    }

    function toggleTimeline(chk) {
      const container = document.getElementById('timeline-container');
      if (!chk) { container.style.display = 'none'; return; }

      container.style.display = 'block';
      const track = document.getElementById('timeline-track');
      track.innerHTML = '<div class="loader mx-auto"></div>';

      // Extract years from loaded nodes
      const nodes = STATE.nodes.get();
      const yearRegex = /\b(1[0-9]{3}|20[0-2][0-9])\b/g;
      const items = [];

      nodes.forEach(n => {
        const matches = n.id.match(yearRegex);
        if (matches) {
          matches.forEach(y => items.push({ year: parseInt(y), label: n.id }));
        }
      });

      if (!items.length) {
        track.innerHTML = '<p class="text-slate-500 text-xs w-full text-center">ì—°ë„ ì •ë³´ê°€ í¬í•¨ëœ ë…¸ë“œê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
        return;
      }

      const sorted = items.sort((a, b) => a.year - b.year);
      track.innerHTML = sorted.map(it => `
            <div class="timeline-item" onclick="STATE.network.focus('${escapeHtml(it.label)}', {animation:true}); fetchNodeDetails('${escapeHtml(it.label)}')">
                <span class="timeline-year">${it.year}</span>
                <div class="timeline-dot"></div>
                <span class="timeline-label">${escapeHtml(it.label)}</span>
            </div>
        `).join('');
    }

    function exportKnowledgeReport() {
      const nodes = STATE.nodes.get();
      let md = `# WikiGraph ì§€ì‹ ì—°êµ¬ ë¦¬í¬íŠ¸\n\nGenerated on: ${new Date().toLocaleString()}\n\n`;
      md += `## ì´ íƒìƒ‰ ë…¸ë“œ: ${nodes.length}ê°œ\n\n---\n\n`;

      nodes.forEach(n => {
        md += `### ${n.id}\n`;
        if (STATE.notes[n.id]) md += `> **ê°œì¸ ë©”ëª¨:** ${STATE.notes[n.id]}\n\n`;
        md += `ì—°ê²°ëœ ë¬¸ì„œ: ${STATE.network.getConnectedNodes(n.id).join(', ')}\n\n`;
      });

      const blob = new Blob([md], { type: 'text/markdown' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.download = `WikiReport_${Date.now()}.md`; a.click();
      setStatus("ë¦¬í¬íŠ¸ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.");
    }

    window.updateSetting = (k, v) => {
      CONFIG[k] = v;
      if (k === 'maxLinks') document.getElementById('limit-val').innerText = v;
      if (k === 'springLength') {
        document.getElementById('dist-val').innerText = v;
        STATE.network.setOptions({ physics: { forceAtlas2Based: { springLength: Number(v) } } });
      }
      localStorage.setItem('wg_settings', JSON.stringify({ maxLinks: CONFIG.maxLinks, springLength: CONFIG.springLength }));
    };
  </script>
</body>

</html>